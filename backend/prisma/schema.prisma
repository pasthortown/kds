// KDS Database Schema
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USUARIOS Y AUTENTICACIÓN
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(OPERATOR)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[]
}

enum UserRole {
  ADMIN
  OPERATOR
  VIEWER
}

// ============================================
// COLAS Y CANALES
// ============================================

model Queue {
  id           String           @id @default(cuid())
  name         String           @unique
  description  String?
  distribution DistributionType @default(DISTRIBUTED)
  active       Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  channels QueueChannel[]
  filters  QueueFilter[]
  screens  Screen[]
}

enum DistributionType {
  DISTRIBUTED // D - Balanceado entre pantallas
  SINGLE      // S - Una sola pantalla
}

model QueueChannel {
  id        String   @id @default(cuid())
  queueId   String
  channel   String
  color     String   @default("#4a90e2")
  priority  Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  queue Queue @relation(fields: [queueId], references: [id], onDelete: Cascade)

  @@unique([queueId, channel])
}

model QueueFilter {
  id        String  @id @default(cuid())
  queueId   String
  pattern   String // Patrón de filtro (ej: "sanduche", "twister")
  suppress  Boolean @default(false) // Si true, oculta productos que coinciden
  active    Boolean @default(true)

  queue Queue @relation(fields: [queueId], references: [id], onDelete: Cascade)

  @@unique([queueId, pattern])
}

// ============================================
// CANALES GLOBALES
// ============================================

model Channel {
  id              String   @id @default(cuid())
  name            String   @unique // Nombre del canal (ej: "Local", "PedidosYa", "RAPPI")
  displayName     String?  // Nombre para mostrar (opcional, si es diferente del name)
  backgroundColor String   @default("#4a90e2") // Color de fondo
  textColor       String   @default("#ffffff") // Color del texto
  icon            String?  // Icono opcional (nombre o URL)
  priority        Int      @default(0) // Orden de prioridad
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// PANTALLAS
// ============================================

model Screen {
  id          String       @id @default(cuid())
  number      Int          @unique @default(autoincrement())
  name        String       @unique
  queueId     String
  status      ScreenStatus @default(OFFLINE)
  apiKey      String       @unique @default(cuid())
  printerName String?      // Nombre de la impresora para impresión centralizada
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  queue      Queue         @relation(fields: [queueId], references: [id])
  printer    Printer?
  appearance Appearance?
  preference Preference?
  keyboard   KeyboardConfig?
  orders     Order[]
  heartbeats Heartbeat[]
}

enum ScreenStatus {
  ONLINE
  OFFLINE
  STANDBY
}

model Heartbeat {
  id        String   @id @default(cuid())
  screenId  String
  timestamp DateTime @default(now())

  screen Screen @relation(fields: [screenId], references: [id], onDelete: Cascade)

  @@index([screenId, timestamp])
}

// ============================================
// IMPRESORAS
// ============================================

model Printer {
  id       String  @id @default(cuid())
  screenId String  @unique
  name     String
  ip       String
  port     Int     @default(9100)
  enabled  Boolean @default(true)

  screen Screen @relation(fields: [screenId], references: [id], onDelete: Cascade)
}

// ============================================
// APARIENCIA (por pantalla)
// ============================================

model Appearance {
  id               String  @id @default(cuid())
  screenId         String  @unique

  // Tipografía general (legacy)
  fontSize         String  @default("20px")
  fontFamily       String  @default("Arimo-Medium")

  // Layout
  columnsPerScreen Int     @default(4)
  columnSize       String  @default("260px")
  footerHeight     String  @default("72px")
  ordersDisplay    String  @default("COLUMNS") // COLUMNS | ROWS

  // Tema
  theme            String  @default("DARK") // DARK | LIGHT
  screenName       String  @default("")
  screenSplit      Boolean @default(true)
  showCounters     Boolean @default(false)

  // Colores generales
  backgroundColor    String  @default("#f0f2f5")
  headerColor        String  @default("#1a1a2e")
  headerTextColor    String  @default("#ffffff")
  cardColor          String  @default("#ffffff")
  textColor          String  @default("#1a1a2e")
  accentColor        String  @default("#e94560")

  // ============================================
  // TIPOGRAFÍA HEADER (Orden #xxx)
  // ============================================
  headerFontFamily     String  @default("Inter, sans-serif")
  headerFontSize       String  @default("medium")  // xsmall, small, medium, large, xlarge, xxlarge
  headerFontWeight     String  @default("bold")    // normal, medium, semibold, bold
  headerFontStyle      String  @default("normal")  // normal, italic
  headerBgColor        String  @default("")        // Color de fondo (vacío = usa SLA color)
  headerTextColorCustom String @default("#ffffff") // Color de texto
  showHeader           Boolean @default(true)      // Mostrar/ocultar

  // ============================================
  // TIPOGRAFÍA TIMER (00:00)
  // ============================================
  timerFontFamily      String  @default("monospace")
  timerFontSize        String  @default("medium")
  timerFontWeight      String  @default("bold")
  timerFontStyle       String  @default("normal")
  timerTextColor       String  @default("#ffffff")
  showTimer            Boolean @default(true)

  // ============================================
  // TIPOGRAFÍA CLIENTE (nombre)
  // ============================================
  clientFontFamily     String  @default("Inter, sans-serif")
  clientFontSize       String  @default("small")
  clientFontWeight     String  @default("normal")
  clientFontStyle      String  @default("normal")
  clientTextColor      String  @default("#ffffff")
  clientBgColor        String  @default("")        // Vacío = usa SLA color
  showClient           Boolean @default(true)

  // ============================================
  // TIPOGRAFÍA CANTIDAD (5x)
  // ============================================
  quantityFontFamily   String  @default("Inter, sans-serif")
  quantityFontSize     String  @default("medium")
  quantityFontWeight   String  @default("bold")
  quantityFontStyle    String  @default("normal")
  quantityTextColor    String  @default("")        // Vacío = usa SLA color
  showQuantity         Boolean @default(true)

  // ============================================
  // TIPOGRAFÍA PRODUCTOS (nombre del producto)
  // ============================================
  productFontFamily    String  @default("Inter, sans-serif")
  productFontSize      String  @default("medium")
  productFontWeight    String  @default("bold")
  productFontStyle     String  @default("normal")
  productTextColor     String  @default("")        // Vacío = usa textColor general
  productBgColor       String  @default("")        // Vacío = transparente
  productUppercase     Boolean @default(true)

  // ============================================
  // TIPOGRAFÍA SUBPRODUCTOS/SUBITEMS (1x Pepsi, 1x Crispy)
  // ============================================
  subitemFontFamily    String  @default("Inter, sans-serif")
  subitemFontSize      String  @default("small")
  subitemFontWeight    String  @default("normal")
  subitemFontStyle     String  @default("normal")
  subitemTextColor     String  @default("#333333")
  subitemBgColor       String  @default("")
  subitemIndent        Int     @default(24)        // Indentación en px
  showSubitems         Boolean @default(true)

  // ============================================
  // TIPOGRAFÍA MODIFICADORES/NOTAS (*10x PRESAS, etc)
  // ============================================
  modifierFontFamily   String  @default("Inter, sans-serif")
  modifierFontSize     String  @default("small")
  modifierFontWeight   String  @default("normal")
  modifierFontStyle    String  @default("italic")
  modifierFontColor    String  @default("#666666")
  modifierBgColor      String  @default("")
  modifierIndent       Int     @default(24)
  showModifiers        Boolean @default(true)

  // ============================================
  // TIPOGRAFÍA NOTAS ESPECIALES (* nota)
  // ============================================
  notesFontFamily      String  @default("Inter, sans-serif")
  notesFontSize        String  @default("small")
  notesFontWeight      String  @default("normal")
  notesFontStyle       String  @default("italic")
  notesTextColor       String  @default("#ff9800")
  notesBgColor         String  @default("")
  notesIndent          Int     @default(24)
  showNotes            Boolean @default(true)

  // ============================================
  // TIPOGRAFÍA COMENTARIOS (comentarios del producto)
  // ============================================
  commentsFontFamily   String  @default("Inter, sans-serif")
  commentsFontSize     String  @default("small")
  commentsFontWeight   String  @default("normal")
  commentsFontStyle    String  @default("italic")
  commentsTextColor    String  @default("#4CAF50")
  commentsBgColor      String  @default("")
  commentsIndent       Int     @default(24)
  showComments         Boolean @default(true)

  // ============================================
  // TIPOGRAFÍA CANAL/FOOTER (KIOSKO-EFECTIVO)
  // ============================================
  channelFontFamily    String  @default("Inter, sans-serif")
  channelFontSize      String  @default("small")
  channelFontWeight    String  @default("bold")
  channelFontStyle     String  @default("normal")
  channelTextColor     String  @default("#ffffff")
  channelUppercase     Boolean @default(true)
  showChannel          Boolean @default(true)

  // Legacy fields (mantener compatibilidad)
  headerShowChannel    Boolean @default(true)
  headerShowTime       Boolean @default(true)

  // Disposicion adicional
  rows                 Int     @default(3)
  maxItemsPerColumn    Int     @default(6)

  // Opciones de visualizacion
  showOrderNumber      Boolean @default(true)
  animationEnabled     Boolean @default(true)

  screen        Screen         @relation(fields: [screenId], references: [id], onDelete: Cascade)
  cardColors    CardColor[]
  channelColors ChannelColor[]
}

model CardColor {
  id               String  @id @default(cuid())
  appearanceId     String
  color            String  // Hex color
  quantityColor    String  @default("") // Color de la cantidad (vacío = usa color del SLA)
  minutes          String  // Formato "MM:SS"
  order            Int     // Orden de prioridad (1, 2, 3, 4)
  isFullBackground Boolean @default(false)

  appearance Appearance @relation(fields: [appearanceId], references: [id], onDelete: Cascade)

  @@unique([appearanceId, order])
}

model ChannelColor {
  id           String  @id @default(cuid())
  appearanceId String
  channel      String
  color        String  // Background hex color
  textColor    String  @default("#ffffff") // Text hex color

  appearance Appearance @relation(fields: [appearanceId], references: [id], onDelete: Cascade)

  @@unique([appearanceId, channel])
}

// ============================================
// PREFERENCIAS (por pantalla)
// ============================================

model Preference {
  id                 String  @id @default(cuid())
  screenId           String  @unique

  // Orden
  finishOrderActive  Boolean @default(false)
  finishOrderTime    String  @default("00:20")

  // Datos de cliente
  showClientData     Boolean @default(true)
  showName           Boolean @default(true)

  // Identificadores
  showIdentifier     Boolean @default(true)
  identifierMessage  String  @default("Orden")
  showNumerator      Boolean @default(false)

  // UI
  showPagination     Boolean @default(true)
  sourceBoxActive    Boolean @default(true)
  sourceBoxMessage   String  @default("KDS")

  // Touch/Tactil
  touchEnabled       Boolean @default(false)

  // Botonera/Teclado - habilitada por defecto, se deshabilita automáticamente al activar touch
  botoneraEnabled    Boolean @default(true)

  screen Screen @relation(fields: [screenId], references: [id], onDelete: Cascade)
}

// ============================================
// CONFIGURACIÓN DE TECLADO/BOTONERA
// ============================================

model KeyboardConfig {
  id        String @id @default(cuid())
  screenId  String @unique

  // Acciones simples
  finishFirstOrder   String @default("h")
  finishSecondOrder  String @default("3")
  finishThirdOrder   String @default("1")
  finishFourthOrder  String @default("f")
  finishFifthOrder   String @default("j")
  nextPage           String @default("i")
  previousPage       String @default("g")
  undo               String @default("c")
  resetTime          String @default("r")

  // Navegación rápida
  firstPage          String @default("q")
  secondPage         String @default("w")
  middlePage         String @default("e")
  penultimatePage    String @default("x")
  lastPage           String @default("t")

  // Modales
  confirmModal       String @default("0")
  cancelModal        String @default("v")

  // Sistema
  power              String @default("a")
  exit               String @default("m")

  // Combos (JSON string)
  combos             String @default("[]")

  // Configuración
  debounceTime       Int    @default(200)

  screen Screen @relation(fields: [screenId], references: [id], onDelete: Cascade)
}

// ============================================
// ÓRDENES
// ============================================

model Order {
  id            String      @id @default(cuid())
  externalId    String      @unique // ID de MAXPOINT
  screenId      String?
  channel       String
  customerName  String?
  identifier    String      // Número de orden
  status        OrderStatus @default(PENDING)
  statusPos     String?     // Estado de la orden en el POS (ej: "TOMANDO PEDIDO", "PEDIDO TOMADO")
  createdAt     DateTime    @default(now()) @db.Timestamptz
  finishedAt    DateTime?   @db.Timestamptz
  printedAt     DateTime?   @db.Timestamptz

  // Campos adicionales para impresión/visualización (nullable, TEXT para soportar contenido largo)
  comments      String?     @db.Text // Comentarios adicionales de la orden
  templateHTML  String?     @db.Text // Plantilla HTML para renderizado
  valuesHTML    String?     @db.Text // Valores HTML para la plantilla

  screen Screen? @relation(fields: [screenId], references: [id])
  items  OrderItem[]

  @@index([screenId, status])
  @@index([createdAt])
}

enum OrderStatus {
  PENDING
  IN_PROGRESS
  FINISHED
  CANCELLED
}

model OrderItem {
  id       String  @id @default(cuid())
  orderId  String
  name     String
  quantity Int     @default(1)
  notes    String?
  modifier String?
  comments String? // Comentarios adicionales del producto

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

// ============================================
// CONFIGURACIÓN GENERAL
// ============================================

model GeneralConfig {
  id                     String  @id @default("general")

  // ============================================
  // MODO DE PRUEBA (Sandbox)
  // ============================================
  // Cuando está activo:
  // - Las órdenes se leen de MAXPOINT pero acciones NO afectan MAXPOINT
  // - La impresión genera PDF en lugar de enviar a impresora física
  testMode               Boolean @default(false)

  // ============================================
  // MODO DE CONFIGURACIÓN (Origen de tickets)
  // ============================================
  // "POLLING" = Importación desde MAXPOINT (método actual)
  // "API" = Recepción via API REST
  ticketMode             String  @default("POLLING") // POLLING | API

  // ============================================
  // MODO DE IMPRESIÓN
  // ============================================
  // "LOCAL" = Impresión TCP directa a impresora (método actual)
  // "CENTRALIZED" = Impresión via servicio centralizado HTTP
  printMode              String  @default("LOCAL") // LOCAL | CENTRALIZED

  // Configuración del servicio centralizado de impresión
  centralizedPrintUrl    String  @default("") // URL del servicio: http://ip:puerto/api/ImpresionTickets/Impresion
  centralizedPrintPort   Int     @default(5000)
  printTemplate          String? @db.Text     // Plantilla XML para impresión centralizada
  printTemplateType      String  @default("orden_pedido") // Tipo de plantilla (ej: orden_pedido)

  // Lectura de comandas (Polling)
  pollingInterval        Int     @default(2000) // ms
  orderLifetime          Int     @default(4)    // horas

  // Logs
  logRetentionDays       Int     @default(5)

  // Comandas
  printTcp               Boolean @default(true)
  orderAliveTime         Int     @default(300)  // segundos
  deleteOrderKey         String  @default("/")
  printRetries           Int     @default(3)
  printWithoutScreens    Boolean @default(false)
  printColumns           Int     @default(24)
  printFontSize          String  @default("small") // small | medium | large

  // Contadores
  showOrdersAndCounters  Boolean @default(true)
  countProducts          Boolean @default(false)

  // Conexión MXP
  mxpHost                String  @default("")
  mxpPort                Int?    // Puerto SQL Server (default 1433 si null)
  mxpUser                String  @default("")
  mxpPassword            String  @default("")
  mxpDatabase            String  @default("")

  // Estado del polling
  lastPollTime           DateTime? // Última vez que se ejecutó polling
  lastOrderId            String?   // Último ID de orden procesado

  updatedAt              DateTime @updatedAt
}

// ============================================
// CONTADORES DE PRODUCTOS
// ============================================

model ProductCounter {
  id        String   @id @default(cuid())
  screenId  String?
  product   String
  pattern   String   // Patrón para matching
  count     Int      @default(0)
  resetAt   DateTime @default(now())

  @@unique([screenId, pattern])
}

// ============================================
// AUDITORÍA
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  oldValue  String?  // JSON
  newValue  String?  // JSON
  ip        String?
  timestamp DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([timestamp])
  @@index([entity, entityId])
}
