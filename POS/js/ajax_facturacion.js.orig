/* global parseFloat, alertify */

var temporizadorPinpad;
var coma2 = 0;
var lc_timer = 0;
lc_control = 0;
lc_control_firma = 0;
lc_control_enlace = 0;
tfp_wst = -1;
swtTransaccionalmente = 0;
lc_control_factura = -1;
lc_tipoEnvio = -1;
lc_descripcionEnvio = "";
var tiempoEspera = 0;
lc_banderaOkAdmin = "";
var banderaUber = 0;
lc_agrupacion = "";
lc_subagrupacion = "";
var lc_idefectivo = -1;
lc_autorizacion = -1;
lc_banderaAplicapago = -1;
lc_clienteAx = -1;
lc_nombreclienteAx = "";
lc_cantidadPagada = 0;
var banderaUber = 0;
var valorCampoCodigo;
var lc_opcionCreditoEmpresa = -1;
var TEMPORIZADORUNIRED;
var procesoFidelizacion = "";
var TEMPORIZADOR_PAGO_TARJETA;
var status_cupon = 0;
var status_pago = 0;
var tipoLecturaCodigoDescuentoMultimarca = 0;
var cuponMultimarcaCanjeado = "";
var valorCampoCodigo = "";
var RESPONSE_JSON;
var RESPONSE_JSON2;
var RESPONSE_JSON3;
var RESPONSE_VJSON;
var RESPONSE_VJSON2;
var RESPONSE_VJSON3;
var EstadoRedimension = 0;
var EstadoCanjePuntos = -1;
var marketingCost = 0;
var storeCost = 0;
var redemptionCode = "";
////VARIABLE PARA CALCULAR EL DESCUENTO TOTAL DE LOS PRODUCTOS
//var lc_descuentoProducto;
var BANDERA_AGREGADOR = 0;

$(document).ready(function () {
<<<<<<< HEAD
    $(".descuentosLabel").shortscroll();
=======
    // $("#modal").iziModal();
    $('.descuentosLabel').shortscroll();
>>>>>>> origin/MXP_Version_1.9.10.6
    $("#credencialesContenedor").hide();
    $("#detalleFactura").hide();
    $("#visorFacturas").css("display", "none");
    $("#detalleFactura").css("display", "none");
    $("#visorFormasPago").css("display", "none");
    $("#detalleFormasPago").css("display", "none");
    $("#divRsts").css("display", "none");
    $("#divObservacion").css("display", "none");
    $("#ingresoValorCredito").hide();
    $("#ingresoValorCreditoTeclado").hide();
    $("#credencialesAdmin").hide();
    $("#modal_binDatafast").hide();
    $("#ticketPromedio").hide();
    $("#td_cambio").hide();
    $("#div_cvv").hide();
    $("#div_adminPasaporte").hide();
    $("#div_tipoCuentaTarjeta").hide();
    $("#aumentarContador").hide();
    $("#anulacionesContenedor").hide();
    $("#adminCreditoSinCupon").hide();
    $("#datosFactura").hide();
    $("#btnFacturaImprimir").hide();
    $("#btnClienteModificar").hide();
    $("#btnClienteGuardar").hide();
    $("#btnClienteCancelar").hide();
    $("#btnClienteGuardarActualiza").hide();
    $("#modalclienteAx").hide();
    $("#descuentosContenedor").hide();
    $("#descuentosDiscrecionalesContenedor").hide();
    $("#formCobrar").hide();

    fn_cargarAccesosSistema(); //HABILITA BOTONES SEGUN ACCESO

    lc_cantidadPagada = 0;
    fn_aplicaPagoPredeterminado();

    tiempoEspera = $("#tiempoEspera").val();
    moneda = $("#simMoneda").val();

    $("#hid_bandera_teclado").val(1);

    fn_facturar();


    fn_cargaDivBilletes();

    $("#pagado").val("");
    $("#dividirCuenta").hide();

    if ($("#txtTipoServicio").val() == 2) {
        $("#btn_propina").show();
    } else {
        $("#btn_propina").hide();
    }
    fn_bloquearIngreso();


    $("#txtClienteNombre").attr("disabled", "-1");
    $("#txtClienteApellido").attr("disabled", "-1");
    $("#txtClienteDireccion").attr("disabled", "-1");
    $("#txtClienteFono").attr("disabled", "-1");
    $("#txtCorreo").attr("disabled", "-1");
    if ($("#pagoTotal").val() > 199) {
        $("#btnConsumidorFinal").hide();
    } else {
        $("#btnConsumidorFinal").show();
    }

    $("#rdn_pdd_brr_ccns").click(function () {
        $("#rdn_pdd_brr_ccns").css("display", "none");
        $("#cnt_mn_dsplgbl_pcns_drch").css("display", "none");
    });
    $("#modalSWT").hide();
    $("#modalSWTCancelacion").hide();
    $("#modalsubSWT").hide();


    $("#modalCuponMultimarca").dialog({
        title: "Leer Cupón Multimarca",
        modal: true,
        position: {
            my: "right",
            at: "top"
        },
        width: 600,
        resizable: false,
        opacity: 0,
        duration: 500,
        autoOpen: false,
        closeOnEscape: false,
        buttons: [{
                id: "btnVerificarCodigoCuponMultimarca",
                text: "Verificar",
                click: fn_validarCuponMultimarca
            },
            {
                text: "Cancelar",
                click: function () {
                    $(this).dialog("close");
                    $("#keyboard").hide();
                }
            }
        ],
<<<<<<< HEAD
        open: function(event, ui) {
            $(".cntInputCodigoCuponMultimarca input").val("");
=======
        open: function (event, ui) {
            $('.cntInputCodigoCuponMultimarca input').val("");
>>>>>>> origin/MXP_Version_1.9.10.6

            mostrarOcultarInputsLectura(0);
        },
        close: function (event, ui) {
            $("#keyboard").hide();
        }

    });

    $("#inputCodigoCuponMultimarcaAutomatico").keypress(function (evt) {
        var tecla = evt.keyCode;
        //  13 es el código  de la tecla ENTER, 
        //  al final de la lectura el propio scanner inserta ese caracter al final. 
        if (13 === tecla) {
            $("#btnVerificarCodigoCuponMultimarca").click();
        }
    });
    mostrarOcultarInputsLectura(tipoLecturaCodigoDescuentoMultimarca);
    $("#btnLecturaAutomaticaCuponMultimarca").click(function () {
        mostrarOcultarInputsLectura(0);
        // console.log(tipoLecturaCodigoDescuentoMultimarca);
    });
    $("#btnLecturaManualCuponMultimarca").click(function () {
        mostrarOcultarInputsLectura(1);
        // console.log(tipoLecturaCodigoDescuentoMultimarca);
    });

    $("#inputCodigoCuponMultimarcaManual1").change(function (evt) {
        var valorActual = this.value;
        var tamValor = valorActual.length;

        if (3 <= tamValor) {
            $("#inputCodigoCuponMultimarcaManual2").focus();
            var substringValor = this.value.substring(0, 3);
            $("#inputCodigoCuponMultimarcaManual1").val(substringValor);
            evt.stopPropagation();
            return false;
        }
    });

    $("#inputCodigoCuponMultimarcaManual2").change(function (evt) {
        var valorActual = this.value;
        var tamValor = valorActual.length;

        if (8 <= tamValor) {
            $("#inputCodigoCuponMultimarcaManual3").focus();
            var substringValor = this.value.substring(0, 8);
            $("#inputCodigoCuponMultimarcaManual2").val(substringValor);
            evt.stopPropagation();
            return false;
        }
    });
    $("#inputCodigoCuponMultimarcaManual3").change(function (evt) {
        var valorActual = this.value;
        var tamValor = valorActual.length;
        if (9 <= tamValor) {
            $("#inputCodigoCuponMultimarcaManual4").focus();
            var substringValor = this.value.substring(0, 9);
            $("#inputCodigoCuponMultimarcaManual3").val(substringValor);
            evt.stopPropagation();
            return false;
        }
    });
    $("#inputCodigoCuponMultimarcaManual4").change(function (evt) {
        var valorActual = this.value;
        var tamValor = valorActual.length;
        if (2 <= tamValor) {
            var substringValor = this.value.substring(0, 2);
            $("#inputCodigoCuponMultimarcaManual4").val(substringValor);
            evt.stopPropagation();
            return false;
        }
    });

    $("#inputCodigoCuponMultimarcaManual1").focus(function () {
        fn_cambiarInputTecladoAlfanumericoCuponesMultimarca("inputCodigoCuponMultimarcaManual1");
        $(this).select();
    });
    $("#inputCodigoCuponMultimarcaManual2").focus(function () {
        fn_cambiarInputTecladoAlfanumericoCuponesMultimarca("inputCodigoCuponMultimarcaManual2");
        $(this).select();
    });
    $("#inputCodigoCuponMultimarcaManual3").focus(function () {
        fn_cambiarInputTecladoAlfanumericoCuponesMultimarca("inputCodigoCuponMultimarcaManual3");
        $(this).select();
    });
    $("#inputCodigoCuponMultimarcaManual4").focus(function () {
        fn_cambiarInputTecladoAlfanumericoCuponesMultimarca("inputCodigoCuponMultimarcaManual4");
        $(this).select();
    });

    status_cupon && status_pago ? fn_facturarCupon() : "";
});

function fn_facturarCupon() {
    $("#btnAplicarPago").css("display", "none");
    $("#btn_menuU").attr("disabled", "disabled");
    $(".btnDinero").attr("disabled", "disabled");
    $(".btnVirtualCalculadora").attr("disabled", "disabled");
    alertify.confirm("Esta seguro de realizar la factura de Autoconsumo ?");
    $("#alertify-ok").click(function () {
        fn_imprimirOrden();
        fn_validaCuponesAutoConsumo();
        fn_bloquearIngreso();
        $("#btnClienteModificar").hide();
        $("#btnFacturaImprimir").hide();
        fn_validaItemPagado();
    });
    $("#alertify-cancel").click(function () {
        alertify.error("No se realizó el canje");
    });
}

function fn_cambiarInputTecladoAlfanumericoCuponesMultimarca(idInputNuevo) {
    var inputNuevo = document.getElementById(idInputNuevo);
    fn_alfaNumerico(inputNuevo);
}

function mostrarOcultarInputsLectura(tipoLectura) {
    switch (tipoLectura) {
        case 0:
            //Tipo de lectura Automatico
            $("#cntInputCodigoCuponMultimarcaAutomatico").show();
            $("#inputCodigoCuponMultimarcaAutomatico").focus();
            $("#cntInputCodigoCuponMultimarcaManual").hide();
            $("#keyboard").hide();
            break;
        case 1:
            //Tipo de lectura Manual
            $("#cntInputCodigoCuponMultimarcaAutomatico").hide();
            $("#cntInputCodigoCuponMultimarcaManual").show();
            $("#inputCodigoCuponMultimarcaManual1").focus();
            break;
    }
    tipoLecturaCodigoDescuentoMultimarca = tipoLectura;
}

function fn_validarCuponMultimarca() {
    /* 
     * var pagadoo = parseFloat($("#pagado").val());
     */
    //Buscar el código que se insertó

    var codigo = "";
    if (tipoLecturaCodigoDescuentoMultimarca === 0) {
        // Tomar valor de código automático
        var codigoAutomatico = $("#inputCodigoCuponMultimarcaAutomatico").val();
        $("#inputCodigoCuponMultimarcaAutomatico").val("");
        var resultadoValidacion = codigoAutomatico.match(/^[A-Z]\d{6}[A-Z]\d{17}\w{5}\d{5}/gm);
        if (null === resultadoValidacion) {
            alertify.alert("Código Inválido");
            return false;
        }

        var codigoObj = {
            metodo: "verificarAuto",
            codigo: codigoAutomatico
        };
        $("#inputCodigoCuponMultimarcaAutomatico").val("");
        // Verificar validez del cupon en gerente
        var $peticionValidacion = $.post("clienteCanjearCuponesMultimarca.php",
<<<<<<< HEAD
            codigoObj,
            function(datos) {

                if (datos.estado === 0) {
                if (datos.Mensaje) {
                        alertify.alert(datos.Mensaje);
                } else {
                        alertify.alert(datos.mensaje);
                }
                    return false;
                }
                alertify.confirm("Cupón válido, Monto: $" + datos.monto + ", Canjear?");
                $("#alertify-ok").click(function() {
                    $("#modalCuponMultimarca").dialog("close");
                    fn_canjearCuponMultimarca(codigoAutomatico, datos.monto);
                    return true;
                });
                $("#alertify-cancel").click(function() {
                    alertify.error("No se realizó el canje");
                });
            },
            "json"
        );
=======
                codigoObj,
                function (datos) {

                    if (datos.estado === 0) {
                        if (datos.Mensaje)
                            alertify.alert(datos.Mensaje);
                        else
                            alertify.alert(datos.mensaje);
                        return false;
                    }
                    alertify.confirm("Cupón válido, Monto: $" + datos.monto + ", Canjear?");
                    $("#alertify-ok").click(function () {
                        $("#modalCuponMultimarca").dialog("close");
                        fn_canjearCuponMultimarca(codigoAutomatico, datos.monto);
                        return true;
                    });
                    $("#alertify-cancel").click(function () {
                        alertify.error("No se realizó el canje");
                    });
                },
                "json"
                );
>>>>>>> origin/MXP_Version_1.9.10.6

    } else if (tipoLecturaCodigoDescuentoMultimarca === 1) {
        // Tomar valor de código manual incremental - solicitud/cod_cupon/num_detalle
        var incremental = $("#inputCodigoCuponMultimarcaManual1").val();
        var solicitud = $("#inputCodigoCuponMultimarcaManual2").val();
        var cod_cupon = $("#inputCodigoCuponMultimarcaManual3").val();
        var num_detalle = $("#inputCodigoCuponMultimarcaManual4").val();
        var codigoObj = {
            metodo: "verificarManual",
            incremental: incremental,
            codigoSolicitud: solicitud,
            codigoSeguridad: cod_cupon,
            codigoUsuario: "",
            detalle: num_detalle
        };
        // Verificar validez del cupon en gerente
        $peticionValidacion = $.post("clienteCanjearCuponesMultimarca.php",
                codigoObj,
                function (datos) {
                    if (datos.estado === 0) {
                        if (datos.Mensaje)
                            alertify.alert(datos.Mensaje);
                        else
                            alertify.alert(datos.mensaje);
                        return false;
                    }
                    alertify.confirm("Cupón válido, Monto: $" + datos.monto + ", Canjear?");
                    $("#alertify-ok").click(function () {
                        $("#modalCuponMultimarca").dialog("close");
                        fn_canjearCuponMultimarca(datos.codigoCupon, datos.monto);
                        return true;
                    });
                    $("#alertify-cancel").click(function () {
                        alertify.error("No se realizó el canje");
                    });
                },
                "json"
                );

        // Buscar codigo del cupon en gerente
    }
}

function fn_canjearCuponMultimarca(codigo, monto) {
    var codigoObj = {
        metodo: "canjear",
        codigo: codigo,
        monto: monto
    };
    // Ejecutar el canje en gerente
    $.post("clienteCanjearCuponesMultimarca.php",
<<<<<<< HEAD
        codigoObj,
        function(datos) {
            if (datos.estado === 0) {
            if (datos.Mensaje) {
                    alertify.alert(datos.Mensaje);
            } else {
                    alertify.alert(datos.mensaje);
            }
                return false;
            }
            cuponMultimarcaCanjeado = codigoObj.codigo;
            // Modificar el lugar donde se ponga el valor de la forma de pago
            var pagado = datos.monto;
            var aPagar = parseFloat($("#pagoTotal").val());

            var valor = aPagar - pagado;
            //  $("#pagoTotal").val(valor.toFixed(2));
            $("#pagado").val(pagado);
            // Aplicar Forma de pago
            fn_insertarFormaPago();
            fn_obtieneTotalApagar();
            fn_resumenFormaPago();
            alertify.success(datos.mensaje);
            if (valor <= 0) {
                fn_envioFactura();
            }
        },
        "json"
    );
=======
            codigoObj,
            function (datos) {
                if (datos.estado === 0) {
                    if (datos.Mensaje)
                        alertify.alert(datos.Mensaje);
                    else
                        alertify.alert(datos.mensaje);
                    return false;
                }
                cuponMultimarcaCanjeado = codigoObj.codigo;
                // Modificar el lugar donde se ponga el valor de la forma de pago
                var pagado = datos.monto;
                var aPagar = parseFloat($("#pagoTotal").val());

                var valor = aPagar - pagado;
                //  $("#pagoTotal").val(valor.toFixed(2));
                $("#pagado").val(pagado);
                // Aplicar Forma de pago
                fn_insertarFormaPago();
                fn_obtieneTotalApagar();
                fn_resumenFormaPago();
                alertify.success(datos.mensaje);
                if (valor <= 0) {
                    fn_envioFactura();
                }
            },
            "json"
            );
>>>>>>> origin/MXP_Version_1.9.10.6
}

function fn_modalCuponMultimarca() {
    $("#inputCodigoCuponMultimarcaAutomatico").html("");
    $("#modalCuponMultimarca").dialog("open");
}

function fn_aplicaPagoPredeterminado() {
<<<<<<< HEAD
    send = { aplicaPagoPredeterminado: 1 };
    $.getJSON("config_facturacion.php", send, function(datos) {
=======
    send = {"aplicaPagoPredeterminado": 1};
    $.getJSON("config_facturacion.php", send, function (datos) {
>>>>>>> origin/MXP_Version_1.9.10.6
        if (datos.str > 0) {
            fn_botonPago(datos.fmp_descripcion, datos.fmp_id, datos.tfp_id, datos.autorizacion, datos.tfp_descripcion);
        }
    });
}

function fn_validaSalirOrden() {
<<<<<<< HEAD
    send = { validaSalirOrden: 1 };
    $.getJSON("config_facturacion.php", send, function(datos) {
=======
    send = {"validaSalirOrden": 1};
    $.getJSON("config_facturacion.php", send, function (datos) {
>>>>>>> origin/MXP_Version_1.9.10.6
        if (datos.rst_retoma_orden == 1) {
            $("#btn_salirOrden").show();
        }
        if (datos.rst_retoma_orden == 0) {
            $("#btn_salirOrden").hide();
        }
    });
}

function fn_facturar() {
    fn_insertarFactura();
    fn_formasPago();
    fn_ticketPromedio();
}

function fn_ticketPromedio() {
<<<<<<< HEAD
    send = { ticketPromedio: 1 };
    $.getJSON("config_facturacion.php", send, function(datos) {
=======
    send = {"ticketPromedio": 1};
    $.getJSON("config_facturacion.php", send, function (datos) {
>>>>>>> origin/MXP_Version_1.9.10.6
        $("#ticketPromedio").empty();
        if (datos.str > 0) {
            $("#ticketPromedio").show();
            html = "";
            html += "<label>Ticket Promedio: " + parseFloat(datos.ticketActual).toFixed(2) + "</label><br><label>Ticket Proyectado: " + datos.ticketProyectado + "</label>";
            $("#ticketPromedio").append(html);
        }
    });
}

///////////////////////////////////FORMAS DE PAGO//////////////////////////////////////////////////
function fn_formasPago() {
<<<<<<< HEAD
    var send = { formaPago: 1 };
    var descripcionVitality = "";
    var idTFPVitality = "";
    var requiereAVitality = "";
    var descripcionTFPVitality = "";

=======
    send = {"formaPago": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    $.ajax({
        async: false,
        type: "GET",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_facturacion.php",
        data: send,
        success: function (datos) {
            if (datos.str > 0) {
                $("#formasPago").empty();
                html4 = "<table id='tablaFormasPago'>";
                for (i = 0; i < datos.str; i++) {
                    var tfp_descripcion =
                        datos[i]["fmp_descripcion"] === "FIDELIZACION" ||
                        datos[i]["fmp_descripcion"] === "CONSUMO RECARGA" ?
                        datos[i]["fmp_descripcion"] :
                        datos[i]["tfp_descripcion"];
                    if (datos[i]["fmp_descripcion"] == "EFECTIVO") {
                        $("#fmp_id").val(datos[i]["fmp_id"]);
                        $("#tfp_id").val(datos[i]["tfp_id"]);
                        lc_idefectivo = datos[i]["fmp_id"];
                    } else if (datos[i]["fmp_descripcion"] == "CREDITO EXTERNO") {
                        $("#hidIdCreditoExterno").val(datos[i]["fmp_id"]);
                    } else if (datos[i]["fmp_descripcion"] == "VITALITY") {
                        descripcionVitality = datos[i]["fmp_descripcion"];
                        idTFPVitality = datos[i]["tfp_id"];
                        requiereAVitality = datos[i]["requiereAutorizacion"];
                        descripcionTFPVitality = tfp_descripcion;
                    }

                    if (i % 2 == 0) {
                        html4 += "<tr>";
                        if (datos[i]["fmp_imagen"] == "0") {
                            if (datos[i]["fmp_descripcion"] == "EFECTIVO") {
                                $("#fmp_id").val(datos[i]["fmp_id"]);
                                $("#tfp_id").val(datos[i]["tfp_id"]);
                                lc_idefectivo = datos[i]["fmp_id"];
                            }
                            html4 +=
                                "<td style='vertical-align:middle;'><button style='background: #E6E6E6 no-repeat center center' class='btnVirtualCalculadora btnTarjetas' id='" +
                                datos[i]["fmp_id"] +
                                "'  title='" +
                                datos[i]["fmp_descripcion"] +
                                "'";
                            html4 +=
                                "onclick='fn_botonPago(\"" +
                                datos[i]["fmp_descripcion"] +
                                '","' +
                                datos[i]["fmp_id"] +
                                '","' +
                                datos[i]["tfp_id"] +
                                '",' +
                                datos[i]["requiereAutorizacion"] +
                                ',"' +
                                datos[i]["tfp_descripcion"] +
                                "\")'><b>" +
                                datos[i]["fmp_descripcion"] +
                                "</b></button></td>&nbsp;";
                        } else {
                            if (datos[i]["fmp_descripcion"] == "EFECTIVO") {
                                $("#fmp_id").val(datos[i]["fmp_id"]);
                                $("#tfp_id").val(datos[i]["tfp_id"]);
                                lc_idefectivo = datos[i]["fmp_id"];
                            }
                            html4 +=
                                "<td style='vertical-align:middle;'><button style='background: #E6E6E6 no-repeat center center url(data:image/png;base64," +
                                datos[i]["fmp_imagen"] +
                                "' class='btnVirtualCalculadora btnTarjetas' id='" +
                                datos[i]["fmp_id"] +
                                "' title='" +
                                datos[i]["fmp_descripcion"] +
                                "'";
                            html4 +=
                                "onclick='fn_botonPago(\"" +
                                datos[i]["fmp_descripcion"] +
                                '","' +
                                datos[i]["fmp_id"] +
                                '","' +
                                datos[i]["tfp_id"] +
                                '",' +
                                datos[i]["requiereAutorizacion"] +
                                ',"' +
                                datos[i]["tfp_descripcion"] +
                                "\")'></button></td>&nbsp;";
                        }
                    }
                    if (i % 2 == 1) {
                        if (datos[i]["fmp_imagen"] == "0") {
                            if (datos[i]["fmp_descripcion"] == "EFECTIVO") {
                                $("#fmp_id").val(datos[i]["fmp_id"]);
                                $("#tfp_id").val(datos[i]["tfp_id"]);
                                lc_idefectivo = datos[i]["fmp_id"];
                            }
                            html4 +=
                                "<td style='vertical-align:middle;'><button style='background: #E6E6E6 no-repeat center center' class='btnVirtualCalculadora btnTarjetas' id='" +
                                datos[i]["fmp_id"] +
                                "'  title='" +
                                datos[i]["fmp_descripcion"] +
                                "'";
                            html4 +=
                                "onclick='fn_botonPago(\"" +
                                datos[i]["fmp_descripcion"] +
                                '","' +
                                datos[i]["fmp_id"] +
                                '","' +
                                datos[i]["tfp_id"] +
                                '",' +
                                datos[i]["requiereAutorizacion"] +
                                ',"' +
                                datos[i]["tfp_descripcion"] +
                                "\")'><b>" +
                                datos[i]["fmp_descripcion"] +
                                "</b></button></td>&nbsp;";
                        } else {
                            if (datos[i]["fmp_descripcion"] == "EFECTIVO") {
                                $("#fmp_id").val(datos[i]["fmp_id"]);
                                $("#tfp_id").val(datos[i]["tfp_id"]);
                                lc_idefectivo = datos[i]["fmp_id"];
                            }
                            html4 +=
                                "<td style='vertical-align:middle;'><button style='background: #E6E6E6 no-repeat center center url(data:image/png;base64," +
                                datos[i]["fmp_imagen"] +
                                "' class='btnVirtualCalculadora btnTarjetas' id='" +
                                datos[i]["fmp_id"] +
                                "' title='" +
                                datos[i]["fmp_descripcion"] +
                                "'";
                            html4 +=
                                "onclick='fn_botonPago(\"" +
                                datos[i]["fmp_descripcion"] +
                                '","' +
                                datos[i]["fmp_id"] +
                                '","' +
                                datos[i]["tfp_id"] +
                                '",' +
                                datos[i]["requiereAutorizacion"] +
                                ',"' +
                                datos[i]["tfp_descripcion"] +
                                "\")'></button></td>&nbsp;";
                        }
                        html4 += "</tr>";
                    }

                }
                $("#formasPago").append(html4 + "</table>");
                $("#btnFormaPagoId").val(lc_idefectivo);
            }
        }

    });


    var soloPuntos = false;
    if ($("#listaFactura> li").html() === null) {
        soloPuntos = true;
    }
<<<<<<< HEAD
    var sinPlusPuntos = $("#listaFactura_canje_puntos").html() === null;
    var sinPlusNormales = $("#listaFactura > li").html() === null;
    var vitality = $("#hidVitality").val();
    if (vitality == 1) {
        $("#tablaFormasPago tr td").each(function() {
            if ($(this).find("button").attr("title") !== "VITALITY") {
                $(this).find("button").css("display", "none");
            }
        });
        fn_botonPago(descripcionVitality, "", idTFPVitality, requiereAVitality, descripcionTFPVitality);
    } else {
        $("#tablaFormasPago tr td").each(function () {
            if ($(this).find("button").attr("title") === "VITALITY") {
=======


    //ocultar boton de FIDELIZACION si no hay  plus con puntos en la factura.
    $("#tablaFormasPago tr td").each(function () {
        if (($(this).find("button").attr("title") === "FIDELIZACION" && $("#listaFactura_canje_puntos").html() === null)) {
            $(this).find("button").css("display", "none");
        }
    });

    if (soloPuntos) {
        $("#tablaFormasPago tr td").each(function () {
            if (($(this).find("button").attr("title") !== "FIDELIZACION")) {
>>>>>>> origin/MXP_Version_1.9.10.6
                $(this).find("button").css("display", "none");
            }
        });
        if (sinPlusPuntos) {
            $("#tablaFormasPago tr td").each(function () {
                if ($(this).find("button").attr("title") === "FIDELIZACION") {
                    $(this).find("button").css("display", "none");
                }
            });
        }
        if (sinPlusNormales) {
            $("#tablaFormasPago tr td").each(function () {
                if (
                    $(this)
                    .find("button")
                    .attr("title") !== "FIDELIZACION"
                ) {
                    $(this).find("button").css("display", "none");
                }

            });
            if (soloPuntos) {
                $("#tablaFormasPago tr td").each(function () {
                    if (
                        $(this)
                        .find("button")
                        .attr("title") !== "FIDELIZACION"
                    ) {
                        $(this).find("button").css("display", "none");
                    }
                });
                $("#hid_descTipoFp").val("FIDELIZACION");
                $("#btnAplicarPago").html("<b>Aplicar <br>FIDELIZACION</b>");
                $("#btnAplicarPago").attr("title", "FIDELIZACION");
                $("#btnCancelarPago").html("<b>Cancelar <br>FIDELIZACION</b>");
                $("#btnCancelarPago").attr("title", "FIDELIZACION");
            }

        }
    }
//  if (soloPuntos && ($(this).find("button").attr("title") !== "FIDELIZACION") ){
    //               $(this).find("button").css("display", "none");
    //           }  

}

/////////////////////////////BOTON APLICAR PAGO/////////////////////////////////
function fn_botonPago(descripcion, id, id_tfp, requiereAutorizacion, descripcion_tfp) {
    lc_autorizacion = requiereAutorizacion;
    $("#txt_tfpId").val(id_tfp);
    $("#hid_descTipoFp").val(descripcion_tfp);
    $("#hid_descFp").val(descripcion);
    $("#btnAplicarPago").empty();
    $("#btnAplicarPago").removeAttr("disabled");

    var tituloBoton = "<b>Aplicar <br/>" + descripcion + "</b>";
    $("#btnAplicarPago").append(tituloBoton);
    $("#btnAplicarPago").attr("title", descripcion);
    $("#btnFormaPagoId").val(id);
    $("#btnFormaPagoId").val(
        $("#hidVitality").val() == "1" ? $("#hidIdCreditoExterno").val() : id
    );
    if ($("#hidVitality").val() == "1") {
        $("#btnCancelarPago").hide();
    } else {
        $("#btnCancelarPago").attr("title", descripcion);
    }
    $("#btnCancelarPago").attr("title", descripcion);

    $("#btnCancelarPago").empty();
    var tituloCancelar = "<b>Cancelar <br/>" + descripcion + "</b>";
    $("#btnCancelarPago").append(tituloCancelar);
    comprobarSaldoRecarga(descripcion);
}

function comprobarSaldoRecarga(descripcion) {
    if (descripcion === "CONSUMO RECARGA") {
        var saldo = parseFloat($("#hide_saldo").val());
        var aPagar = parseFloat($("#pagoTotal").val());
        if (saldo < aPagar) {
            alertify.alert("Saldo ($" + saldo + ") insuficiente para cubrir el total de la transacción.");
        }
    }
}

//////////////////////////////////CERRAR VENTANA////////////////////////////////////////////////
function fn_cerrar() {
    $("#contenedor").hide({
        autoOpen: false,
        hide: {
            effect: "explode",
            duration: 500
        }
    });
}

////////////////////////////////LISTADO DE PRODUCTOS//////////////////////////////////////////
function fn_listaFacturar() {
    $("#listaFactura").empty();
    var totalItem = 0;
<<<<<<< HEAD
    var html = "";
    var send = { listaFactura: 1 };
=======
    send = {"listaFactura": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cdn_id = $("#txtCadenaId").val();
    send.cfac_id = $("#txtNumFactura").val();
    $.ajax({
        async: true,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str > 0) {
                $("#listaFactura").empty();
                for (var i = 0; i < datos.str; i++) {
                    html = "<li id='item1'><div class='listaproductosCant'>";
                    if (datos[i]["totalizado"] != 0) {
                        html += "" + datos[i]["dtfac_cantidad"] + "";
                    } else {
                        html += "  &nbsp;&nbsp;";
                    }
                    html += "</div>";
                    html +=
                        "<div class='listaproductosDesc'>" +
                        datos[i]["plu_descripcion"] +
                        "</div>";
                    totalItem =
                        datos[i]["dtfac_precio_unitario"] * datos[i]["dtfac_cantidad"];
                    html += "<div class='listaproductosVal'>";
                    if (datos[i]["totalizado"] != 0) {
                        html +=
                            "" +
                            moneda +
                            " " +
                            parseFloat(datos[i]["totalizado"]).toFixed(2) +
                            "";
                    } else {
                        html += "";
                    }
                    html += "</div></li><br/>";
                    cdn_tipoImpuesto = datos[i]["cdn_tipoimpuesto"];
                    lc_cantidadPagada = parseFloat(datos[i]["dtfac_total"]).toFixed(2);
                    $("#btnBaseFactura").val(lc_cantidadPagada);
                    $("#listaFactura").append(html);
                }
                fn_listaTotales();
            }
        }
    });
}
var JSON_TOTALES_FACTURA = "";
function fn_listaTotales() {
<<<<<<< HEAD
    var send = { fac_listaTotales: 1 };
=======
    send = {"fac_listaTotales": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.codigodelaFactura = $("#txtNumFactura").val();
    $.ajax({
        async: false,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str > 0) {
                $("#tblValoresTotales").empty();
<<<<<<< HEAD
                for (var i = 0; i < datos.str; i++) {
                    if (datos[i]["descripcion"] == "TOTAL") {
                        valoresTotales = "<tr style='background-color:#F36;color:#FFF'>";
                        valoresTotales +=
                            "<th width='130px' style='font-size:19px;' align='right'>" +
                            datos[i]["descripcion"] +
                            "</th><th style='font-size:19px;' width='40px' align='center'>" +
                            moneda +
                            "</th>";
                        $("#pagoTotal").val(
                            /*((parseFloat(datos[i]['valor'])).toFixed(2))-*/
                            parseFloat(
                                lc_cantidadPagada
                            ).toFixed(2)
                        );
                        $("#diferenciaPago").val(
                            (parseFloat(datos[i]["valor"]) * -1).toFixed(2)
                        );

                        $("#pagoGranTotal").val(parseFloat(datos[i]["valor"]).toFixed(2));
                        $("#valor_total_factura").val(parseFloat(datos[i]["valor"]).toFixed(2));

                        if (parseFloat(datos[i]["valor"]) === 0 && $("#hide_fidelizacionActiva").val() === "1" && !($("#listaFactura_canje_puntos").html() === null || $("#listaFactura_canje_puntos").html() === "")) {
=======
                JSON_TOTALES_FACTURA = datos;
                for (var i = 0; i < datos.str; i++) {
                    if (datos[i]['descripcion'] == 'TOTAL') {
                        valoresTotales = "<tr style='background-color:#F36;color:#FFF'>";
                        valoresTotales += "<th width='130px' style='font-size:19px;' align='right'>" + (datos[i]['descripcion']) + "</th><th style='font-size:19px;' width='40px' align='center'>" + moneda + "</th>";
                        $("#pagoTotal").val(/*((parseFloat(datos[i]['valor'])).toFixed(2))-*/ parseFloat(lc_cantidadPagada).toFixed(2));
                        $("#diferenciaPago").val((parseFloat(datos[i]['valor']) * -1).toFixed(2));

                        $("#pagoGranTotal").val((parseFloat(datos[i]['valor'])).toFixed(2));

                        console.log('$("#hide_fidelizacionActiva").val() :', $("#hide_fidelizacionActiva").val());
                        console.log('$("#listaFactura_canje_puntos").html() :', $("#listaFactura_canje_puntos").html());

                        if (parseFloat(datos[i]['valor']) === 0 && $("#hide_fidelizacionActiva").val() === "1" && !($("#listaFactura_canje_puntos").html() === null || $("#listaFactura_canje_puntos").html() === '')) {
>>>>>>> origin/MXP_Version_1.9.10.6
                            valoresTotales += "<th style='font-size:19px;' width='100px' align='center'> Sin cargos</th>";
                        } else {
                            valoresTotales += "<th style='font-size:19px;' width='100px' align='center'>" + parseFloat(datos[i]["valor"]).toFixed(2) + "</th>";
                        }
                        valoresTotales += "</tr>";

<<<<<<< HEAD
                        if (parseFloat(datos[i]["valor"]) === 0 && $("#hide_fidelizacionActiva").val() === "1" && !($("#listaFactura_canje_puntos").html() === null || $("#listaFactura_canje_puntos").html() === "")) {
                            status_pago = 1;
                            $("#pagoGranTotal").val("Sin Cargos");
                        }                      
=======
                        if (parseFloat(datos[i]['valor']) === 0 && $("#hide_fidelizacionActiva").val() === "1" && !($("#listaFactura_canje_puntos").html() === null || $("#listaFactura_canje_puntos").html() === '')) {
                            status_pago = 1;
                            $("#pagoGranTotal").val("Sin Cargos");
                        }
>>>>>>> origin/MXP_Version_1.9.10.6
                    } else {
                        valoresTotales = "<tr>";
                        valoresTotales +=
                            "<td width='130px' align='right'>" +
                            datos[i]["descripcion"] +
                            "</td><td width='40px' align='center'>" +
                            moneda +
                            "</td>";
                        valoresTotales +=
                            "<td width='100px' align='center'>" +
                            parseFloat(datos[i]["valor"]).toFixed(2) +
                            "</td>";
                        valoresTotales += "</tr>";
                    }
                    $("#tblValoresTotales").append(valoresTotales);
                }
                fn_resumenFormaPago();
            }
        }
    });
}

/////////////////////////GUARDAR FACTURA/////////////////////////////////////////
function fn_insertarFactura() {
    var esVoucher = $("#txt_esVoucher").val() ? $("#txt_esVoucher").val() : 0;
    //    if (!document.getElementById('txt_esVoucher')) {
    //        esVoucher = 0;
    //    } else {
    //        esVoucher = 1;
    //    }
    var status = 0;
    var html = "";
    var html2 = "";
<<<<<<< HEAD
    var html_cabecera =
        '<div id="listaFactura_canje_puntos">   PUNTOS **************************************************';
    var send = { insertarFactura: 1 };
=======
    var html_cabecera = "<div id=\"listaFactura_canje_puntos\">   PUNTOS **************************************************";

    send = {"insertarFactura": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.numCuenta = $("#txtNumCuenta").val();
    send.rst_id = $("#txtRestaurante").val();
    send.odp_id = $("#txtOrdenPedidoId").val();
    send.usr_id = $("#txtUserId").val();
    send.divisionCuenta = esVoucher;
    $.ajax({
        async: false,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {

            if (datos.str > 0) {
                for (var i = 0; i < datos.str; i++) {
                    $("#txtNumFactura").val(datos[i]["Cod_Factura"]);
                    if (datos[i]["btn_cancela_pago"] == 1) {
                        $("#btnCancelarPago").show();
                    } else {
                        $("#btnCancelarPago").hide();
                    }
                }
                $("#listaFactura").empty();
                for (var i = 0; i < datos.str; i++) {
                    if (datos[i]["descuento"] > 0) {
                        var porcenDesc = datos[i]["desc_porcentaje"];

                        if (porcenDesc != 0) {
                            html = "<li id='item1' style='background:#7FCF83;'><div class='listaproductosCant'>";
                        } else {
                            html = "<li id='item1' style='background:#4FB6D8;'><div class='listaproductosCant'>";
                        }

                        if (datos[i]["totalizado"] != 0) {
                            html += "" + parseFloat(datos[i]["dtfac_cantidad"]) + "";
                        } else {
                            html += "  &nbsp;&nbsp;";
                        }

                        html += "</div>";
                        html +=
                            "<div class='listaproductosDesc'>" +
                            datos[i]["plu_descripcion"] +
                            "</div>";
                        totalItem =
                            datos[i]["dtfac_precio_unitario"] * datos[i]["dtfac_cantidad"];
                        html += "<div class='listaproductosVal'>";

                        if (datos[i]["totalizado"] != 0) {
                            html +=
                                "" +
                                moneda +
                                " " +
                                parseFloat(datos[i]["totalizado"]).toFixed(2) +
                                "";
                        } else {
                            html += "";
                        }
                        html += "</div></li><br/>";

                        if (porcenDesc != 0) {
                            html += "<li id='item1' style='background:#7FCF83; font-size:13px; height:18px;'><div class='listaproductosCant'>";
                        } else {
                            html += "<li id='item1' style='background:#4FB6D8; font-size:13px; height:18px;'><div class='listaproductosCant'>";
                        }

                        html += "&ensp;&ensp;";
                        html += "</div>";

                        if (porcenDesc != 0) {
                            html += "<div class='listaproductosDesc' style='text-align: right;'>Descuento: " + porcenDesc + "%</div>";
                        } else {
                            html += "<div class='listaproductosDesc' style='text-align: right;'>Descuento: </div>";
                        }

                        html += "<div class='listaproductosVal'>";
                        html +=
                            "" +
                            moneda +
                            " " +
                            parseFloat(datos[i]["descuento"]).toFixed(2) +
                            "";
                        html += "</div></li><br/>";

                    } else {
                        if (datos[i]["canje_puntos"] === 1) {
                            html2 = "";
                            status = 1;
                            html2 = "<li id='item1' style='background:white;'><div class='listaproductosCant'>";
                            if (datos[i]["totalizado"] != 0) {
                                html2 += "" + datos[i]["dtfac_cantidad"] + "";
                            } else {
                                html2 += "  &nbsp;&nbsp;";
                            }
                            html2 += "</div>";
                            html2 +=
                                "<div class='listaproductosDesc'>" +
                                datos[i]["plu_descripcion"] +
                                "</div>";
                            totalItem =
                                datos[i]["dtfac_precio_unitario"] * datos[i]["dtfac_cantidad"];
                            html2 += "<div class='listaproductosVal'>";
                            if (datos[i]["totalizado"] != 0) {
                                html2 += parseFloat(datos[i]["puntos"]) + " Pts.";
                            } else {
                                html2 += "";
                            }
                            html2 += "</div></li><br/>";

                            html_cabecera += html2;

                            html = "";


                        }
                        if (datos[i]["tipoBeneficioCupon"] === 3) {
                            status_cupon = datos[i]["tipoBeneficioCupon"];
                            descripcion_autoconsumo = "********AUTOCONSUMO********";
                            html =
                                "<li id='item1' style='background:#99fcd5;'><div class='listaproductosCant'>";
                            if (datos[i]["totalizado"] != 0) {
                                html += "" + datos[i]["dtfac_cantidad"] + "";
                            } else {
                                html += "  &nbsp;&nbsp;";
                            }
                            html += "</div>";
                            html +=
                                "<div class='listaproductosDesc'>" +
                                descripcion_autoconsumo +
                                " " +
                                datos[i]["plu_descripcion"] +
                                "</div>";
                            totalItem =
                                datos[i]["dtfac_precio_unitario"] * datos[i]["dtfac_cantidad"];
                            html += "<div class='listaproductosVal'>";
                            if (datos[i]["totalizado"] != 0) {
                                html +=
                                    "" +
                                    moneda +
                                    " " +
                                    parseFloat(datos[i]["totalizado"]).toFixed(2) +
                                    "";
                            } else {
                                html += "";
                            }
                            html += "</div></li><br/>";
                        } else {
                            if (datos[i]["canje_puntos"] !== 1) {
                                html =
                                    "<li id='item1' style='background:white;'><div class='listaproductosCant'>";
                                if (datos[i]["totalizado"] != 0) {
                                    html += "" + datos[i]["dtfac_cantidad"] + "";
                                } else {
                                    html += "  &nbsp;&nbsp;";
                                }
                                html += "</div>";
                                html +=
                                    "<div class='listaproductosDesc'>" +
                                    datos[i]["plu_descripcion"] +
                                    "</div>";
                                totalItem =
                                    datos[i]["dtfac_precio_unitario"] * datos[i]["dtfac_cantidad"];
                                html += "<div class='listaproductosVal'>";
                                if (datos[i]["totalizado"] != 0) {
                                    html +=
                                        "" +
                                        moneda +
                                        " " +
                                        parseFloat(datos[i]["totalizado"]).toFixed(2) +
                                        "";
                                } else {
                                    html += "";
                                }
                                html += "</div></li><br/>";

                            }
                        }
                    }
                    cdn_tipoImpuesto = datos[i]["cdn_tipoimpuesto"];
                    lc_cantidadPagada = parseFloat(datos[i]["dtfac_total"]);
                    $("#btnBaseFactura").val(lc_cantidadPagada);
                    $("#listaFactura").append(html);
                }

                html_cabecera += " </div>";
                if (status === 1) {
                    $("#listaFactura").append(html_cabecera);
                }
                fn_listaTotales();
            } else {

                alertify.alert("Error al registrar la factura");
            }

        }
    });
}

/////////////////////////GUARDAR FORMAS DE PAGO///////////////////////////////////	
function fn_insertarFormaPago() {

    var html = "";
    var btnformadepago = $("#btnAplicarPago").attr("title");
    var pagooTotal = parseFloat($("#pagoTotal").val());
    var pagadoo = parseFloat($("#pagado").val());
<<<<<<< HEAD
    var send = { insertarFormaPago: 1 };
=======
    var send = {"insertarFormaPago": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.fct_id = $("#txtNumFactura").val();
    send.frmPago_id = $("#btnFormaPagoId").val();
    send.frmPago_numSeg = 0;
    send.tfpSwtransaccional = tfp_wst;
    if (pagooTotal > pagadoo) {
        send.frmPagoBillete = $("#pagado").val();
        send.fctTotal = $("#pagado").val();
    } else if (pagooTotal == pagadoo) {
        send.frmPagoBillete = $("#pagado").val();
        send.fctTotal = $("#pagado").val();
    } else {
        send.frmPagoBillete = $("#pagado").val();
        send.fctTotal = $("#pagoTotal").val();
    }
    $.ajax({
        async: false,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str > 0) {
                $("#btnCancelarPago").attr("disabled", false);
                for (i = 0; i < datos.str; i++) {
                    html += "<tr>";
                    html +=
                        "<td width='130px' align='right'>" +
                        datos[i]["fmp_descripcion"] +
                        "</td><td width='40px' align='center'>$</td>";
                    html +=
                        "<td width='100px' align='center'>" +
                        parseFloat(datos[i]["fpf_total_pagar"]).toFixed(2) +
                        "</td>";
                    html += "</tr>";
                }
                $("#formasPago2").html(html);
            } else {
                $("#btnCancelarPago").attr("disabled", true);
                alertify.alert("Error al registrar la factura");
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            alertify.alert("Error al agregar la forma de pago.");
            $("#btnCancelarPago").attr("disabled", true);
        }
    });
}


function fn_timeoutPinpadUnired() {
    timeOutPinpadUnired = setTimeout("fn_detenerProcesoPinpadUnired();", tiempoEspera);
}


function fn_timeout2() {
    timeOut = setTimeout("fn_detenerProcesoEsperaFirma();", tiempoEspera);
}


function fc_timeout3() {
    timeOut = setTimeout("fn_detenerProcesoEsperaFirma();", tiempoEspera);
}

function fn_detenerProceso() {
    cargando(1);
    clearInterval(temporizadorPinpad);
    $("#pagado").val("");
    lc_control = 1;
    alertify.alert("Expiro el tiempo de espera.Vuelva a intentarlo");
    $("#alertify-ok").click(function () {
        event.stopPropagation();
        lc_control = 0;
        fn_resumenFormaPago();
        return false;
    });
}


function fn_detenerProcesoPinpadUnired() {
    cargando(1);
    lc_control = 1;
    clearInterval(TEMPORIZADORUNIRED);
    $("#pagado").val("");
    alertify.alert("Expiro el tiempo de espera.Vuelva a intentarlo");

<<<<<<< HEAD
    send = { consultaIdSWtimeoutBanda: 1 };
=======
    send = {"consultaIdSWtimeoutBanda": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.movtimeOutBanda = $("#txtNumFactura").val();
    send.accionSwtTimeouBanda = 2; //bandera de banda
    $.getJSON("config_facturacion.php", send, function () {
        fn_resumenFormaPago();
    });
    $("#alertify-ok").click(function (event) {
        event.stopPropagation();
        lc_control = 0;
        return false;
    });
}


function fn_esperaRespuestaPProduccion() {
<<<<<<< HEAD
    send = { esperaRespuestaRequerimientoAutorizacion: 1 };
=======
    send = {"esperaRespuestaRequerimientoAutorizacion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfac = $("#txtNumFactura").val();
    $.ajax({
        async: true,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.existe === 1) {
                fn_funcionMuestraRespuestaPinpadUnired(datos.rsaut_respuesta, datos.cres_codigo, datos.fpf_id, datos.rsaut_id, datos.errorTrama, datos.codigoAutorizador);
            }
        }
    });
}

function fn_esperarPProduccion() {
<<<<<<< HEAD
    send = { esperaRespuestaRequerimientoAutorizacion: 1 };
=======
    send = {"esperaRespuestaRequerimientoAutorizacion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfac = $("#txtNumFactura").val();
    $.ajax({
        async: true,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.existe == 2) {
                fn_esperaRespuestaPProduccion();
            } else {
                fn_funcionMuestraRespuestaPinpadUnired(datos.rsaut_respuesta, datos.cres_codigo, datos.fpf_id, datos.rsaut_id, datos.errorTrama, datos.codigoAutorizador);
            }
        }
    });
}


function fn_funcionMuestraRespuestaPinpadUnired(respuesta, codigoRespuesta, formadePago, idRespuesta, tramaError, codigoAutorizador) {
    timeOutPinpadUnired = clearTimeout(timeOutPinpadUnired);
    clearInterval(TEMPORIZADORUNIRED);
    $("#countdown").countdown360().stop();
    $("#txt_trama").val("");
    lc_control = 1;
    cargando(1);
    if (tramaError == 1) {
        if (codigoRespuesta == "00" && codigoAutorizador != "04") {
<<<<<<< HEAD
            send = { ingresaFormaPagoTarjeta: 1 };
=======
            send = {"ingresaFormaPagoTarjeta": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
            send.codFactTarjeta = $("#txtNumFactura").val();
            send.fmpIdTarjeta = $("#btnFormaPagoId").val();
            send.fmpNumSegtar = 0;
            if ($("#pagoTotal").val() >= $("#pagado").val() || $("#pagoTotal").val() == $("#pagado").val()) {
                send.frmPagoTotalTarjeta = $("#pagado").val();
                send.fctTotalTarjeta = $("#pagado").val();
            } else {
                send.frmPagoTotalTarjeta = $("#pagado").val();
                send.fctTotalTarjeta = $("#pagado").val();
            }
            send.SwtTipo = 5; //lc_tipoEnvio;
            if ($("#cantidad").val() == "") {
                send.propina_valor = 0;
            } else {
                send.propina_valor = parseFloat($("#cantidad").val());
            }
<<<<<<< HEAD
            $.getJSON("config_facturacion.php", send, function(datos) {
                send = { grabacanalmovimientoVoucher: 1 };
=======
            $.getJSON("config_facturacion.php", send, function (datos) {
                send = {"grabacanalmovimientoVoucher": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                send.respuesta = idRespuesta;
                $.getJSON("config_facturacion.php", send, function (datos) { });
                lc_control = 0;
                var aPagar = parseFloat($("#pagoTotal").val());
                var pagado = parseFloat($("#pagado").val());
                var valor = aPagar - pagado;
                var btnNombre = $("#btnAplicarPago").attr("title");
                $("#pagoTotal").val(valor.toFixed(2));
                $("#pagado").val("");
                fn_resumenFormaPago();
                if (valor <= 0 && btnNombre != "EFECTIVO") {
                    fn_envioFactura();
                }
            });
        } else if (codigoRespuesta == "0") {
            alertify.alert(tramaError);
            return false;
        } else {
            $("#pagado").val("");
<<<<<<< HEAD
            send = { grabacanalmovimientoVoucher: 1 };
=======
            send = {"grabacanalmovimientoVoucher": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
            send.respuesta = idRespuesta;
            $.getJSON("config_facturacion.php", send, function () { });
            alertify.alert(respuesta);
            return false;
        }
    } else {
        $("#pagado").val("");
        alertify.alert(tramaError /* + ". Es posible que el lector de banda magn&eacute;tica no este funcionando correctamente."*/);
        return false;
    }
}

function fn_abreCajon() {
    //    var tipoServicio = $("#txtTipoServicio").val();
    //    if (tipoServicio === "2") {
    //        send = {"EstadoAbrirCajon": 1};
    //        send.op_id = $("#txtOrdenPedidoId").val();
    //        $.getJSON("config_facturacion.php", send, function (datos)
    //        {
    //            if (datos[0]["respuesta"] === "0") {
    //                
    //                        send = {"insertaCanalAperturaCajon": 1};
    //                        send.banderaCajon = $("#txtNumFactura").val();
    //                        $.getJSON("config_facturacion.php", send, function (datos)
    //                        {
    //                        });
    //            }
    //        });
    //
    //    } else {
<<<<<<< HEAD
    send = { insertaCanalAperturaCajon: 1 };
=======
    send = {"insertaCanalAperturaCajon": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.banderaCajon = $("#txtNumFactura").val();
    $.getJSON("config_facturacion.php", send, function (datos) { });
    //}
}

/////////////////////////ACTUALIZAR FACTURA CLIENTE///////////////////////////////	
function fn_actualizarFactura() {
<<<<<<< HEAD
    send = { actualizarFactura: 1 };
=======
    send = {"actualizarFactura": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cliente_id = $("#txtClienteCI").val();
    send.codFactura = $("#txtNumFactura").val();
    $.ajax({
        async: false,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str == 0) {
                alertify.alert("Error al registrar la factura");
            }
        }
    });
}

/////////////////////////CREAR FACTURA XML////////////////////////////////////////	
function fn_crearFacturaXml() {
    $.post("../xml/anexo_xml.php", {txtNumFactura: $("#txtNumFactura").val()});
    //alert("fn_crearFacturaXml");
}


function fn_direccionaMesasUorden(tipoDeServicio, idOrden) {
    var send;
    if (tipoDeServicio == 2) {

        var txtNumMesa = $("#txtNumMesa").val();
        var txtOrdenPedidoId = $("#txtOrdenPedidoId").val();
        var tipoImpuesto = $("#tipoImpuesto").val();
<<<<<<< HEAD
        send = { validaItemPagado: 1 };
=======
        send = {"validaItemPagado": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.odp_id = idOrden;
        $.ajax({
            async: false,
            url: "config_facturacion.php",
            data: send,
            dataType: "json",
            success: function (datos) {

                if (datos.str > 0) {
<<<<<<< HEAD
                    send1 = { obtenerurlsplit: 1 };
=======
                    send1 = {"obtenerurlsplit": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                    send1.mesa_id = $("#txtNumMesa").val();
                    send1.odp_id = $("#txtOrdenPedidoId").val();
                    $.ajax({
                        async: false,
                        type: "GET",
                        dataType: "json",
                        contentType: "application/x-www-form-urlencoded",
                        url: "config_facturacion.php",
                        data: send1,
                        success: function (datos) {
                            if (datos.str > 0) {
                                window.location.replace(".." + datos[0]["url_cuenta"]);
                            }
                        }
                    });
                    //  window.location.replace("../ordenpedido/separarCuentas.php?mesa_id=" + txtNumMesa + "&odp_id=" + txtOrdenPedidoId + "&cdn_tipoimpuesto=incluido&est_ip=::1");
                } else {
                    var mesa_id = $("#txtNumMesa").val();

                    if (mesa_id) {
<<<<<<< HEAD
                        send = { obtenerDatosRegresar: 1 };
=======
                        send = {"obtenerDatosRegresar": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                        send.mesa_id = mesa_id;
                        $.ajax({
                            async: false,
                            type: "GET",
                            dataType: "json",
                            contentType: "application/x-www-form-urlencoded",
                            url: "../ordenpedido/config_ordenPedido.php",
                            data: send,
                            success: function (datos) {
                                if (datos.str > 0) {
                                    // aux = "?IDPisos=" + datos[0]["IDPisos"] + "&IDAreaPiso=" + datos[0]["IDAreaPiso"];
                                    window.location.href = datos[0]["url"];
                                }
                            }
                        });
                    } else {
                        window.location.replace("../ordenpedido/userMesas.php");
                    }
                }
            }
        });
    } else {
<<<<<<< HEAD
        send = { validaItemPagado: 1 };
=======
        send = {"validaItemPagado": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.odp_id = idOrden;
        $.ajax({
            async: false,
            url: "config_facturacion.php",
            data: send,
            dataType: "json",
            success: function (datos) {


                if (datos.str > 0) {
<<<<<<< HEAD
                    send1 = { obtenerurlsplit: 1 };
=======
                    send1 = {"obtenerurlsplit": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                    send1.mesa_id = $("#txtNumMesa").val();
                    send1.odp_id = $("#txtOrdenPedidoId").val();
                    $.ajax({
                        async: false,
                        type: "GET",
                        dataType: "json",
                        contentType: "application/x-www-form-urlencoded",
                        url: "config_facturacion.php",
                        data: send1,
                        success: function (datos) {
                            if (datos.str > 0) {
                                window.location.replace(".." + datos[0]["url_cuenta"]);
                            }
                        }
                    });
                    //  window.location.replace("../ordenpedido/separarCuentas.php?mesa_id=" + txtNumMesa + "&odp_id=" + txtOrdenPedidoId + "&cdn_tipoimpuesto=incluido&est_ip=::1");
                } else {
                    fn_obtenerMesa();
                }
                //                if (datos.str > 0) {
                //                    window.location.replace("../ordenpedido/separarCuentas.php?mesa_id=" + txtNumMesa + "&odp_id=" + txtOrdenPedidoId + "&cdn_tipoimpuesto=" + tipoImpuesto);
                //                } else {
                //                    fn_obtenerMesa();
                //                }
            }
        });
    }
}


function fn_direccionaMesasUordenExecute(tipoDeServicio, idOrden) {
    var send;
    if (tipoDeServicio == 2) {

        var txtNumMesa = $("#txtNumMesa").val();
        var txtOrdenPedidoId = $("#txtOrdenPedidoId").val();
        var tipoImpuesto = $("#tipoImpuesto").val();
<<<<<<< HEAD
        send = { validaItemPagado: 1 };
=======
        send = {"validaItemPagado": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.odp_id = idOrden;
        $.ajax({
            async: false,
            url: "config_facturacion.php",
            data: send,
            dataType: "json",
            success: function (datos) {
                if (datos.str > 0) {
<<<<<<< HEAD
                    send1 = { obtenerurlsplit: 1 };
=======
                    send1 = {"obtenerurlsplit": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                    send1.mesa_id = $("#txtNumMesa").val();
                    send1.odp_id = $("#txtOrdenPedidoId").val();
                    $.ajax({
                        async: false,
                        type: "GET",
                        dataType: "json",
                        contentType: "application/x-www-form-urlencoded",
                        url: "config_facturacion.php",
                        data: send1,
                        success: function (datos) {
                            if (datos.str > 0) {
                                window.location.replace(".." + datos[0]["url_cuenta"]);
                            }
                        }
                    });
                    //  window.location.replace("../ordenpedido/separarCuentas.php?mesa_id=" + txtNumMesa + "&odp_id=" + txtOrdenPedidoId + "&cdn_tipoimpuesto=incluido&est_ip=::1");
                } else {
                    var mesa_id = $("#txtNumMesa").val();

                    if (mesa_id) {
<<<<<<< HEAD
                        send = { obtenerDatosRegresar: 1 };
=======
                        send = {"obtenerDatosRegresar": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                        send.mesa_id = mesa_id;
                        $.ajax({
                            async: false,
                            type: "GET",
                            dataType: "json",
                            contentType: "application/x-www-form-urlencoded",
                            url: "../ordenpedido/config_ordenPedido.php",
                            data: send,
                            success: function (datos) {
                                if (datos.str > 0) {
                                    //aux = "?IDPisos=" + datos[0]["IDPisos"] + "&IDAreaPiso=" + datos[0]["IDAreaPiso"];
                                    // window.location.href = "../ordenpedido/userMesas.php" + aux;
                                    window.location.href = datos[0]["url"];
                                }
                            }
                        });
                    } else {
                        window.location.replace("../ordenpedido/userMesas.php");
                    }
                }
            }
        });
    } else {
<<<<<<< HEAD
        send = { validaItemPagado: 1 };
=======
        send = {"validaItemPagado": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.odp_id = idOrden;
        $.ajax({
            async: false,
            url: "config_facturacion.php",
            data: send,
            dataType: "json",
            success: function (datos) {
                if (datos.str > 0) {
                    window.location.replace("../ordenpedido/separarCuentas.php?mesa_id=" + txtNumMesa + "&odp_id=" + txtOrdenPedidoId + "&cdn_tipoimpuesto=" + tipoImpuesto);
                } else {
                    fn_obtenerMesa();
                }
            }
        });
    }
}


//////////////////////////DIVISION CUENTAS////////////////////////////////////////
function fn_validaItemPagado() {
    var send;
    var txtOrdenPedidoId = $("#txtOrdenPedidoId").val();
    var txtTipoServicio = $("#txtTipoServicio").val();
    if (txtTipoServicio == 2) {
<<<<<<< HEAD
        send = { valida_tipo_facturacion: 1 };
=======
        send = {"valida_tipo_facturacion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            url: "config_facturacion.php",
            data: send,
            success: function (datos) {
                facturacion = datos.rst_tipo_facturacion;

                if (facturacion == 1) {
                    //alert("fact electronica");
                    cargando(0);
                    fn_timeout2();
                    //fn_esperaXMLfirmado();
                } //fin de facturacion electronica
                if (facturacion == 2) { //alert("fact preimpresa");							
                    cfac_idd = $("#txtNumFactura").val();
<<<<<<< HEAD
                    send = { grabacanalmovimientoImpresionFactura: 1 };
=======
                    send = {"grabacanalmovimientoImpresionFactura": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                    send.idfactura = cfac_idd;
                    $.ajax({
                        async: false,
                        type: "GET",
                        dataType: "json",
                        contentType: "application/x-www-form-urlencoded",
                        url: "config_facturacion.php",
                        data: send,
                        success: function (datos) {
                            fn_direccionaMesasUorden(txtTipoServicio, txtOrdenPedidoId);

                        }
                    });
                } //fin de facturacion preimpresa
                if (facturacion == 4) {
<<<<<<< HEAD
                    send = { claveAcceso: 1 };
=======
                    send = {"claveAcceso": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                    send.factt = $("#txtNumFactura").val();
                    send.char = "F";
                    $.getJSON("config_facturacion.php", send, function (datos) {
                        facturita = $("#txtNumFactura").val();
<<<<<<< HEAD
                        send = { actualizaFacturacion: 1 };
=======
                        send = {"actualizaFacturacion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                        send.nuFactu = $("#txtNumFactura").val();
                        $.getJSON("config_facturacion.php", send, function (datos) {
                            fn_direccionaMesasUorden(txtTipoServicio, txtOrdenPedidoId);
<<<<<<< HEAD
                            send = { validaItemPagado: 1 };
=======
                            send = {"validaItemPagado": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                            send.odp_id = txtOrdenPedidoId;
                        });
                    });
                } //fin facturacion Plan Market
                if (facturacion == 3) {
<<<<<<< HEAD
                    send = { claveAcceso: 1 };
                    send.factt = $("#txtNumFactura").val();
                    send.char = "F";
                    $.getJSON("config_facturacion.php", send, function(datos) {
                        send = { grabacanalmovimientoImpresionFacturaElectronica: 1 };
=======
                    send = {"claveAcceso": 1};
                    send.factt = $("#txtNumFactura").val();
                    send.char = "F";
                    $.getJSON("config_facturacion.php", send, function (datos) {

                        send = {"grabacanalmovimientoImpresionFacturaElectronica": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                        send.idfactura = $("#txtNumFactura").val();
                        $.getJSON("config_facturacion.php", send, function (datos) {
                            fn_direccionaMesasUorden(txtTipoServicio, txtOrdenPedidoId);
                        });
                    });
                } //fin de facturacion en contingencia
            }
        });
    } else if (txtTipoServicio == 1) {
<<<<<<< HEAD
        send = { valida_tipo_facturacion: 1 };
=======
        send = {"valida_tipo_facturacion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        $.ajax({
            async: false,
            type: "GET",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            url: "config_facturacion.php",
            data: send,
            success: function (datos) {
                facturacion = datos.rst_tipo_facturacion;
                if (facturacion == 1) {
                    cargando(0);
                    fn_timeout2();
                }
                if (facturacion == 2) {
                    cfac_idd = $("#txtNumFactura").val();
<<<<<<< HEAD
                    send = { grabacanalmovimientoImpresionFactura: 1 };
=======
                    send = {"grabacanalmovimientoImpresionFactura": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                    send.idfactura = cfac_idd;
                    $.ajax({
                        async: false,
                        type: "GET",
                        dataType: "json",
                        contentType: "application/x-www-form-urlencoded",
                        url: "config_facturacion.php",
                        data: send,
                        success: function (datos) {
                            fn_direccionaMesasUorden(txtTipoServicio, txtOrdenPedidoId);
                        }
                    });
                }
                //inicio facturacion tipo plan market
                if (facturacion == 4) {
<<<<<<< HEAD
                    send = { claveAcceso: 1 };
=======
                    send = {"claveAcceso": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                    send.factt = $("#txtNumFactura").val();
                    send.char = "F";
                    $.getJSON("config_facturacion.php", send, function (datos) {
                        facturita = $("#txtNumFactura").val();
<<<<<<< HEAD
                        send = { actualizaFacturacion: 1 };
=======
                        send = {"actualizaFacturacion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                        send.nuFactu = $("#txtNumFactura").val();
                        $.getJSON("config_facturacion.php", send, function (datos) {
                            fn_direccionaMesasUorden(txtTipoServicio, txtOrdenPedidoId);
                        });
                    });
                } //fin facturacion Plan Market
                if (facturacion == 3) {
<<<<<<< HEAD
                    send = { claveAcceso: 1 };
                    send.factt = $("#txtNumFactura").val();
                    send.char = "F";
                    $.getJSON("config_facturacion.php", send, function(datos) {
                        send = { grabacanalmovimientoImpresionFacturaElectronica: 1 };
=======
                    send = {"claveAcceso": 1};
                    send.factt = $("#txtNumFactura").val();
                    send.char = "F";
                    $.getJSON("config_facturacion.php", send, function (datos) {
                        send = {"grabacanalmovimientoImpresionFacturaElectronica": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                        send.idfactura = $("#txtNumFactura").val();
                        $.getJSON("config_facturacion.php", send, function (datos) {
                            fn_direccionaMesasUorden(txtTipoServicio, txtOrdenPedidoId);
                        });
                    });
                } //fin de facturacion en contingencia
            }
        });
    } //fin de tipo de servicio=1
    else {
        alertify.error("No existe configuracion del tipo de servicio.");
        return false;
    }
}

///////////////////////////////////////////REDIRECCIONAR PAGINA///////////////////////////////
function redireccionar(pagina) {
    location.href = pagina;
}

//////////////////////////////////////////IMPRIMIR FACTURA////////////////////////////////////
function fn_printFactura() {
    if ($("#txtClienteFono").val() != "") {
        if (
            $("#txtClienteFono").val().length < 7 ||
            $("#txtClienteFono").val().length > 10
        ) {
            alertify.alert("Ingrese un numero de telefono correcto.");
            return false;
        }
    }
    var btnCambio = $("#btnAplicarPago").attr("title");
    var cambio = parseFloat($("#hid_cambio").val()).toFixed(2);
    cambio = (cambio * -1).toFixed(2);
    cambio = parseFloat(cambio).toFixed(2);
    if ($("#btnFormaPagoId").val() == 5) {
<<<<<<< HEAD
        send = { ingresaCanalMovimientoCredito: 1 };
=======
        send = {"ingresaCanalMovimientoCredito": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.FactCreditoCanal = $("#txtNumFactura").val();
        $.getJSON("config_facturacion.php", send, function (datos) { });
    }

    /* Plug Them : Aplica encuesta */
    var conDatos = $("#hid_conDatos").val();
    if (conDatos == 1) {
        validaLoginPlugThem();
    } else {
        fn_actualizarFactura();
        //fn_crearFacturaXml(); mc

        // fidelizacion: si es si el plan de datos  no imprimir aun (el campo fdznDocumento contendra una cedula cuando se trate de fdzn activa)
        if (
            $("#fdznDocumento").val() === "0" ||
            $("#fdznDocumento").val() === "" ||
            $("#fdznDocumento").val() === undefined
        ) {
            fn_validaItemPagado();
        } else {
            fn_obtenerMesa();
        }
    }
}

//////funcion para imprimir la orden del pedido
function fn_imprimirOrden() {
<<<<<<< HEAD
    var send = { imprimirOrden: 1 };
    send.odpOrden = $("#txtOrdenPedidoId").val();
    send.dop_id = $("#txtNumCuenta").val();
    $.getJSON("config_facturacion.php", send, function(datos) {});
}

function fn_reimprimirOrdenKiosko() {
    send = { reimprimirOrden: 1 };
    send.odpOrden = $("#txtOrdenPedidoId").val();
    send.dop_id = $("#txtNumCuenta").val();
    $.getJSON("config_facturacion.php", send, function(datos) {});
=======

    send = {"imprimirOrden": 1};
    send.odpOrden = $("#txtOrdenPedidoId").val();
    send.dop_id = $('#txtNumCuenta').val();
    $.getJSON("config_facturacion.php", send, function (datos) { });
}

function fn_reimprimirOrdenKiosko() {
    send = {"reimprimirOrden": 1};
    send.odpOrden = $("#txtOrdenPedidoId").val();
    send.dop_id = $('#txtNumCuenta').val();
    $.getJSON("config_facturacion.php", send, function (datos) { });
>>>>>>> origin/MXP_Version_1.9.10.6
}


//////////////////////////////////////////IMPRIMIR FACTURA////////////////////////////////////
function fn_envioFactura() {
    if ($("#hide_reimpresionKiosko").val() == 1) {
        fn_reimprimirOrdenKiosko();
    }
    fn_imprimirOrden();
    fn_abreCajon();
    fn_bloquearIngreso();
    $("#btnClienteModificar").hide();
    $("#btnFacturaImprimir").hide();
    fn_validaCuadreFormaPago();
    status_cupon ? fn_validaCuponesAutoConsumo() : "";
}

function fn_validaCuponesAutoConsumo() {
<<<<<<< HEAD
    send = { autoConsumoCupon: 1 };
    send.IDCabeceraOrdenPedido = $("#txtOrdenPedidoId").val();
=======
    send = {"autoConsumoCupon": 1};
    send.IDCabeceraOrdenPedido = $('#txtOrdenPedidoId').val();
>>>>>>> origin/MXP_Version_1.9.10.6
    send.dop_cuenta = $("#txtNumCuenta").val() ? $("#txtNumCuenta").val() : 1;
    send.status_cupon = status_cupon;
    send.status_pago = status_pago;
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_facturacion.php",
        data: send,
        success: function (datos) {
            alertify.success("La factura Autoconsumo se creó éxitosamente.");
        }
    });
}

/*funcion que valida que cuadren los valores de formas de pago contra el total de la factura*/
function fn_validaCuadreFormaPago() {
<<<<<<< HEAD
    send = { validaCuadreFormasPago: 1 };
=======
    send = {"validaCuadreFormasPago": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.facturaAvalidar = $("#txtNumFactura").val();
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_facturacion.php",
        data: send,
        success: function (datos) {
            if (datos.str > 0) {
                if (datos.diferencia == 0) {
                    fn_cargaTeclasEmail();
                    $("#btnAplicarPago").removeAttr("disabled");

                    $("#datosFactura").dialog({
                        title: "INFORMACION FISCAL S.R.I.",
                        modal: true,
                        position: "center",
                        closeOnEscape: false,
                        width: 1000,
                        height: 810,
                        show: "blind",
                        resizable: "false"
                    });

<<<<<<< HEAD
                    if ($("#hide_turneroActivo").val() == "1" &&  $("#hide_turneroHabilitadoPorEstacion").val() == "1") {
=======
                    if ($("#hide_turneroActivo").val() == '1' && $("#hide_turneroHabilitadoPorEstacion").val() == "1") {
>>>>>>> origin/MXP_Version_1.9.10.6
                        // 1-> politica activado
                        var txtNumFactura = $("#txtNumFactura").val();
                        var lc_send = new Object();
                        lc_send["turneroAccion"] = "agregarTurno";
                        lc_send["turneroURl"] = $("#hide_turneroURl").val();
                        lc_send["transaccion"] = txtNumFactura;
                        lc_send["estado"] = "Preparando";
                        lc_send["orden"] = txtNumFactura.slice(-2);
                        lc_send["cliente"] = "";
                        lc_send["clienteDocumento"] = "";
                        lc_send["tipo"] = "LOCAL";
                        $.ajax({
                            async: true,
                            type: "POST",
                            dataType: "text",
                            contentType: "application/x-www-form-urlencoded",
                            url: "wsTurnero.php",
                            data: lc_send,
                            success: function (datos) {
                                console.log(datos);
                            }
                        });
                    }
                    if (
                        $("#fdznDocumento").val() !== "0" &&
                        $("#hide_fidelizacionActiva").val() === "1" &&
                        $("#fdznDocumento").val() !== ""
                    ) {
                        //alertify.error("Su cambio es de $" + $("#valorCambio").val());
                        $("#txtClienteCI").val($("#fdznDocumento").val());
                        setTimeout(function() {
                            cerrar(); // Cierra modal..
                        }, 100);
                        setTimeout(function() {
                            continuar(); // esperar 1 segundo para que pueda ver el cambio.
                        }, 100);
                    }

<<<<<<< HEAD
                    if (
                        $("#fdznDocumento").val() !== "0" &&
                        $("#hide_fidelizacionActiva").val() === "1" &&
                        $("#hidNumeroDocumentoVitality").val() !== "0" &&
                        $("#hidVitality").val() === "1" &&
                        $("#fdznDocumento").val() !== ""
                    ) {
                        alertify.error("Su cambio es de: " + $("#valorCambio").val());
                        $("#txtClienteCI").val($("#hidNumeroDocumentoVitality").val());
                        setTimeout(function() {
=======


                      
                    if ($("#txtDocumentoClientePaypone").val() !== "") {

                        $("#txtClienteCI").val($("#txtDocumentoClientePaypone").val());

                        setTimeout(function () {
                            cerrar(); // Cierra modal..
                        }, 100);
                        setTimeout(function () {

                            continuar(); // esperar 1 segundo para que pueda ver el cambio.

                        }, 100);

                    }


                    // if (localStorage.getItem("ls_documento") !== null) {

                    //     // $("#txtClienteCI").val(localStorage.getItem("ls_documento"));mc10
                    //     // $("#txtClienteNombre").val(localStorage.getItem("ls_nombres"));
                    //     // $("#txtClienteDireccion").val(localStorage.getItem("pay_txtDireccion"));
                    //     // $("#txtClienteFono").val(localStorage.getItem("ls_telefono"));
                    //     // $("#txtCorreo").val(localStorage.getItem("ls_correo"));

                    //     setTimeout(function () {
                    //         cerrar(); // Cierra modal..
                    //     }, 100);
                    //     setTimeout(function () {
                    //         continuarPayPhone();
                    //     }, 100);

                    // }

                    if ($("#fdznDocumento").val() !== "0" && $("#hide_fidelizacionActiva").val() === "1") { //
                        alertify.error("Su cambio es de: " + $("#valorCambio").val());
                        setTimeout(function () {
>>>>>>> origin/MXP_Version_1.9.10.6
                            cerrar(); // Cierra modal..
                        }, 100);
                        setTimeout(function () {
                            continuar(); // esperar 1 segundo para que pueda ver el cambio.
                        }, 100);
                    } else if ($("#hide_ordenKiosko").val() === "1") {
                        validarVentaKiosko();
                    }


                    $(".jb-shortscroll-wrapper").hide();
                    $("#aumentarContador").dialog("open");
                    fn_numerico(txtClienteCI);
                } else {
                    alertify.error(datos.mensaje);
                    return false;
                }
            } else {
                alertify.error("ERROR AL VALIDAR CUADRE DE VALORES DE LA FACTURA.");
                return false;
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
            alert(jqXHR);
            alert(textStatus);
            alert(errorThrown);
        }
    });
}

/////////////////////////////VALIDACION DE NUMEROS/////////////////////////////////	
function validarNumeros(e) {
    tecla = document.all ? e.keyCode : e.which; // 2
    if (tecla == 8)
        return true; // backspace
    if (tecla == 109)
        return true; // menos
    if (tecla == 110)
        return true; // punto
    if (tecla == 189)
        return true; // guion
    if (e.ctrlKey && tecla == 86) {
<<<<<<< HEAD
        return true;
    } //Ctrl v
    if (e.ctrlKey && tecla == 67) {
        return true;
    } //Ctrl c
    if (e.ctrlKey && tecla == 88) {
        return true;
    } //Ctrl x
=======
        return true
    }
    ; //Ctrl v
    if (e.ctrlKey && tecla == 67) {
        return true
    }
    ; //Ctrl c
    if (e.ctrlKey && tecla == 88) {
        return true
    }
    ; //Ctrl x
>>>>>>> origin/MXP_Version_1.9.10.6
    if (tecla >= 96 && tecla <= 105) {
        return true;
    } //numpad


    patron = /[0-9]/; // patron

    te = String.fromCharCode(tecla);
    return patron.test(te); // prueba
}

/////////////////////////////VALIDACION DE LETRAS/////////////////////////////////
function soloLetras(e) {
    key = e.keyCode || e.which;
    tecla = String.fromCharCode(key).toLowerCase();
    letras = " áéíóúabcdefghijklmnñopqrstuvwxyz";
    especiales = [8, 37, 39, 46];
    tecla_especial = false;

    for (var i in especiales) {
        if (key == especiales[i]) {
            tecla_especial = true;
            break;
        }
    }
    if (letras.indexOf(tecla) == -1 && !tecla_especial) {
        return false;
    }
}

/////////////////////////////CAMBIO A MAYUSCULAS/////////////////////////////////
function aMays(e, elemento) {
    tecla = document.all ? e.keyCode : e.which;
    elemento.value = elemento.value.toUpperCase();
}

/////////////////////////////BUSCAR CLIENTES/////////////////////////////////
function fn_consultarCliente() {
    $("#txtClienteCI").autocomplete({
        source: "config_facturacion.php?autoCompletar",
        minLength: 2,
        select: function (event, ui) {
            $("#txtClienteCI").focus();
            $(".ui-helper-hidden-accessible").hide();
        },
        create: function (event, ui) { }
    });
}

/////////////////////////////BILLETES/////////////////////////////////
function fn_billete(billete, descEf, idFp, idTfp, desTfp, autoriza) {
    $("#can_sumar").val(billete);
    $(".desabilitado").attr("Disabled", true);
    //fn_sumarBillete();
    var cant = $("#pagado").val();
    if (cant == "") {
        cant = 0;
    }
    var valor = parseInt(cant) + billete;
    $("#pagado").val(valor.toFixed(2));
    coma = 1;

    fn_botonPago(descEf, idFp, idTfp, autoriza, desTfp);
}

/////////////////////////////BILLETES/////////////////////////////////
function fn_centavo(centavo) {
    var cant = $("#pagado").val();
    if (cant == "") {
        cant = 0;
    }
    var valor = parseFloat(cant) + centavo / 100;
    $("#pagado").val(valor.toFixed(2));
}


function obtenerDatosEnvioPuntos(accion) {
<<<<<<< HEAD
    var send = { obtenerDatosEnvioPuntos: 1 };
=======
    var send = {"obtenerDatosEnvioPuntos": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.accion = accion;
    send.cfac_id = $("#txtNumFactura").val();
    send.cedulaCliente = $("#fdznDocumento").val();


    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_facturacion.php",
        data: send,
<<<<<<< HEAD
        success: function(datos) {
=======
        success: function (datos) {

>>>>>>> origin/MXP_Version_1.9.10.6
            if (datos !== undefined) {
                if (accion === 1) {
                    RESPONSE_JSON = datos;
                }
                if (accion === 2) {

                    RESPONSE_JSON2 = datos;
                }
                if (accion === 3) {
                    RESPONSE_JSON3 = datos;
                }

            } else {

            }

        }
    });
}

var EstadoRedimension = 0;

function ExecuteAutoconsumo(cfac_id, rst_id, secuencial, documentoCli) {
    var totalPuntosCanjeados = 0;
    for (var i = 0; i < RESPONSE_JSON2.length; i++) {
        totalPuntosCanjeados += RESPONSE_JSON2[i].points * RESPONSE_JSON2[i].amount;
    }
    EstadoRedimension = 0;
<<<<<<< HEAD
    var send = { Autoconsumo: 1 };
=======
    var send = {"Autoconsumo": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfac_id = cfac_id;
    send.rst_id = rst_id;
    send.secuencial = secuencial;
    send.documentoCliente = documentoCli;
    send.nombreCliente = $("#fdznNombre").val();
    send.puntosCanjeados = totalPuntosCanjeados;
    send.marketingCost = marketingCost;
    send.storeCost = storeCost;
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_facturacion.php",
        data: send,
        success: function (datos) {
            if (datos.str > 0) {
                EstadoRedimension = datos[0]["estadoFacturacion"];
            } else {
            }
        }
    });
}

var EstadoCanjePuntos = -1;

function RegistroCanjePuntos(JSON_DATA) {
    EstadoRedimension = 0;

    var send = { RegistroCanjePuntos: 1 };
    send.json = JSON.stringify(JSON_DATA);
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_facturacion.php",
        data: send,
        success: function (datos) {

            //            if (datos.str > 0) {

            if (datos["message"] === "Canje de puntos realizado exitosamente") {
                EstadoCanjePuntos = 200;
            } else {
                if (datos["message"] === "El código de canje ya ha sido usado.") {
                    EstadoCanjePuntos = 1616;

                } else {
                    EstadoCanjePuntos = -1;
                    alertify.error(datos["message"]);
                }


            }
            if (datos["code"] == 200) {
                console.info(datos);
                EstadoCanjePuntos = datos["code"];
                marketingCost = datos["data"]["marketingCost"];
                storeCost = datos["data"]["storeCost"];
                redemptionCode = datos["redemptionCode"];
            } else {
                console.error(datos);
                EstadoCanjePuntos = datos["code"];
                $("alertify-cancel").css("display", "none");
                alertify.confirm(datos["message"], function(e) {
                    if (e) {
                        accionesCanjePuntos(EstadoCanjePuntos);
                    }
                }); //lectura PINPAD si esque activa la opcion
            }
            fn_cargando(0);
        },
        error: function() {
            $("#mdl_rdn_pdd_crgnd").hide();
            alertify.alert("Servicio no disponibles, por favor intentelo más tarde.");
        }

    });
}
    var accionesCanjePuntos = function(value) {
        switch (value) {
            case 10001212:
                $("#inputCodigoSeguridad").val("");
                $("#cntSeguridadCliente").show();
                $("#inputCodigoSeguridad").focus();
                break;
            default:
                break;
        }
    };

function cambiarCodigoSeguridad() {
    var cc = separarCedulaCodigo($("#inputCodigoSeguridad").val());
    var cedula = cc[0];
    var codigo = cc[1];
    if (validarCodigoSeguridad(codigo)) {
        $("#cntSeguridadCliente").hide();
        fn_cargando(1);
        var send = { actualizarCodigoSeguridadCliente: 1 };
        send.codigo = codigo;
        $.ajax({
            async: false,
            type: "POST",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            url: "config_facturacion.php",
            data: send,
            success: function(datos) {
                //Canjear puntos
                $("#inputCodigoSeguridad").val("");
                if (procesoFidelizacion == "") {
                    canjePuntos();
                } else {
                    consumirRecargaEfectivo();
                }
            }
        });
    } else {
        $("#inputCodigoSeguridad").val("");
    }
}

function darFocoCodigoSeguridad() {
    $("#inputCodigoSeguridad").val("");
    $("#inputCodigoSeguridad").focus();
}

function cerrarModalCodigoSeguridad() {
    $("#inputCodigoSeguridad").val("");
    $("#cntSeguridadCliente").hide();
    fn_cargando(0);
}

function canjePuntos() {


    if ($("#btnAplicarPago").attr("title") === "FIDELIZACION") {
        //   ($("#mdl_rdn_pdd_crgnd").show();

        if ($("#listaFactura_canje_puntos").html() !== null) {

            obtenerDatosEnvioPuntos(1);
            obtenerDatosEnvioPuntos(2);
            obtenerDatosEnvioPuntos(3);

            var JSON_Array = {
                storeId: RESPONSE_JSON[0].storeId,
                storeCode: RESPONSE_JSON[0].storeCode,
                vendorId: RESPONSE_JSON[0].vendedorId,
                redemptionCode: RESPONSE_JSON[0].redemptionCode,
                products: RESPONSE_JSON2,
                customer: {
                    documentType: RESPONSE_JSON3[0].documentType,
                    document: RESPONSE_JSON3[0].document
                }
            };
            
            RegistroCanjePuntos(JSON_Array);

            // alert(EstadoCanjePuntos);
            if (EstadoCanjePuntos === 1616) {
                alertify.confirm("El código de canje ya ha sido usado. ¿Desea reenviar solo la factura?");
                $("#alertify-cancel").html("No");
                $("#alertify-ok").html("Si");

                $("#alertify-ok").click(function () {
                    reenviarFactura(200);
                });
            }


            if (EstadoCanjePuntos == 200) {
                //Oculto el boton de redimir.
<<<<<<< HEAD
                $("#tablaFormasPago tr td").each(function() {
                    if (
                        $(this)
                        .find("button")
                        .attr("title") === "FIDELIZACION"
                    ) {
=======
                $("#tablaFormasPago tr td").each(function () {
                    if (($(this).find("button").attr("title") === "FIDELIZACION")) {
>>>>>>> origin/MXP_Version_1.9.10.6
                        $(this).find("button").css("display", "none");
                    }
                });

                // Enviar JSON_Array y esperar respuesta ok si es ok ejecutar. 
                ExecuteAutoconsumo($("#txtNumFactura").val(), $("#txtRestaurante").val(), redemptionCode, RESPONSE_JSON3[0].document);
                if (EstadoRedimension === 1) {
                    lc_autorizacion = 0;
                    $("#hid_descTipoFp").val("EFECTIVO");

                    $("#listaFactura_canje_puntos").hide(500);
                    $("#listaFactura_canje_puntos").html(null);
                    $("#mdl_rdn_pdd_crgnd").hide();

                    $("#btnAplicarPago").html("<b>Aplicar <br>EFECTIVO</b>");
                    $("#btnAplicarPago").attr("title", "EFECTIVO");
                    $("#btnCancelarPago").html("<b>Cancelar <br>EFECTIVO</b>");
                    $("#btnCancelarPago").attr("title", "EFECTIVO");
                    $("#hid_descFp").val("EFECTIVO");
                    $("#btnFormaPagoId").val(lc_idefectivo);
                    alertify.alert("Puntos canjeados exitosamente.");


                    if ($("#listaFactura> li").html() === null) {

                        $("#alertify-cancel").hide();
                        $("#alertify-ok").click(function () {
                            fn_inicio();
                        });

                        //                        setTimeout(function () {
                        //                            fn_inicio(); // esperar 1 segundo para que pueda ver el cambio.
                        //                        }, 2000);

                    }


                } else {
                    alertify.error("Ocurrió un problema al redimir los puntos.");
                }
            } else {
                alertify.error("Lo sentimos, no puede canjear sus puntos. El servicio no se encuentra disponible.");
                // alertify.error("Ocurrió un problema al canjear los putnos.");
                // si ocurre un  problem volver a efectivo. 
                $("#hid_descTipoFp").val("EFECTIVO");
                $("#btnAplicarPago").html("<b>Aplicar <br>EFECTIVO</b>");
                $("#btnAplicarPago").attr("title", "EFECTIVO");
                $("#btnCancelarPago").html("<b>Cancelar <br>EFECTIVO</b>");
                $("#btnCancelarPago").attr("title", "EFECTIVO");
                $("#hid_descFp").val("EFECTIVO");
                $("#btnFormaPagoId").val(lc_idefectivo);
            }

        } else {
            alertify.error("No hay puntos a canjear");
        }
        // $("#mdl_rdn_pdd_crgnd").hide();
    } else {
        if (
            $("#listaFactura_canje_puntos").html() === null ||
            $("#listaFactura_canje_puntos").html() === ""
        ) {
            $("#txtClienteCI").val($("#fdznDocumento").val()); //
            fn_aplicaPagoSegunTipo();
        } else {
            alertify.error("Primero redima los productos con puntos. ");
        }
        fn_cargando(0);
    }
}


function reenviarFactura(EstadoCanjePuntos) {
    fn_cargando(1);

    if (EstadoCanjePuntos === 200) {

        //Oculto el boton de redimir.
<<<<<<< HEAD
        $("#tablaFormasPago tr td").each(function() {
            if (
                $(this)
                .find("button")
                .attr("title") === "FIDELIZACION"
            ) {
=======
        $("#tablaFormasPago tr td").each(function () {
            if (($(this).find("button").attr("title") === "FIDELIZACION")) {
>>>>>>> origin/MXP_Version_1.9.10.6
                $(this).find("button").css("display", "none");
            }
        });
        // Enviar JSON_Array y esperar respuesta ok si es ok ejecutar. 
        ExecuteAutoconsumo($("#txtNumFactura").val(), $("#txtRestaurante").val(), RESPONSE_JSON[0].redemptionCode, RESPONSE_JSON3[0].document);
        if (EstadoRedimension === 1) {
            lc_autorizacion = 0;
            $("#hid_descTipoFp").val("EFECTIVO");
            $("#listaFactura_canje_puntos").hide(500);
            $("#listaFactura_canje_puntos").html(null);
            $("#mdl_rdn_pdd_crgnd").hide();
            $("#btnAplicarPago").html("<b>Aplicar <br>EFECTIVO</b>");
            $("#btnAplicarPago").attr("title", "EFECTIVO");
            $("#btnCancelarPago").html("<b>Cancelar <br>EFECTIVO</b>");
            $("#btnCancelarPago").attr("title", "EFECTIVO");
            alertify.alert("Puntos canjeados exitosamente.");
            if ($("#listaFactura> li").html() === null) {
                $("#alertify-cancel").hide();
                $("#alertify-ok").click(function () {
                    fn_inicio();
                });
            }
        } else {
            alertify.error("Ocurrió un problema al redimir los puntos.");
        }
    } else {
        // alertify.error("Ocurrió un problema al canjear los putnos.");
        // si ocurre un  problem volver a efectivo. 
        $("#hid_descTipoFp").val("EFECTIVO");
        $("#btnAplicarPago").html("<b>Aplicar <br>EFECTIVO</b>");
        $("#btnAplicarPago").attr("title", "EFECTIVO");
        $("#btnCancelarPago").html("<b>Cancelar <br>EFECTIVO</b>");
        $("#btnCancelarPago").attr("title", "EFECTIVO");
    }
    fn_cargando(0);
}

function fn_habilitarIngreso() {
    $("#txtClienteNombre").removeAttr("disabled");
    $("#txtClienteDireccion").removeAttr("disabled");
    $("#txtClienteFono").removeAttr("disabled");
    $("#txtCorreo").removeAttr("disabled");
}

function continuar() {

    $("#txtClienteCI").attr("disabled", "true");

    $("#rdo_ruc").hide();
    $("#rdo_pasaporte").hide();

    var btn2 = document.getElementById("btnBuscaCliente");
    if (btn2 !== null) {
        btn2.click();
    }

}

function continuarPayPhone() {


    var btn2 = document.getElementById('btnBuscaCliente');
    if (btn2 !== null) {
        btn2.click();
    }

}
function redireccionar() {
    fn_inicio();
}

function cerrar() { }

function esperar() {
    $("#datosFactura").dialog("close");
}

/////////////////////////////DIFERENCIA/////////////////////////////////
function fn_diferencia(event) {
    if (
        $("#fdznDocumento").val() !== "0" &&
        $("#hide_fidelizacionActiva").val() === "1" &&
        !(
            $("#listaFactura_canje_puntos").html() === null ||
            $("#listaFactura_canje_puntos").html() === ""
        )
    ) {
        fn_cargando(1);
        event.stopPropagation();
        canjePuntos();
        fn_cargando(0);
    } else if ($("#hidVitality").val() === "1") {
        fn_cargando(1);
        event.stopPropagation();
        var NombreClienteAx = $("#hidNombreClienteVitality").val();
        var NDocClienteAx = $("#hidNumeroDocumentoVitality").val();
        var TelfClienteAx = $("#hidPhoneNumberVitality").val();
        var DireccionclienteAx = $("#hidAddressVitality").val();
        fn_PagoCreditoConfigurados(
            NombreClienteAx,
            NDocClienteAx,
            NDocClienteAx,
            TelfClienteAx,
            DireccionclienteAx,
            "",
            "RUC"
        );
        fn_cargando(0);
    } else {
        event.stopPropagation();

        if ($("#pagoGranTotal").val() <= 0) {
            alertify.alert("El valor de la factura no puede ser 0 (cero).");
            return false;
        }

        if (
            $("#td_falta").is(":visible") &&
            parseFloat($("#pagoTotal").val()) == 0
        ) {
            fn_envioFactura();
        } else {
            if ($("#td_cambio").is(":visible")) {
                fn_envioFactura();
            } else {
                if (lc_autorizacion == 1) {
                    lc_banderaOkAdmin = "aplicaPago";
                    fn_abreModalCliente();
                    return false;
                }

                fn_aplicaPagoSegunTipo();
            }
        }
    }
}


    function flujoCredito() {
        fn_cargando(1);
        if ($("#btnAplicarPago").attr("title") === "VITALITY") {
            if ($("#listaFactura").html() !== null) {
                obtenerDatosVitality(1);
                obtenerDatosVitality(2);
                obtenerDatosVitality(3);
                var codigoQRVitality = $("#hidCodigoQRVitality").val();
                var TokenSeguridadVitality = $("#hidTokenSeguridadVitality").val();

                var JSON_VoucherVitality = {
                code: RESPONSE_VJSON[0]["code"],
                storeCode: RESPONSE_VJSON[0]["storeCode"],
                invoiceCode: RESPONSE_VJSON[0]["invoiceCode"],
                summary: {
                    subtotal: RESPONSE_VJSON2[0]["subtotal"],
                    vat: RESPONSE_VJSON2[0]["vat"],
                    vatTaxBase: RESPONSE_VJSON2[0]["vatTaxBase"],
                    vatCalculated: RESPONSE_VJSON2[0]["vatCalculated"],
                    total: RESPONSE_VJSON2[0]["total"]
                    },
                products: []
                };
                RESPONSE_VJSON3.forEach(function(RESPONSE_VJSON3) {
                    JSON_VoucherVitality.products.push({
                    productCode: RESPONSE_VJSON3.productCode,
                    name: RESPONSE_VJSON3.name,
                    unitPrice: RESPONSE_VJSON3.unitPrice,
                    amount: RESPONSE_VJSON3.amount,
                    vat: RESPONSE_VJSON3.vat,
                    vatTaxBase: RESPONSE_VJSON3.vatTaxBase,
                    vatCalculated: RESPONSE_VJSON3.vatCalculated,
                    totalPrice: RESPONSE_VJSON3.totalPrice
                    });
                });

                ventaVitality(codigoQRVitality, TokenSeguridadVitality, JSON_VoucherVitality, RESPONSE_VJSON[0]["invoiceCode"]);
            } else {
                fn_cargando(0);
                alertify.error("No se puede facturar");
            }

        } else {
            fn_cargando(0);
            $("#txtClienteCI").val($("#hidNumeroDocumentoVitality").val());
            fn_aplicaPagoSegunTipo();
        }
    }


function ventaVitality(codigoQRVitality, TokenSeguridadVitality, JSON_VoucherVitality, codigoFactura) {
    var send = {};
    send.metodo = "VoucherTransaccionesVitality";
    send.codigoQRVitality = codigoQRVitality;
    send.TokenSeguridadVitality = TokenSeguridadVitality;
    send.JSON_VoucherVitality = JSON.stringify(JSON_VoucherVitality);
    send.codigoFactura = codigoFactura;
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "../ordenpedido/config_VitalityWS.php",
        data: send,
        success: function(datos) {

            if (datos.httpStatus === 200) {
                fn_cargando(0);
                alertify.alert("Cupón Canjeado con éxito.", function() {
                    alertify.message("OK");
                });
                fn_insertaFormaPagoCreditoSinCupon(cantidadP);
                $("#btnAplicarPago").attr("disabled", "disabled");
            } else if (datos.httpStatus === 404) {
                fn_cargando(0);
                alertify.alert("Existen Problemas de Configuracion. Por favor comunicarse con la mesa de Servicio.", function() {
                        alertify.message("OK");
                    }
                );
            } else {
                fn_cargando(0);
                alertify.alert("Error de canje de cupón, intente más tarde.", function() {
                        alertify.message("OK");
                    }
                );
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error(jqXHR, textStatus, errorThrown);
            fn_cargando(0);
            alertify.error("Servicio no disponible, por favor intentalo más tarde.");
        }
    });
}


function obtenerDatosVitality(accion) {
    var send = { obtenerDatosVitalityFac: 1 };
    send.accion = accion;
    send.codigoQRVitality = $("#hidCodigoQRVitality").val();
    send.cfac_id = $("#txtNumFactura").val();
    send.cedulaCliente = $("#hidNumeroDocumentoVitality").val();
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_facturacion.php",
        data: send,
        success: function(datos) {
            if (datos !== undefined) {
                if (accion === 1) {
                    RESPONSE_VJSON = datos;
                } else if (accion === 2) {
                    RESPONSE_VJSON2 = datos;
                } else if (accion === 3) {
                    RESPONSE_VJSON3 = datos;
                }
            }
        }
    });
}


function eventoClick(paso) {
    if (paso === 1) {
        $("#voucherAE").hide(100);
        $("#seleccionMetodo").show(100);
        $("#infoMdal").val("Seleccione opción automático o manual");
    }
    if (paso === 2) {
        $("#seleccionMetodo").hide(100);
        $("#voucherAE").show(100);
        $("#infoMdal").val("Ingreso Cupón Sistema Gerente");
    }
}

function fn_aplicaPagoSegunTipo() {
    var formaPagoIDSeleccionada = $("#btnFormaPagoId").val();
    var btnNombre = $("#hid_descTipoFp").val();
    var btnNombreFormaPago = $("#hid_descFp").val();
    $(".desabilitado").removeAttr("Disabled");
    $("#visualizarFactura").hide();
    $("#hid_bandera_cvv").val(1);
    var aPagar = parseFloat($("#pagoTotal").val());
    var valoresTotales = "";
    var valoresCambio = "";
    lc_opcionCreditoEmpresa = "";
<<<<<<< HEAD
    var pagado = $("#pagado").val();
    var saldo = $("#hide_saldo").val();
    if ((pagado == "" || pagado == 0) && !(btnNombreFormaPago === "CUPON PREPAGADO")) {
        if (
            btnNombreFormaPago === "CONSUMO RECARGA" &&
            parseFloat(saldo) < aPagar
        ) {
            total = saldo;
        } else {
=======

    if (($("#pagado").val() == "" || $("#pagado").val() == 0) && !(btnNombreFormaPago === "CUPON PREPAGADO")) {
        pagado = $("#pagoTotal").val();
>>>>>>> origin/MXP_Version_1.9.10.6
        total = $("#pagoTotal").val();
        }
        $("#pagado").val(total);
    }
<<<<<<< HEAD
    pagado = parseFloat($("#pagado").val());
=======

    var pagado = parseFloat($("#pagado").val());
>>>>>>> origin/MXP_Version_1.9.10.6
    var valor = aPagar - pagado;
    valor = parseFloat(valor);
    var valorVuelto = Math.abs(valor).toFixed(2);
    $("#espacioCambio span").html("$" + valorVuelto);
    $("#hid_cambio").val(valor);
<<<<<<< HEAD
    var total_factura = $("#valor_total_factura").val();
=======
    var total_factura = $("#pagoGranTotal").val();
>>>>>>> origin/MXP_Version_1.9.10.6

    //Consumo de Recargas
    if (btnNombreFormaPago == "CONSUMO RECARGA") {
        if (saldo >= pagado) {
            fn_cargando(1);
            consumirRecargaEfectivo();
        } else {
            alertify.error("Saldo ($" + saldo + ") insuficiente para realizar esta transacción.");
        }
        return false;
    } else if (btnNombreFormaPago === "CUPON PREPAGADO") {
        //TODO: Mostrar Modal de lectura del Código
        fn_modalCuponMultimarca();
<<<<<<< HEAD
        //TODO: Enviar por ajax el valor de la forma de pago
=======

>>>>>>> origin/MXP_Version_1.9.10.6
        return false;
    }

    if ((valor <= 0 && btnNombre == "EFECTIVO") || (valor <= 0 && btnNombre == "RETENCIONES") || (valor <= 0 && btnNombre == "CHEQUES")) {
        $("#td_cambio").show();
        $("#td_falta").hide();
        var valorCambio = (valor * -1).toFixed(2);
        fn_insertarFormaPago();
        $("#valorCambio").val(valorCambio);
    } else if (
        valor <= 0 &&
        btnNombre != "EFECTIVO" &&
        (valor <= 0 && btnNombre != "CREDITO EMPRESA") &&
        (valor <= 0 && btnNombre != "RETENCIONES") &&
        (valor <= 0 && btnNombre != "CHEQUES")
    ) {
        if (btnNombre == "PAYPHONE") {
            fn_aplicarPagoPayPhone();
        } else if (btnNombre == "CREDITO EMPLEADO") {
            lc_opcionCreditoEmpresa = "EMPLEADO";
            fn_pagoCredito("EMPLEADO", formaPagoIDSeleccionada);
        } else if (btnNombre == "CREDITO INVENTARIOS") {
            lc_opcionCreditoEmpresa = "INVENTARIO";
            fn_pagoCredito("INVENTARIO", formaPagoIDSeleccionada);
        } else if (btnNombre == "CREDITO EXTERNO") {
            lc_opcionCreditoEmpresa = "EXTERNO";
            fn_pagoCredito("EXTERNO", formaPagoIDSeleccionada);
        } else if (btnNombre == "VOUCHER AEROLINEAS") {
            lc_opcionCreditoEmpresa = "VOUCHERAEREOLINEA";
            fn_pagoCreditoVA("EXTERNO VOUCHERAEREOLINEA");
        } else if (btnNombre == "CREDITO INTERDEPARTAMENTAL") {
            lc_opcionCreditoEmpresa = "INTER";
            fn_pagoCredito("INTER", formaPagoIDSeleccionada);
        } else if (btnNombre == "CREDITO PRODUCTO") {
            lc_opcionCreditoEmpresa = "PRODUCTO";
            fn_pagoCredito("PRODUCTO", formaPagoIDSeleccionada);
        } else if (btnNombre == "FIDELIZACION") {
            $("#mdl_rdn_pdd_crgnd").show();
            lc_opcionCreditoEmpresa = "FIDELIZACION";

            if (true) {
                $("#hid_descTipoFp").val("EFECTIVO");
                $("#btnAplicarPago").html("<b>Aplicar <br>EFECTIVO</b>");
                $("#listaFactura_canje_puntos").hide(1000);
                $("#mdl_rdn_pdd_crgnd").hide();
                alertify.success("Puntos canjeados");
            } else {
                alertify.error("No hay comunicación con el WebService");
            }
        } else if (btnNombre == "AGREGADOR") {
            if (aPagar == total_factura || pagado == total_factura) {
<<<<<<< HEAD
            lc_opcionCreditoEmpresa = "EXTERNO";
            cargarModalAgreagdores();            
            } else {
                alertify.alert(
                    "Para aplicar <b>" +
                    btnNombre +
                    "</b>, el valor a pagar debe ser el total de la factura...!!! <br><br>"
                );
=======
                lc_opcionCreditoEmpresa = "EXTERNO";
                cargarModalAgreagdores();
            } else {
                alertify.alert('Para aplicar <b>' + btnNombre + '</b>, el valor a pagar debe ser el total de la factura...!!! <br><br>');
>>>>>>> origin/MXP_Version_1.9.10.6
                $("#pagado").val("");
                return false;
            }
        } else {
            $("#pagado").val(aPagar.toFixed(2));
            fn_insertaPagoTarjeta();
            $("#txtClienteCI").focus();
            fn_numerico(txtClienteCI);
        }
    } else if ((valor <= 0 && btnNombre == "CREDITO EMPRESA") || (valor > 0 && btnNombre == "CREDITO EMPRESA")) {
        lc_opcionCreditoEmpresa = "EMPRESA";
        fn_pagoCredito("EMPRESA", formaPagoIDSeleccionada);
    } else {
        if (btnNombre == "EFECTIVO" || btnNombre == "RETENCIONES" || btnNombre == "CHEQUES") {
            fn_insertarFormaPago();
            $("#pagado").val("");
            $("#pagoTotal").val(valor.toFixed(2));
<<<<<<< HEAD
        } else if (
            btnNombre != "EFECTIVO" &&
            btnNombre != "RETENCIONES" &&
            btnNombre != "CHEQUES" &&
            btnNombre != "CREDITO EMPRESA"
        ) {
=======
        } else if ((btnNombre != "EFECTIVO") && (btnNombre != "RETENCIONES") && (btnNombre != "CHEQUES") && (btnNombre != "CREDITO EMPRESA")) {
>>>>>>> origin/MXP_Version_1.9.10.6
            if (btnNombre == "CREDITO EMPLEADO") {
                if (parseFloat($("#pagado").val()) < parseFloat($("#pagoGranTotal").val())) {
                    alertify.error(
                        "Con la forma de pago seleccionada debe cancelar el valor total de la factura."
                    );
                }
                $("#pagado").val("");
                return false;
            } else if (btnNombre == "CREDITO INVENTARIOS") {
                lc_opcionCreditoEmpresa = "INVENTARIO";
                fn_pagoCredito("INVENTARIO", formaPagoIDSeleccionada);
            } else if (btnNombre == "CREDITO EXTERNO") {
                lc_opcionCreditoEmpresa = "EXTERNO";
                fn_pagoCredito("EXTERNO", formaPagoIDSeleccionada);
            } else if (btnNombre == "CREDITO INTERDEPARTAMENTAL") {
                lc_opcionCreditoEmpresa = "INTER";
                fn_pagoCredito("INTER", formaPagoIDSeleccionada);
            } else if (btnNombre == "CREDITO PRODUCTO") {
                lc_opcionCreditoEmpresa = "PRODUCTO";
                fn_pagoCredito("PRODUCTO", formaPagoIDSeleccionada);
            } else if (btnNombre == "AGREGADOR") {
<<<<<<< HEAD
                alertify.alert(
                    "Para aplicar <b>" +
                    btnNombre +
                    "</b>, el valor a pagar debe ser el total de la factura...!!! <br><br>"
                );
=======
                alertify.alert('Para aplicar <b>' + btnNombre + '</b>, el valor a pagar debe ser el total de la factura...!!! <br><br>');
>>>>>>> origin/MXP_Version_1.9.10.6
                $("#pagado").val("");
                return false;
            } else {
                fn_insertaPagoTarjeta();
            }
        }
    }

    $("#formasPagoFactura").append(valoresTotales);

    if (valoresCambio != "") {
        $("#formasPagoFactura").append(valoresCambio);
    }

    if ((valor <= 0 && btnNombre == "EFECTIVO") || (valor <= 0 && btnNombre == "RETENCIONES") || (valor <= 0 && btnNombre == "CHEQUES")) {
        fn_buscaPagoCredito();
    }
}

<<<<<<< HEAD
function fn_aplicarPagoPayPhone() {
    var factura = $("#txtNumFactura").val();
    var send = { verificarFormasPagoAplicadasFacturaPayPhone: 1 };
    send.factura = factura;
=======
function fn_datosTarjeta() {
    $('#datosClientePayphone').hide();
    $('#datosTarjetaClientePayphone').show();
}



// payphone Reverso automatico.
function payphoneReverseAutomaticoClientID() {

    var send = {"PayPhoneObtenerClaves": 1};
    send.restaurante = $("#txtRestaurante").val();
>>>>>>> origin/MXP_Version_1.9.10.6
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_facturacion.php",
        data: send,
<<<<<<< HEAD
        success: function(datos) {
            if (datos.str < 1) {
                var orden = $("#txtOrdenPedidoId").val();
                var cuenta = $("#txtNumCuenta").val();
                var mesa = $("#txtNumMesa").val();
                $("#cntFormularioPayPhone").html('<form action="../PayPhone/payphone.php" name="frmPayPhone" method="post" style="display:none;"><input type="text" name="factura" value="' + factura + '"/><input type="text" name="odp_id" value="' + orden + '"/><input type="text" name="mesa_id" 	value="' + mesa + '"/><input type="text" name="dop_cuenta" value="' + cuenta + '"/></form>');
                document.forms["frmPayPhone"].submit();
            } else {
                if (datos[0]["Diferencia"] === 0) {
                    fn_envioFactura();
=======
        success: function (datos) {

            var send1 = {"payphoneReverseClientID": 1};
            send1.clientIdTransaccion = $("#txtclientIdPaypone").val();
            send1.token = datos[0]["Token"];
            $.ajax({
                async: false,
                type: "POST",
                dataType: "json",
                contentType: "application/x-www-form-urlencoded",
                url: "config_facturacion.php",
                data: send1,
                success: function (datos) {

                }
            });


        }
    });



}



function fn_PayPhoneObtenerClaves() {

    return new Promise(function (resolve, reject) {

        var send = {"PayPhoneObtenerClaves": 1};
        send.restaurante = $("#txtRestaurante").val();

        $.ajax({
            async: false,
            type: "POST",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            url: "config_facturacion.php",
            data: send,
            success: function (datos) {

                var codificacion;
                if (datos.str > 0) {

                    var datosTarjeta = {
                        "cardNumber": $("#cardNumberSinEnmascarar").val(),
                        "expirationMonth": $("#expirationMonth").val(),
                        "expirationYear": $("#expirationYear").val(),
                        "holderName": $("#holderName").val(),
                        "securityCode": $("#securityCode").val()
                    }


                    var key = CryptoJS.enc.Utf8.parse(datos[0]["ContraseniaCodificacion"]); // contraseña de codificacion
                    var iv = CryptoJS.enc.Utf8.parse('');
                    var encrypted = CryptoJS.AES.encrypt(JSON.stringify(datosTarjeta), key, {iv: iv});

                    codificacion = {
                        "estado": 200,
                        "token": datos[0]["Token"],
                        "data": encrypted.toString(),
                        "storeId": datos[0]["StoreId"]
                    }

                } else {
                    codificacion = {
                        "estado": 500,
                        "mensaje": "Error de conexion."
                    }
                }

                resolve(codificacion);
            }
            ,
            error: function (e) {
                resolve({
                    "estado": 500,
                    "mensaje": "Error de conexion."
                });
            }
        });

    })
}

function fn_PayPhoneObtenerDatosTransaccion(token, transactionId) {
    return new Promise(function (resolve, reject) {

        var send = {"PayPhoneObtenerDatosTransaccion": 1};
        send.token = token;
        send.transactionId = transactionId;
        $.ajax({
            async: false,
            type: "POST",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            url: "config_facturacion.php",
            data: send,
            success: function (datos) {

                var respuesta;
                if (datos.statusCode === undefined) {
                    respuesta = {
                        "estado": 204,
                        "mensaje": datos.message
                    }
                } else {
                    respuesta = datos;
                    respuesta["estado"] = 200;
                }
                resolve(respuesta);

            },
            error: function (e) {
                resolve({
                    "estado": 500,
                    "mensaje": "Error de conexion."
                });
            }
        });


    })
}


function fn_PayPhoneCreateTransaccion(token, json) {
    return new Promise(function (resolve, reject) {

        var send = {"PayPhoneEnviarTransaccion": 1};
        send.token = token;
        send.json = json;
        $.ajax({
            async: false,
            type: "POST",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            url: "config_facturacion.php",
            data: send,
            success: function (datos) {

                var respuesta;
                if (datos.statusCode === undefined) {

                    if (datos.errors[0].errorDescriptions[0] === undefined) {
                        respuesta = {
                            "estado": 204,
                            "mensaje": datos.message
                        }
                    } else {
                        respuesta = {
                            "estado": 204,
                            "mensaje": datos.errors[0].errorDescriptions[0]
                        }
                    }

                } else {
                    if (datos.statusCode === "3" || datos.statusCode === 3) {
                        respuesta = datos;
                        respuesta["estado"] = 200;
                    } else {
                        respuesta = {
                            "estado": 204,
                            "mensaje": datos.message
                        }
                    }

                }
                resolve(respuesta);
            },
            error: function (e) {
                resolve({
                    "estado": 500,
                    "mensaje": "Error de conexion."
                });
            }
        });


    })
}

function fn_PayPhoneGuardarRespuestaAutorizacion(json, TipoTransaccion, respuesta = "OK") {
    return new Promise(function (resolve, reject) {

        var send = {"PayPhoneGuardarRespuestaAutorizacion": 1};
        send.rsaut_trama = $("#cardNumberSinEnmascarar").val() + json["authorizationCode"]; // trama
        send.ttra_codigo = TipoTransaccion; //  TipoTransaccion CT
        send.cres_codigo = json["statusCode"]; // respuesta
        send.rsaut_respuesta = json["transactionStatus"];
        send.rsaut_secuencial_transaccion = json["transactionId"];
        send.rsaut_hora_autorizacion = json["date"];
        send.rsaut_fecha_autorizacion = json["date"];
        send.rsaut_numero_autorizacion = json["authorizationCode"].substring(0, 5);// max 6
        send.rsaut_terminal_id = ""; //json["xxx"];
        send.rsaut_grupo_tarjeta = json["cardType"];
        send.rsaut_red_adquiriente = json["cardBrand"];
        send.rsaut_merchant_id = "";// json["xxxx"]; // K004F000684966
        send.rsaut_numero_tarjeta = json["bin"] + "XXXX" + json["lastDigits"];
        send.rstaut_tarjetahabiente = json["optionalParameter4"];
        send.mlec_codigo = "";
        send.rsaut_identificacion_aplicacionemp = json["storeName"];
        send.rsaut_movimiento = $("#txtNumFactura").val();
        send.raut_observacion = json["transactionStatus"]; // Correo
        send.IDStatus = "E8C6D0A1-023F-2773-D846-1063F4AC58A6"; // TArjetaHabiente
        send.replica = 0; //"Kfc 004 Pp App Cci",
        send.nivel = 0;
        send.SWT_Respuesta_AutorizacionVarchar1 = "APROBADA";

        // Requerimiento
        send.rqaut_ip = $("#txt_est_ip").val();
        send.tpenv_id = 8;
        send.idUser = $("#idUser").val();

        $.ajax({
            async: false,
            type: "POST",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            url: "config_facturacion.php",
            data: send,
            success: function (datos) {
                resolve(datos[0]);
            }
        });

    })
}

function validarCampos(idInput) {
    if ($("#" + idInput).val() === "") {
        var txt = $("#" + idInput);
        alertify.error("Complete el campo " + txt.attr("desc"));
        txt.focus();
        txt.click();
        return false;
    } else {
        return true;
    }
}

async function enviarPago() {

    $("#txtclientIdPaypone").val($("#txtNumFactura").val() + "_a_" + generarAleatorio());

    if (!validarCampos('cardNumber'))
        return
    if (!validarCampos('expirationMonth'))
        return
    if (!validarCampos('expirationYear'))
        return
    if (!validarCampos('securityCode'))
        return
    if (!validarCampos('holderName'))
        return

    $("#procesandoPago").show();

    // Codifica los datos de la tarjeta para enviar en el JSON a payphone.
    var codificacion = await fn_PayPhoneObtenerClaves();
    if (codificacion.estado !== 200) {
        alertify.error(codificacion.mensaje);
        $("#procesandoPago").hide();
        return
    }



    // JSON para crear una transaccion de pago en PayPhone.
    var dataTransactionCreateTemp = {
        "data": codificacion["data"],
        "phoneNumber": $("pay_txtTelefono").val(),
        "email": $("#pay_txtCorreo").val(), // "desarrollos16@hotmail.com",
        "documentId": $("#pay_txtCedulaCliente").val(), // "1206395863",
        "clientTransactionId": $("#txtclientIdPaypone").val(), // "MCpruebasMaxpoint1",
        "storeId": codificacion["storeId"],

    }

    // AÑadir los valores de la factura al JSON, con iva0% o 12%
    var dataTransactionCreate = AdjuntarValoresTransaccionParaCrearTransaccion(dataTransactionCreateTemp);

    // Enviar Transaccion a Payphone para su aprobacion
    var transaccionCreada = await fn_PayPhoneCreateTransaccion(codificacion["token"], dataTransactionCreate);
    if (transaccionCreada.estado !== 200) {


        $("#procesandoPago").hide();
        // Si falla el envio, tratar de reversar la transaccion.

        Swal.fire({
            title: 'Ocurrio un Error.',
            text: transaccionCreada.mensaje,
            icon: 'error',
            showCancelButton: false,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'OK'
        }).then((result) => {
            if (result.value) {
                alertify.success("Intentando reverso.");
                payphoneReverseAutomaticoClientID();

            }
        })

        return
    }


    // Obtener los datos completos de la transaccion Realizada.
    var datosCompletosTransaccion = await fn_PayPhoneObtenerDatosTransaccion(codificacion["token"], transaccionCreada["transactionId"]);
    if (datosCompletosTransaccion.estado !== 200) {
        alertify.error(datosCompletosTransaccion.mensaje);
        $("#procesandoPago").hide();
        return
    }

    // Insertrar Resultados en la tabla requerimiento Autorizacion.
    var resultadoRequerimientoAutorizacion = await fn_PayPhoneGuardarRespuestaAutorizacion(datosCompletosTransaccion, "CT", "OK");
    
    $("#procesandoPago").hide(10);
    $("#modalPay").hide();
    cerrarTeclados();

    Swal.fire({
        title: 'Pago exitoso',
        text: "",
        icon: 'success',
        showCancelButton: false,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'OK'
    }).then((result) => {
        if (result.value) {

            console.log("SWT_Respuesta_Autorizacion", resultadoRequerimientoAutorizacion.respuesta);
            fn_payphoneGuadarDatosRespuesta(resultadoRequerimientoAutorizacion.respuesta, 8); // RSauid
        }
    })



}

function pay_buscarCliente() {
    $("#pay_datosCliente").show(200);

    if ($("#paybtn1").text() === "Siguiente") {

        if (!validarCampos('pay_txtCedulaCliente'))
            return
        if (!validarCampos('pay_txtTelefono'))
            return
        if (!validarCampos('pay_txtCorreo'))
            return


        $("#modalRegistroCliente").hide();
        $("#modalPay").show(200);
    }
    $("#paybtn1").text('Siguiente');

}

function cerrarTeclados() {
    $("#modalRegistroCliente").hide(200);
    $("#modalPay").hide(200);
    $("#pay_TeladoNombres").empty();
    $("#pay_TeladoNombres").hide();
    $("#dominio3").hide();
    $("#dominio4").hide();
    $("#pay_TeladocedulaCliente").hide();
    $('#pay_datosCliente').hide();
    $('#paybtn1').hide();
}
function pay_cancelarBusquedaRegistroCliente() {
    $("#modalRegistroCliente").hide(200);
    $("#modalPay").hide(200);
    $("#txtDocumentoClientePaypone").val("");


    $("#pay_TeladoNombres").empty();
    $("#pay_TeladoNombres").hide();
    $("#dominio3").hide();
    $("#dominio4").hide();
    $("#pay_TeladocedulaCliente").hide();


    $('#cardNumber').val("");
    $('#cardNumberSinEnmascarar').val("");

    $('#expirationMonth').val("");
    $('#expirationYear').val("");
    $('#securityCode').val("");
    $('#holderName').val("");

    $('#pay_txtCedulaCliente').val("");
    $('#pay_txtNombres').val("");
    $('#pay_txtDireccion').val("");
    $('#pay_txtTelefono').val("");
    $('#pay_txtCorreo').val("");

    $('#pay_datosCliente').hide();

    $('#paybtn1').hide();

}

function pay_cancelarPago() {
    $("#modalPay").hide(200);
}


function AdjuntarValoresTransaccionParaCrearTransaccion(jsonCrearT) {

    var json = JSON_TOTALES_FACTURA;
    var jsonCrearTransaccion = jsonCrearT
    for (var clave in json) {
        if (json.hasOwnProperty(clave)) {
            if (json[clave]["descripcion"] !== undefined)
                var Cadenasubtotal = json[clave]["descripcion"];

            if (Cadenasubtotal.indexOf("SUBTOTAL") === 0) {

                if (Cadenasubtotal.indexOf("SUBTOTAL ") === 0) {
                    var posicioEspacio = Cadenasubtotal.indexOf(" ") + 1;
                    var posicionPorcentaje = Cadenasubtotal.indexOf("%");
                    var porcentajeIva = Cadenasubtotal.substring(posicioEspacio, posicionPorcentaje);

                    if (porcentajeIva === "0") {


                        var AmountWithoutTax = (json[clave]["valor"] * 100).toString();
                        if (AmountWithoutTax.indexOf(".") >= 0) {
                            jsonCrearTransaccion["AmountWithoutTax"] = Math.round((json[clave]["valor"] * 100));
                        } else {
                            jsonCrearTransaccion["AmountWithoutTax"] = parseInt(json[clave]["valor"] * 100);
                        }



                    } else {

                        var amountWithTax = (json[clave]["valor"] * 100).toString();
                        if (amountWithTax.indexOf(".") >= 0) {
                            jsonCrearTransaccion["amountWithTax"] = Math.round((json[clave]["valor"] * 100));
                        } else {
                            jsonCrearTransaccion["amountWithTax"] = parseInt(json[clave]["valor"] * 100);
                        }

                    }
                }
            }

            if (Cadenasubtotal.indexOf("IVA") === 0) {
                if (Cadenasubtotal.indexOf("IVA ") === 0) {
                    var posicioEspacio = Cadenasubtotal.indexOf(" ") + 1;
                    var posicionPorcentaje = Cadenasubtotal.indexOf("%");
                    var porcentajeIva = Cadenasubtotal.substring(posicioEspacio, posicionPorcentaje);
                    if (porcentajeIva !== "0") {

                        var Tax = (json[clave]["valor"] * 100).toString();
                        if (Tax.indexOf(".") >= 0) {
                            jsonCrearTransaccion["Tax"] = Math.round((json[clave]["valor"] * 100));
                        } else {
                            jsonCrearTransaccion["Tax"] = parseInt(json[clave]["valor"] * 100);
                        }


                    }
                }
            }

            if (Cadenasubtotal.indexOf("TOTAL") === 0) {

                var amount = (json[clave]["valor"] * 100).toString();
                if (amount.indexOf(".") >= 0) {
                    jsonCrearTransaccion["amount"] = Math.round((json[clave]["valor"] * 100));
>>>>>>> origin/MXP_Version_1.9.10.6
                } else {
                    jsonCrearTransaccion["amount"] = parseInt(json[clave]["valor"] * 100);
                }




            }
            Cadenasubtotal = "";
        }
    }



    return jsonCrearTransaccion;

}


// inicio Proceso Payphone
function fn_aplicarPagoPayPhone() {

    localStorage.removeItem("ls_hayCliente");

    if (estaActivoPayPhoneFormularioEnOrdenPedido()) {

        $("#cardNumberSinEnmascarar").val("");
        $("#modalRegistroCliente").hide();
        $("#modalPay").show();
        $("#metodoDirecto").css("margin-bottom", "15px");

        // Campo para que busque automatico el cliente.
        $("#txtDocumentoClientePaypone").val(localStorage.getItem("ls_documento"));

        $("#pay_txtCedulaCliente").val(localStorage.getItem("ls_documento"));
        $("#pay_txtNombres").val(localStorage.getItem("ls_nombres"));
        $("#pay_txtDireccion").val(localStorage.getItem("ls_direccion"));
        $("#pay_txtTelefono").val(localStorage.getItem("ls_telefono"));
        $("#pay_txtCorreo").val(localStorage.getItem("ls_correo"));


    } else {


        $("#cardNumberSinEnmascarar").val("");
        $("#modalRegistroCliente").show();
        eliminarLocalStorage();
        fn_numericoFDZN('#pay_txtCedulaCliente');

    }
}


function estaActivoPayPhoneFormularioEnOrdenPedido() {
    if (localStorage.getItem("ls_PayPhoneFormularioEnOrdenPedido") === null)
        return false;
    if (localStorage.getItem("ls_PayPhoneFormularioEnOrdenPedido") === "0")
        return false;
    if (localStorage.getItem("ls_PayPhoneFormularioEnOrdenPedido") === "1")
        return true;
}

function eliminarLocalStorage() {

    if (estaActivoPayPhoneFormularioEnOrdenPedido())
        return;

    localStorage.removeItem("ls_documento");
    localStorage.removeItem("ls_nombres");
    localStorage.removeItem("ls_direccion");
    localStorage.removeItem("ls_telefono");
    localStorage.removeItem("ls_correo");
}

// PAyphone
function fn_payphoneGuadarDatosRespuesta(idRespuesta, idDispositivo) {


    cargando(1);

    $("#countdown").countdown360().stop();
    $("#txt_trama").val("");

    send = {"ingresaFormaPagoTarjeta": 1};
    send.codFactTarjeta = $("#txtNumFactura").val();
    send.fmpIdTarjeta = $("#btnFormaPagoId").val();
    send.fmpNumSegtar = 0;
    var pagadoSinSeparador = $("#pagado").val();
    var pagadoTotalSinSeparador = $("#pagoTotal").val();
    if (pagadoTotalSinSeparador >= pagadoSinSeparador || pagadoTotalSinSeparador == pagadoSinSeparador) {
        send.frmPagoTotalTarjeta = pagadoSinSeparador;
        send.fctTotalTarjeta = pagadoSinSeparador;
    } else {
        send.frmPagoTotalTarjeta = pagadoSinSeparador;
        send.fctTotalTarjeta = pagadoSinSeparador;
    }
    send.SwtTipo = idDispositivo;
    if ($("#cantidad").val() == "") {
        send.propina_valor = 0;
    } else {
        send.propina_valor = parseFloat($("#cantidad").val());
    }



    $.getJSON("config_facturacion.php", send, function (datos) {

        send = {"grabacanalmovimientoVoucher": 1};
        send.respuesta = idRespuesta;
        $.getJSON("config_facturacion.php", send, function (datos) { });
        lc_control = 0;
        var aPagar = parseFloat(pagadoTotalSinSeparador);
        var pagado = parseFloat(pagadoSinSeparador);
        var valor = aPagar - pagado;
        var btnNombre = $("#btnAplicarPago").attr("title");
        $("#pagoTotal").val(valor.toFixed(2));
        $("#pagado").val("");
        fn_resumenFormaPago();
        if ((valor <= 0 && btnNombre != "EFECTIVO")) {
            fn_envioFactura();
        }
    });



}

function generarAleatorio(minimo = 1, maximo = 10000) {
    return Math.floor(Math.random() * ((maximo + 1) - minimo) + minimo);
}

function fn_resumenFormaPago() {
<<<<<<< HEAD
    send = { resumenFormaPago: 1 };
=======
    send = {"resumenFormaPago": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfactura = $("#txtNumFactura").val();
    $.ajax({
        async: true,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            //alert();
            $("#formasPago2").empty();
            if (datos.str > 0) {
                $("#btnCancelarPago").attr("disabled", false);
                for (i = 0; i < datos.str; i++) {
                    html = "<tr>";
                    //"<div id='formasPago2'><table  align='left' width='300px'>";
                    html +=
                        "<td width='130px' align='right'>" +
                        datos[i]["fmp_descripcion"] +
                        "</td><td width='40px' align='center'>$</td>";
                    html +=
                        "<td width='100px' align='center'>" +
                        parseFloat(datos[i]["fpf_total_pagar"]).toFixed(2) +
                        "</td>";
                    html += "</tr>";
                    $("#formasPago2").append(html);
                    $("#pagado").val("");
                }
            } else {
                $("#btnCancelarPago").attr("disabled", true);
            }
        }
    });
}

/////////////////////////////AGREGAR NUMERO/////////////////////////////////
function fn_agregarNumero(valor) {
    var lc_cantidad = $("#pagado").val();

    if (lc_cantidad.indexOf(".") != -1 && valor == ".") {
        lc_cantidad = lc_cantidad;
    } else {
        lc_cantidad += valor;
    }

    $("#pagado").val(lc_cantidad);
}

/////////////////////////////ELIMINAR NUMERO/////////////////////////////////
function fn_eliminarCantidad() {
    var lc_cantidad = document.getElementById("pagado").value.substring(0, document.getElementById("pagado").value.length - 1);
    if (lc_cantidad == "") {
        lc_cantidad = "";
    }
    document.getElementById("pagado").value = lc_cantidad;
}

/////////////////////////////AGREGAR NUMERO/////////////////////////////////
function teclado(elEvento) {
    evento = elEvento || window.event;
    k = evento.keyCode;
    if (k > 47 && k < 58) {
        p = k - 48; //buscar número a mostrar.
        p = String(p); //convertir a cadena para poder añádir en pantalla.
        fn_agregarNumero(p); //enviar para mostrar en pantalla
    }
    if (k > 95 && k < 106) {
        p = k - 96;
        p = String(p);
        fn_agregarNumero(p);
    }
    if (k == 110 || k == 190) {
        fn_agregarNumero(".");
    } //teclas de coma decimal
    if (k == 8) {
        fn_eliminarNumero();
    } //Retroceso en escritura : tecla retroceso.
    if (k > 57 && k < 210) {
        document.getElementById("pagado").value = "";
    }
}

////////////////////////////////CLIENTES BUSQUEDA//////////////////////////////////////////
function fn_clienteInfo() {
    if (validarDocumento($("#txtClienteCI").val())) {
<<<<<<< HEAD
        send = { clienteInfo: 1 };
=======
        send = {"clienteInfo": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.clienteCedula = $("#txtClienteCI").val();
        $("#txtClienteB").val("");
        $("#txtClienteCI").val("");
        $("#txtClienteDireccion").val("");
        $("#txtClienteFono").val("");
        $("#txtCorreo").val("");
        $.ajax({
            async: true,
            url: "config_facturacion.php",
            data: send,
            dataType: "json",
            success: function (datos) {
                if (datos.str > 0) {
                    $("#txtClienteNombre").val(datos[0]["cli_nombres"]);
                    $("#txtClienteApellido").val(datos[0]["cli_apellidos"]);
                    $("#txtClienteCI").val(datos[0]["cli_documento"]);
                    $("#txtClienteDireccion").val(datos[0]["cli_direccion"]);
                    $("#txtClienteFono").val(datos[0]["cli_telefono"]);
                    $("#txtCorreo").val(datos[0]["cli_email"]);
                } else {
                    alertify.alert("No existe usuario con este Documento de Identificaci\u00f3n");
                }
            }
        });
    } else {
        fn_limpiarInfo();
        alertify.alert("N\u00famero de documento invalido");
    } //
}

/////////////////////////////////////////VALIDAR CEDULA/////////////////////////
function validarDocumento(campo) {
    if (campo.search(/\D/g) >= 0) {
        return false;
    }
    numero = campo;
    var suma = 0;
    var residuo = 0;
    var pri = false;
    var pub = false;
    var nat = false;
    var numeroProvincias = 22;
    var modulo = 11;
    //var ok=1;			/* Verifico que el campo no contenga letras */
    /* Aqui almacenamos los digitos de la cedula en variables. */
    d1 = numero.substr(0, 1);
    d2 = numero.substr(1, 1);
    d3 = numero.substr(2, 1);
    d4 = numero.substr(3, 1);
    d5 = numero.substr(4, 1);
    d6 = numero.substr(5, 1);
    d7 = numero.substr(6, 1);
    d8 = numero.substr(7, 1);
    d9 = numero.substr(8, 1);
    d10 = numero.substr(9, 1);
    /* El tercer digito es: */
    /* 9 para sociedades privadas y extranjeros */
    /* 6 para sociedades publicas */
    /* menor que 6 (0,1,2,3,4,5) para personas naturales */
    if (d3 == 7 || d3 == 8) {
        return false;
    }
    if (d10 == "") {
        return false;
    }
    /* Solo para personas naturales (modulo 10) */
    if (d3 < 6) {
        nat = true;
        p1 = d1 * 2;
        if (p1 >= 10) {
            p1 -= 9;
        }
        p2 = d2 * 1;
        if (p2 >= 10) {
            p2 -= 9;
        }
        p3 = d3 * 2;
        if (p3 >= 10) {
            p3 -= 9;
        }
        p4 = d4 * 1;
        if (p4 >= 10) {
            p4 -= 9;
        }
        p5 = d5 * 2;
        if (p5 >= 10) {
            p5 -= 9;
        }
        p6 = d6 * 1;
        if (p6 >= 10) {
            p6 -= 9;
        }
        p7 = d7 * 2;
        if (p7 >= 10) {
            p7 -= 9;
        }
        p8 = d8 * 1;
        if (p8 >= 10) {
            p8 -= 9;
        }
        p9 = d9 * 2;
        if (p9 >= 10) {
            p9 -= 9;
        }
        modulo = 10;
    } else if (d3 == 6) {
    /* Solo para sociedades publicas (modulo 11) */
    /* Aqui el digito verficador esta en la posicion 9, en las otras 2 en la pos. 10 */
        pub = true;
        p1 = d1 * 3;
        p2 = d2 * 2;
        p3 = d3 * 7;
        p4 = d4 * 6;
        p5 = d5 * 5;
        p6 = d6 * 4;
        p7 = d7 * 3;
        p8 = d8 * 2;
        p9 = 0;
    } else if (d3 == 9) {
        pri = true;
        p1 = d1 * 4;
        p2 = d2 * 3;
        p3 = d3 * 2;
        p4 = d4 * 7;
        p5 = d5 * 6;
        p6 = d6 * 5;
        p7 = d7 * 4;
        p8 = d8 * 3;
        p9 = d9 * 2;
    }
    suma = p1 + p2 + p3 + p4 + p5 + p6 + p7 + p8 + p9;
    residuo = suma % modulo;
    digitoVerificador = residuo == 0 ? 0 : modulo - residuo;
    /* Si residuo=0, dig.ver.=0, caso contrario 10 - residuo*/
    /* ahora comparamos el elemento de la posicion 10 con el dig. ver.*/
    if (pub == true) {
        if (digitoVerificador != d9) {
            return false;
        }
        /* El ruc de las empresas del sector publico terminan con 0001*/
        if (numero.substr(9, 4) != "0001") {
            return false;
        }
    } else if (pri == true) {
        if (digitoVerificador != d10) {
            return false;
        }
        if (numero.substr(10, 3) != "001") {
            return false;
        }
    } else if (nat == true) {
        if (digitoVerificador != d10) {
            return false;
        }
        if (numero.length > 10 && numero.substr(10, 3) != "001") {
            return false;
        }
    }
    return true;
}

function fn_agregarNumero(valor) {
    lc_cantidad = document.getElementById("cantidad").value;
    if (lc_cantidad == 0 && valor == ".") {
        //si escribimos una coma al principio del número
        document.getElementById("cantidad").value = "0."; //escribimos 0.
        coma = 1;
    } else {
        //continuar escribiendo un número
        if (valor == "." && coma == 0) {
            //si escribimos una coma decimal pòr primera vez
            lc_cantidad = lc_cantidad + valor;
            document.getElementById("cantidad").value = lc_cantidad;
            coma = 1; //cambiar el estado de la coma  
        }
        //si intentamos escribir una segunda coma decimal no realiza ninguna acción.
        else if (valor == "." && coma == 1) {
            //Resto de casos: escribir un número del 0 al 9: 	 
        } else {
            $("#cantidad").val("");
            lc_cantidad = lc_cantidad + valor;
            document.getElementById("cantidad").value = lc_cantidad;
        }
    }
    fn_focusLector();
}

/////////Funcion que permite verificarr si existe una forma de pago aplicada antes de regresar a retomar la orden///////////////
function validaExisteFormaPagoSalir() {
<<<<<<< HEAD
    var send = { validaExisteFormaPagoSalir: 1 };
=======
    send = {"validaExisteFormaPagoSalir": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.dop_cuenta = $("#txtNumCuenta").val();
    send.factAevaluar = $("#txtNumFactura").val();
    $.getJSON("config_facturacion.php", send, function (datos) {
        //        if (datos.impreso == 1) {
        //            alertify.alert("No permitido. La orden ya fue impresa.");
        //            return false;
        //        } else 
        if (datos.pagado == 1) {
            alertify.alert("Ya existe una forma de pago aplicada a esta factura.");
            return false;
        } else if (datos.descuento == 1) {
            alertify.alert("Existe un descuento aplicado a esta factura.");
            return false;
        } else if (datos.pagado == 0 && datos.descuento == 0) {
            mesa_id = $("#txtNumMesa").val();
            odp_id = $("#txtOrdenPedidoId").val();
<<<<<<< HEAD
            send = { actualiza_estados_OrdenYfactura: 1 };
            send.mesaF = mesa_id;
            send.odpId = odp_id;
            send.dop_cuenta = $("#txtNumCuenta").val();
            $.getJSON("config_facturacion.php", send, function(datos) {
                if (datos["direccion"] === "pantalla_separarcuenta") {
                    window.location.replace(datos["url"]);
                } else if (datos["direccion"] === "pantalla_ordenpedido") {
                    window.location.replace(datos["url"]);
=======
            send = {"actualiza_estados_OrdenYfactura": 1};
            send.mesaF = mesa_id;
            send.odpId = odp_id;
            send.dop_cuenta = $("#txtNumCuenta").val();
            $.getJSON("config_facturacion.php", send, function (datos) {
                if (datos['direccion'] === "pantalla_separarcuenta") {
                    window.location.replace(datos['url']);
                } else if (datos['direccion'] === "pantalla_ordenpedido") {
                    window.location.replace(datos['url']);
>>>>>>> origin/MXP_Version_1.9.10.6
                }
            });
        }
    });
}

function fn_validaEnvioSubSWT(subagrupacion, envio_id) {
    var send;
    lc_subagrupacion = subagrupacion;
    lc_tipoEnvio = envio_id;
    if (subagrupacion == "PINPAD") {
<<<<<<< HEAD
        send = { verificaConfiguracionSWT: 1 };
=======
        send = {"verificaConfiguracionSWT": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.SWTaccionconfiguracion = "subagrupacion";
        send.tipoConfiguracionSWT = subagrupacion;
        $.getJSON("config_facturacion.php", send, function (datos) {
            if (datos.existe == 1) {
                $("#modalsubSWT").dialog("close");
                $("#modalSWT").dialog("close");
                $(".jb-shortscroll-wrapper").show();
<<<<<<< HEAD
                send = { insertarRequerimientoAutorizacion: 1 };
=======
                send = {"insertarRequerimientoAutorizacion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                send.cfac = $("#txtNumFactura").val();
                send.formaPagoID = $("#btnFormaPagoId").val();
                send.valorTransaccion = $("#pagado").val();
                if ($("#cantidad").val() == "") {
                    send.prop_valor = 0;
                } else {
                    send.prop_valor = parseFloat($("#cantidad").val());
                }
<<<<<<< HEAD
                $.getJSON("config_facturacion.php", send, function(datos) {
                    lc_control = 0;
=======
                $.getJSON("config_facturacion.php", send, function (datos) {
                    lc_control = 0
>>>>>>> origin/MXP_Version_1.9.10.6
                    cargando(0);
                    fn_timeout();
                    fn_esperaRespuesta();
                }); //lectura PINPAD
            } else if (datos.existe == 2) {
                $("#usr_claveAdmin").val("");
                lc_banderaOkAdmin = "pinpad";
                alertify.set({labels: {ok: "SI", cancel: "NO"}});
                alertify.confirm("Su estaci&oacute;n actualmente no dispone esta opci&oacute;n. Desea activar el cobro de tarjetas por medio de " + subagrupacion + "?", function (e) {
                    if (e) {
                        $("#credencialesAdmin").dialog({
                            modal: true,
                            draggable: false,
                            width: 500,
                            heigth: 500,
                            resizable: false,
                            opacity: 0,
                            show: "none",
                            hide: "none",
                            duration: 500
                        });
                    }

                }); //lectura PINPAD si esque activa la opcion
            } else {
                alertify.error("Configuracion incorrecta.");
                return false;
            }

        });
    } else if (subagrupacion == "BANDA MAGNETICA") {
        $("#modalsubSWT").dialog("close");
        $("#modalSWT").dialog("close");
        $(".jb-shortscroll-wrapper").show();
<<<<<<< HEAD
        send = { verificaConfiguracionSWT: 1 };
=======
        send = {"verificaConfiguracionSWT": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.SWTaccionconfiguracion = "subagrupacion";
        send.tipoConfiguracionSWT = subagrupacion;
        $.getJSON("config_facturacion.php", send, function (datos) {
            if (datos.existe == 1) {
                alertify.log("DESLICE LA TARJETA.");
                $("#txt_trama").focus();
                $("#txt_trama").keyup(function (event) {
                    if (event.keyCode == "13") {
                        fn_muestraTecladoCVV();
                    }
                });
                //LECTURA POR BANDA	
            } else if (datos.existe == 2) {
                alertify.set({labels: {ok: "SI", cancel: "NO"}});
                alertify.confirm("Su estaci&oacute;n actualmente no dispone esta opci&oacute;n. Desea activar el cobro de tarjetas por medio de " + subagrupacion + "?", function (e) {
                    if (e) {
                        $("#usr_claveAdmin").val("");
                        lc_banderaOkAdmin = "banda";
                        $("#credencialesAdmin").show();
                        $("#credencialesAdmin").dialog({
                            modal: true,
                            draggable: false,
                            width: 500,
                            heigth: 500,
                            resizable: false,
                            opacity: 0,
                            show: "none",
                            hide: "none",
                            duration: 500
                        });
                    } else {
                        $("#pagado").val("");
                    }

                });
                //lectura BANDA si esque activa la opcion					
            } else {
                alertify.error("Configuracion incorrecta.");
                return false;
            }
        });
    } else {
        alertify.error("Configuracion incorrecta. No tiene ninguna subagrupación");
        return false;
    }
}


function fn_armaTramaPinpadunired(opcion, tipoTran) {
    valordelaTransaccionPinPadP = parseFloat($("#pagoTotal").val());
<<<<<<< HEAD
    var send = { insertarRequerimientoPinpadProduccion: 1 };
=======
    send = {"insertarRequerimientoPinpadProduccion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfacPinpadP = $("#txtNumFactura").val();
    send.formaPagoIDPinpadP = $("#btnFormaPagoId").val();
    if (opcion == "compra") {
        if ($("#cantidad").val() == "") {
            send.prop_valorPinpadP = 0;
        } else {
            send.prop_valorPinpadP = parseFloat($("#cantidad").val());
        }
        if (banderaa == 1) {
            send.valorTransaccionPinPadP = $("#pagado").val();
        } else {
            if (valordelaTransaccionPinPadP != 0) {
                send.valorTransaccionPinPadP = $("#pagado").val();
            } else {
                send.valorTransaccionPinPadP = $("#pagoGranTotal").val();
            }
        }
    } else {
        send.prop_valorPinpadP = 0;
        send.valorTransaccionPinPadP = 0;
        send.valorTransaccionPinPadP = 0;
    }
    send.tipoEnvioPinPadP = 5; //lc_tipoEnvio;
    send.tipoTransaccionPinpadP = tipoTran;
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_facturacion.php",
        data: send,
        success: function (datos) {
            lc_control = 0;
            cargando(0);
            fn_timeoutPinpadUnired();
<<<<<<< HEAD
            if (opcion == "compra") {
                TEMPORIZADORUNIRED = setInterval(function() {
=======
            if (opcion == 'compra') {
                TEMPORIZADORUNIRED = setInterval(function () {
>>>>>>> origin/MXP_Version_1.9.10.6
                    fn_esperaRespuestaPProduccion();
                }, 1000);
            } else {
                TEMPORIZADORUNIRED = setInterval(function () {
                    fn_esperaRespuestaCancelacionUnired();
                }, 1000);
            }
        }
    });
}

function Insertar_Pago() {
    alert("pago");
}

function fn_validaEnvioSWT(event, descripcion, integracion, autoriza, secuenciaConfigurada, secuencia) {
    event.stopPropagation();
    $("#modalsubSWT").dialog("close");
    $("#modalSWT").dialog("close");
    $(".jb-shortscroll-wrapper").show();
    lc_tipoEnvio = integracion;
    secuencias = secuencia.split("->");
    var funcion = "";
<<<<<<< HEAD
    $.ajaxSetup({ async: false });

    if (secuencias[0] == "Armar_Trama") {
=======
    $.ajaxSetup({async: false});
    //for (i = 0; i < secuencias.length; i++) {
    if (secuencias[0] == 'Armar_Trama') {
>>>>>>> origin/MXP_Version_1.9.10.6
        secuencias = secuencias.splice(1, secuencias.length - 1);
        Armar_Trama_Dinamica(
            "ENVIO",
            integracion,
            secuencias,
            "",
            "",
            $("#txtNumFactura").val(),
            $("#btnFormaPagoId").val(),
            "FACTURACION"
        );
    } else if (secuencias[0] == "Esperar_Respuesta") {
        secuencias = secuencias.splice(0, 1);
        Esperar_Respuesta();
    } else if (secuencias[0] == "Insertar_Pago") {
        secuencias = secuencias.splice(0, 1);
        Insertar_Pago();
    } else if (secuencias[0] == "Ingresar_Bin") {
        $("#modalsubSWT").dialog("close");
        $("#modalSWT").dialog("close");
        $(".jb-shortscroll-wrapper").show();

        Ingresar_Bin();
    } else if (secuencias[0] == "Lectura_Tarjeta") {
        secuencias = secuencias.splice(1, secuencias.length - 1);
        //Armar_Trama_Dinamica('ENVIO', datos[0]['idIntegracion'],secuencias,'','',$("#txtNumFactura").val(),$("#btnFormaPagoId").val(),'FACTURACION');      
        fn_validaConfiguracionBinTarjetaLectura(
            "ENVIO",
            integracion,
            secuencias,
            $("#txtNumFactura").val(),
            $("#btnFormaPagoId").val(),
            "FACTURACION"
        );
    }
    //funcion();
    //          }
    $.ajaxSetup({async: true});
    return false;
    //event.stopPropagation();
    lc_tipoEnvio = integracion;
    if (integracion == 1) {
        //INICIO DE PINPAD
        $("#modalsubSWT").dialog("close");
        $("#modalSWT").dialog("close");
        $(".jb-shortscroll-wrapper").show();
<<<<<<< HEAD
        if (autoriza == 1) {
            //autorizado a aplicar pinpad
            fn_armaTramaPinPadMultired("compra", "01");
        } //no autorizado a aplicar pinpad
        else {
            alertify.set({ labels: { ok: "SI", cancel: "NO" } });
            alertify.confirm("Su estaci&oacute;n actualmente no dispone esta opci&oacute;n. Desea activar el cobro de tarjetas por medio de " + descripcion + "?", function(e) {
=======
        if (autoriza == 1) //autorizado a aplicar pinpad
        {
            fn_armaTramaPinPadMultired("compra", "01")
        } else //no autorizado a aplicar pinpad
        {
            alertify.set({labels: {ok: "SI", cancel: "NO"}});
            alertify.confirm("Su estaci&oacute;n actualmente no dispone esta opci&oacute;n. Desea activar el cobro de tarjetas por medio de " + descripcion + "?", function (e) {
>>>>>>> origin/MXP_Version_1.9.10.6
                if (e) {
                    $("#usr_claveAdmin").val("");
                    lc_banderaOkAdmin = "pinpad";
                    $("#credencialesAdmin").show();
                    $("#credencialesAdmin").dialog({
                        modal: true,
                        draggable: false,
                        width: 500,
                        heigth: 500,
                        resizable: false,
                        opacity: 0,
                        show: "none",
                        hide: "none",
                        duration: 500
                    });
                } else {
                    $("#pagado").val("");
                }
        }
            );
        }
    } //FIN DE PIN PAD
    //Inicio de banda
    else if (integracion == 2) {
        $("#modalsubSWT").dialog("close");
        $("#modalSWT").dialog("close");
        $(".jb-shortscroll-wrapper").show();
        //1 esta autorizado a aplicar el tipo de envio
        if (autoriza == 1) {
            fn_validaConfiguracionBinTarjetaLectura();
            //si no lo esta solicita credenciales de admin
        } else {
            alertify.set({labels: {ok: "SI", cancel: "NO"}});
            alertify.confirm("Su estaci&oacute;n actualmente no dispone esta opci&oacute;n. Desea activar el cobro de tarjetas por medio de " + descripcion + "?", function (e) {
                if (e) {
                    $("#usr_claveAdmin").val("");
                    lc_banderaOkAdmin = "banda";
                    $("#credencialesAdmin").show();
                    $("#credencialesAdmin").dialog({
                        modal: true,
                        draggable: false,
                        width: 500,
                        heigth: 500,
                        resizable: false,
                        opacity: 0,
                        show: "none",
                        hide: "none",
                        duration: 500
                    });
                } else {
                    $("#pagado").val("");
                }
            });
        }
    } //fin de banda
    else if (integracion == 3) {
        //inicio de datafast-otros
        //$("#modalsubSWT").dialog("close");
        //$("#modalSWT").dialog("close");
        //$(".jb-shortscroll-wrapper").show();
        if (autoriza == 1) {
            //fn_insertaFormaPagoTarjetaDatafast();
            fn_modalBinDatafast();
<<<<<<< HEAD
        } // cuando la estacion no se encuentra autorizada a aplicar datafast
        else {
            alertify.set({ labels: { ok: "SI", cancel: "NO" } });
            alertify.confirm("Su estaci&oacute;n actualmente no dispone esta opci&oacute;n. Desea activar el cobro de tarjetas por medio de " + descripcion + "?", function(e) {
=======
        } else // cuando la estacion no se encuentra autorizada a aplicar datafast
        {
            alertify.set({labels: {ok: "SI", cancel: "NO"}});
            alertify.confirm("Su estaci&oacute;n actualmente no dispone esta opci&oacute;n. Desea activar el cobro de tarjetas por medio de " + descripcion + "?", function (e) {
>>>>>>> origin/MXP_Version_1.9.10.6
                if (e) {
                    lc_banderaOkAdmin = "otro";
                    $("#credencialesAdmin").show();
                    $("#credencialesAdmin").dialog({
                        modal: true,
                        draggable: false,
                        width: 500,
                        heigth: 500,
                        resizable: false,
                        opacity: 0,
                        show: "none",
                        hide: "none",
                        duration: 500
                    });
                }
        }
            );
        }
    } //fin de datafast-otros //inicio de pinpad Unired
    else {
        $("#modalsubSWT").dialog("close");
        $("#modalSWT").dialog("close");
        $(".jb-shortscroll-wrapper").show();
        if (autoriza == 1) {
            //autorizado a aplicar pinpad
            fn_armaTramaPinpadunired("compra", "01");
        } //no autorizado a aplicar pinpad
        else {
            alertify.alert("Estacion no autorizada para aplicar Pinpad Unired");
            return false;
        }
    }
}

function Ingresar_Bin() {

    $("#modal_binDatafast").dialog({
        modal: true,
        resizable: false,
        closeOnEscape: false,
        position: "center",
        draggable: false,
        width: 500,
        heigth: 500,
        opacity: 0,
        show: "none",
        hide: "none",
        duration: 500,
        buttons: {
<<<<<<< HEAD
            Aceptar: function() {
                fn_validarBinTarjetaDatafast();
            },
            Cancelar: function() {
=======
            "Aceptar": function () {
                fn_validarBinTarjetaDatafast();
            },
            "Cancelar": function () {
>>>>>>> origin/MXP_Version_1.9.10.6
                $(this).dialog("close");
                $(".jb-shortscroll-wrapper").show();
                $("#pagado").val("");
                $("#txt_bin").val("");
            }
        }
    });
}

function fn_insertaPagoTarjeta() {

    var html = "";
    banderaa = $("#hid_bandera_cvv").val();
<<<<<<< HEAD
    var send = { validaColeccionEstacionTipoEnvio: 1 };
    var lc_tipoEnvio = 0;
    var valordelaTransaccionPinPad = 0;

    $.getJSON("config_facturacion.php", send, function(datos) {
=======
    var send = {"validaColeccionEstacionTipoEnvio": 1};
    var lc_tipoEnvio = 0;
    var valordelaTransaccionPinPad = 0;
    var valordelaTransaccionPinPadP = 0;
    $.getJSON("config_facturacion.php", send, function (datos) {
>>>>>>> origin/MXP_Version_1.9.10.6
        if (datos.str > 0) {
            if (datos.str > 1) {
                $("#tblSWT").empty();
                html = "";
                for (i = 0; i < datos.str; i++) {
                    html +=
                        "<td><button class='ui-state-default ui-corner-all' onclick='fn_validaEnvioSWT(event,\"" +
                        datos[i]["Descripcion"] +
                        '","' +
                        datos[i]["idIntegracion"] +
                        '",' +
                        datos[i]["autorizado"] +
                        ',"' +
                        datos[i]["secuenciaConfigurada"] +
                        '","' +
                        datos[i]["secuencia"] +
                        "\");'>" +
                        datos[i]["Descripcion"] +
                        "</button></td>";
                }
                $("#tblSWT").html(html);
                $(".jb-shortscroll-wrapper").hide();
                $("#modalSWT").dialog({
                    modal: true,
                    resizable: false,
                    closeOnEscape: false,
                    position: "center",
                    draggable: false,
                    width: 500,
                    heigth: 500,
                    opacity: 0,
                    show: "none",
                    hide: {
                        effect: "none",
                        duration: 0
                    },
                    duration: 500,
                    buttons: {
<<<<<<< HEAD
                        Cancelar: function() {
=======
                        "Cancelar": function () {
>>>>>>> origin/MXP_Version_1.9.10.6
                            $(this).dialog("close");
                            $(".jb-shortscroll-wrapper").show();
                            $("#pagado").val("");
                        }


                    }
                });

            } else {

<<<<<<< HEAD
                lc_tipoEnvio = datos[0]["idIntegracion"];
                //Banda
                if (datos[0]["idIntegracion"] == 2) {
                    //si esta autorizado a aplicar este tipo de envio
                    if (datos[0]["autorizado"] == 1) {
                        fn_validaConfiguracionBinTarjetaLectura();
                    } else {
                        alertify.alert("ERROR!. El Medio Autorizador: " + datos[0]["Descripcion"] + ", se encuentra mal configurado.");
                    }
                    //pinpad
                } else if (datos[0]["idIntegracion"] == 1) {
                    //si esta autorizado a aplicar este tipo de envio
                    if (datos[0]["autorizado"] == 1) {
                        valordelaTransaccionPinPad = parseFloat($("#pagoTotal").val());
                        send = { insertarRequerimientoAutorizacion: 1 };
                        send.cfac = $("#txtNumFactura").val();
                        send.formaPagoID = $("#btnFormaPagoId").val();
                        send.valorTransaccion = parseFloat($("#pagoTotal").val());
                        if ($("#cantidad").val() == "") {
                            send.prop_valor = 0;
                        } else {
                            send.prop_valor = parseFloat($("#cantidad").val());
                        }
                        if (banderaa == 1) {
                            send.valorTransaccionPinPad = $("#pagado").val();
                        } else {
                            if (valordelaTransaccionPinPad != 0) {
                                send.valorTransaccionPinPad = $("#pagado").val();
                            } else {
                                send.valorTransaccionPinPad = $("#pagoGranTotal").val();
                            }
                        }
                        send.tipoEnvioPinPad = lc_tipoEnvio;
                        $.getJSON("config_facturacion.php", send, function(datos) {
                            lc_control = 0;
                            cargando(0);
                            fn_timeout();
                            //fn_esperaRespuesta();
                            temporizadorPinpad = setInterval(function() {
                                fn_esperaRespuesta();
                            }, 1000);
                        }); //lectura PINPAD
                    } else {
                        alertify.alert("ERROR!. El Medio Autorizador: " + datos[0]["Descripcion"] + ", se encuentra mal configurado.");
                    }
                    //otro
                } else if (datos[0]["idIntegracion"] == 3) {
                    //si esta autorizado a aplicar este tipo de envio
                    if (datos[0]["autorizado"] == 1) {
                        fn_modalBinDatafast();
                    } else {
                        alertify.alert("ERROR!. El Medio Autorizador: " + datos[0]["Descripcion"] + ", se encuentra mal configurado.");
                    }
                } else {
                    //si esta autorizado a aplicar este tipo de envio
                    if (datos[0]["idIntegracion"] == 5) {
                        fn_armaTramaPinpadunired("compra", "01");
                    } else {
                        alertify.alert("ERROR!. El Medio Autorizador: " + datos[0]["Descripcion"] + ", se encuentra mal configurado.");
                    }
                }

                secuencias = datos[0]["secuencia"].split("->");
                $.ajaxSetup({ async: false });
                if (secuencias[0] == "Armar_Trama") {
=======
                secuencias = datos[0]['secuencia'].split("->");
                $.ajaxSetup({async: false});
                if (secuencias[0] == 'Armar_Trama') {
>>>>>>> origin/MXP_Version_1.9.10.6
                    secuencias = secuencias.splice(1, secuencias.length - 1);
                    Armar_Trama_Dinamica(
                        "ENVIO",
                        datos[0]["idIntegracion"],
                        secuencias,
                        "",
                        "",
                        $("#txtNumFactura").val(),
                        $("#btnFormaPagoId").val(),
                        "FACTURACION"
                    );
                } else if (secuencias[0] == "Esperar_Respuesta") {
                    secuencias = secuencias.splice(0, 1);
                    Esperar_Respuesta();
                } else if (secuencias[0] == "Insertar_Pago") {
                    secuencias = secuencias.splice(0, 1);
                    Insertar_Pago();
                } else if (secuencias[0] == "Ingresar_Bin") {
                    $("#modalsubSWT").dialog("close");
                    $("#modalSWT").dialog("close");
                    $(".jb-shortscroll-wrapper").show();
                    Ingresar_Bin();
                } else if (secuencias[0] == "Lectura_Tarjeta") {
                    secuencias = secuencias.splice(1, secuencias.length - 1);
                    lc_tipoEnvio = datos[0]["idIntegracion"];
                    //Armar_Trama_Dinamica('ENVIO', datos[0]['idIntegracion'],secuencias,'','',$("#txtNumFactura").val(),$("#btnFormaPagoId").val(),'FACTURACION');      
                    fn_validaConfiguracionBinTarjetaLectura(
                        "ENVIO",
                        datos[0]["idIntegracion"],
                        secuencias,
                        $("#txtNumFactura").val(),
                        $("#btnFormaPagoId").val(),
                        "FACTURACION"
                    );
                }
                $.ajaxSetup({async: true});

            }
        } else {
            $("#pagado").val("");
            alertify.alert("No existe la configuraci&oacute;n para pagos con tarjetas para &eacute;sta estaci&oacute;n");
        }
    });
}

function fn_validaConfiguracionBinTarjetaLectura(tipoTransaccion, idDispositivo, secuencia, codigoFactura, idFormaPagoFatura, modulo) {
    $("#txt_trama").val("");
    alertify.log("DESLICE LA TARJETA.");

    $("#txt_trama").focus();
    $("#txt_trama").unbind().keypress(function (event) {
        if (event.which == 13) {
            var caracTarjeta = $("#txt_trama").val();
            var porcionTarjeta = caracTarjeta.substring(0, 50);
<<<<<<< HEAD
                send = { verificaBinExistenteSwt: 1 };
=======
            send = {"verificaBinExistenteSwt": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
            send.caracteresTarjeta = porcionTarjeta;
            $.getJSON("config_facturacion.php", send, function (datos) {
                if (datos.str > 0) {
                    if (datos.confirma == 1) {
                            if (secuencia[0] == "Ingresar_Cvv") {
                            secuencia = secuencia.splice(1, secuencia.length - 1);
                            fn_muestraTecladoCVV(tipoTransaccion, idDispositivo, secuencia, caracTarjeta, codigoFactura, idFormaPagoFatura, modulo);
                        }

                    } else if (datos.confirma == 2) {
                        $("#txt_trama").val("");
                        alertify.alert(datos.mensaje);
                        $("#pagado").val("");
                        return false;
                    } else {
                        $("#txt_trama").val("");
                        alertify.alert(datos.mensaje);
                        $("#pagado").val("");
                        return false;
                    }
                } else {
                    $("#txt_trama").val("");
                    alertify.error("Error!.");
                    $("$pagado").val("");
                }
            });
        }
    });
}

function fn_salirSistema() {
<<<<<<< HEAD
    send = { validaDetalleEnFactura: 1 };
=======
    send = {"validaDetalleEnFactura": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.codigodefactura = $("#txtNumFactura").val();
    $.getJSON("config_facturacion.php", send, function (datos) {
        if (datos.str > 0) {
            if (datos.existe == 1) {
                if ($("#txtTipoServicio").val() == 1) {
                    alertify.error(
                        "Existen detalle(s) en la Factura. No puede salir del sistema."
                    );
                } else {
                    alertify.confirm("Existen detalles en la factura. Est&aacute; seguro de salir del sistema?", function (e) {
                        if (e) {
                            lc_banderaOkAdmin = "salirSistema";
                            $(".jb-shortscroll-wrapper").hide();
                            $("#credencialesAdmin").show();
                            $("#credencialesAdmin").dialog({
                                modal: true,
                                width: 500,
                                heigth: 500,
                                resizable: false,
                                opacity: 0,
                                show: "none",
                                hide: "none",
                                duration: 500
                            });
                        }
                    });
                }
            }
        } else {
            window.location.replace("../index.php");
        }
    });
}

/*
 ////////////////////////////////////////////////////////////////////////////////////
 las siguientes funciones son para eliminar las formas de pago que ya esten aplicadas
 /////////////////////////////////////////////////////////////////////////////////////
 */
function fn_cancelarPago(event) {
    var send;
    event.stopPropagation();
    titulo = $("#hid_descTipoFp").val();
    var btnNombreFormaPago = $("#hid_descFp").val();
    $("#hid_bandera_cvv").val(2);
    var btnNombreFormaPago = $("#hid_descFp").val();
    var titulo_alerta = ((btnNombreFormaPago == "CONSUMO RECARGA")?"CONSUMO RECARGA":titulo);
    //NO SON TARJETAS
<<<<<<< HEAD
    if (
        titulo == "CONSUMO RECARGA" ||
        titulo == "EFECTIVO" ||
        titulo == "RETENCIONES" ||
        titulo == "CREDITO EMPRESA" ||
        titulo == "CHEQUES" ||
        titulo == "CREDITO EMPLEADO"
    ) {
        send = { consulta_cancelacionTarjeta: 1 };
        send.can_codFact = $("#txtNumFactura").val();
        send.can_idPago = $("#btnFormaPagoId").val();
        send.banderaBuscaCancelacion = "OTRO";
        $.getJSON("config_facturacion.php", send, function(datos) {
            if (datos.existe == 1) {
                alertify.confirm(
                    "Esta seguro de cancelar la forma de pago " + titulo_alerta + "?",
                    function(e) {
                        if (e) {
                            if (btnNombreFormaPago == "CONSUMO RECARGA") {
                                cancelarPagoRecargaEfectivo();
                            } else if (
                                titulo == "EFECTIVO" ||
                                titulo == "RETENCIONES" ||
                                titulo == "CHEQUES"
                            ) {
                                send = { anula_formaPagoEfectivo: 1 };
=======
    if (titulo == "EFECTIVO" || titulo == "RETENCIONES" || titulo == "CREDITO EMPRESA" || titulo == "CHEQUES" || titulo == "CREDITO EMPLEADO") {
        send = {"consulta_cancelacionTarjeta": 1};
        send.can_codFact = $("#txtNumFactura").val();
        send.can_idPago = $("#btnFormaPagoId").val();
        send.banderaBuscaCancelacion = "OTRO"
        $.getJSON("config_facturacion.php", send, function (datos) {
            if (datos.existe == 1) {
                alertify.confirm("Esta seguro de cancelar la forma de pago " + titulo + "?", function (e) {
                    if (e) {
                        if (titulo == "EFECTIVO" || titulo == "RETENCIONES" || titulo == "CHEQUES") {
                            send = {"anula_formaPagoEfectivo": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                            send.anu_codFact = $("#txtNumFactura").val();
                            send.anu_idPago = $("#btnFormaPagoId").val();
                            $.getJSON("config_facturacion.php", send, function (datos) {
                                fn_obtieneTotalApagar();
                                $("#pagado").val("");
                                fn_resumenFormaPago();
                                $("#td_cambio").hide();
                                $("#td_falta").show();
                            });

                            var tituloBotonCancelar = $("#btnCancelarPago").attr("title");
                            if (tituloBotonCancelar === "CUPON PREPAGADO") {
                                //clienteCanjearCuponesMultimarca.php
                                // if(""===cuponMultimarcaCanjeado){
                                //     alert("Codigo de cupon multimarca vacio");
                                //     return false;
                                // }
                                var codigoObj = {
                                    metodo: "anularCanje",
                                        codigoCupon: cuponMultimarcaCanjeado
                                };
                                // Verificar validez del cupon en gerente
                                var $peticionValidacion = $.post("clienteCanjearCuponesMultimarca.php",
                                        codigoObj,
                                        function (datos) {
                                            // console.log("Se anuló el canje");
                                        },
                                        "json"
                                        );

                            }
                        } //fin forma de pago efectivo
                        else if (titulo == "CREDITO EMPRESA" || titulo == "CREDITO EMPLEADO") {
<<<<<<< HEAD
                                send = { anula_formaPagoCredito: 1 };
=======
                            send = {"anula_formaPagoCredito": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                            send.anu_codFactCredito = $("#txtNumFactura").val();
                            send.anu_idPagoCredito = $("#btnFormaPagoId").val();
                            $.getJSON("config_facturacion.php", send, function (datos) {
                                fn_obtieneTotalApagar();
                                $("#pagado").val("");
                                fn_resumenFormaPago();
                                $("#td_cambio").hide();
                                $("#td_falta").show();
                            });
                        }
                    } //FIN DEL ALERTIFY
                });
            } // fin consulta si existen formas de pago a cancelar.
            else {
                alertify.error("No existe la forma de pago " + titulo + " aplicada a &eacute;sta factura.");
            } //// fin consulta si no existen formas de pago a cancelar.
        });
<<<<<<< HEAD
    } //tarjetas
    else {
        //formas de pago tarjetas
        send = { consulta_cancelacionTarjeta: 1 };
        send.can_codFact = $("#txtNumFactura").val();
        send.can_idPago = $("#btnFormaPagoId").val();
        send.banderaBuscaCancelacion = "TARJETA";
        $.getJSON("config_facturacion.php", send, function(datos) {
            if (datos.existe == 1) {
                send = { consultaSwtTransaccionalCancelacion: 1 };
=======
    } else if (titulo === "PAYPHONE") {

        alertify.error("Estimado usuario, para anular el pago PAYPHONE debe generar una Nota de Credito.");
    } else //tarjetas
    { //formas de pago tarjetas													
        send = {"consulta_cancelacionTarjeta": 1};
        send.can_codFact = $("#txtNumFactura").val();
        send.can_idPago = $("#btnFormaPagoId").val();
        send.banderaBuscaCancelacion = "TARJETA"
        $.getJSON("config_facturacion.php", send, function (datos) {
            if (datos.existe == 1) {
                send = {"consultaSwtTransaccionalCancelacion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                send.cancelacion_codFact = $("#txtNumFactura").val();
                $.getJSON("config_facturacion.php", send, function (datos) {
                    if (datos.str > 0) {
                        $("#tblSWTCancelacion").empty();
                        $(".jb-shortscroll-wrapper").hide();
                        for (i = 0; i < datos.str; i++) {
                            html = "";
                            html +=
                                "<td><button class='ui-state-default ui-corner-all' onclick='fn_anulaPagoTarjeta(\"" +
                                datos[i]["fpf_id"] +
                                '",' +
                                datos[i]["fpf_swt"] +
                                ',"' +
                                datos[i]["fmp_id"] +
                                '", "' +
                                datos[i]["secuenciaConfigurada"] +
                                '", "' +
                                datos[i]["secuencia"] +
                                "\");'>" +
                                datos[i]["fmp_descripcion"] +
                                "</button></td>";

                            $("#tblSWTCancelacion").append(html);
                        }
                        $("#modalSWTCancelacion").dialog({
                            modal: true,
                            resizable: false,
                            closeOnEscape: false,
                            position: "center",
                            draggable: false,
                            width: 500,
                            heigth: 500,
                            opacity: 0,
                            show: "none",
                            hide: "none",
                            duration: 500,
                            buttons: {
<<<<<<< HEAD
                                Cancelar: function() {
=======
                                "Cancelar": function () {
>>>>>>> origin/MXP_Version_1.9.10.6
                                    $(this).dialog("close");
                                }
                            }
                        });
                    }
                }); // fin consultaSwtTransaccional	
            } else if (titulo === "PAYPHONE") {
                alertify.error("Estimado usuario, para anular el pago debe generar una Nota de Credito.");

            } else {
                alertify.error("No existe la forma de pagos con Tarjeta aplicada a &eacute;sta factura.");
            }
        });

        //fin de formas de pago con tarjeta					
    }
}

function fn_anulaPagoTarjeta(fpf_id, swt, fmp_id, secuenciaConfigurada, secuencias) {
    lc_tipoEnvio = swt;
    $("#btnFormaPagoId").val(fpf_id);
    //1.9.9
    if (swt == 1) { //pinpad
        lc_control = 0;
        cargando(0);
        fn_timeout();
        fn_armaTramaPinPadMultired("anula", "03");
    } else if (swt == 2) { //banda
        $("#txt_trama").val("");
        $("#modalSWTCancelacion").dialog("close");
        $(".jb-shortscroll-wrapper").show();
        alertify.log("DESLICE LA TARJETA.");
        $("#txt_trama").focus();
        $("#txt_trama").keyup(function(event) {
            if (event.keyCode == "13") {
                fn_muestraTecladoCVV();
            }
        });
    } else if (swt == 3) { //otro tipo
        $("#modalSWTCancelacion").dialog("close");
        var send = { anula_formaPagoEfectivo: 1 };
        send.anu_codFact = $("#txtNumFactura").val();
        send.anu_idPago = fmp_id;
        $.getJSON("config_facturacion.php", send, function(datos) {
            fn_obtieneTotalApagar();
            fn_resumenFormaPago();
            $("#pagado").val("");
        });
    } else {
        $("#modalSWTCancelacion").dialog("close");
        fn_armaTramaPinpadunired("anula", "03");
    }
    //1.9.10.6
    $("#modalSWTCancelacion").dialog("close");
    secuencias.length = 0; //vacio el array que contiene las secuencias
    secuencias = secuencias.split("->"); //se ingresan nuevaamente datos al array de las secuencias

    if (secuencias[0] == "Armar Trama") {
        secuencias = secuencias.splice(1, secuencias.length - 1);
        Armar_Trama_Dinamica(
            "ANULACION",
            swt,
            secuencias,
            "",
            "",
            $("#txtNumFactura").val(),
            fpf_id,
            "FACTURACION"
        );
    } else if (secuencias[0] == "Lectura_Tarjeta") {
        secuencias = secuencias.splice(1, secuencias.length - 1);
        fn_validaConfiguracionBinTarjetaLectura(
            "ANULACION",
            swt,
            secuencias,
            $("#txtNumFactura").val(),
            fpf_id,
            "FACTURACION"
        );
    } else if (secuencias[0] == "Anular_Pago") {
        secuencias = secuencias.splice(1, secuencias.length - 1);
        $("#modalSWTCancelacion").dialog("close");
<<<<<<< HEAD
        send = { anula_formaPagoEfectivo: 1 };
=======
        send = {"anula_formaPagoEfectivo": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.anu_codFact = $("#txtNumFactura").val();
        send.anu_idPago = fmp_id;
        $.getJSON("config_facturacion.php", send, function (datos) {
            fn_obtieneTotalApagar();
            fn_resumenFormaPago();
            $("#pagado").val("");
        });

    }
    //return false;
    /*
     if (swt == 1)	//pinpad
     {
     lc_control = 0;
     cargando(0);
     fn_timeout();
     fn_armaTramaPinPadMultired("anula", "03");
     }//fin pago tarjeta con pinpad
     else if (swt == 2)//banda
     {
     $("#txt_trama").val("");
     $("#modalSWTCancelacion").dialog("close");
     $(".jb-shortscroll-wrapper").show();
     alertify.log("DESLICE LA TARJETA.");
     $("#txt_trama").focus();
     $("#txt_trama").keyup(function (event) {
     if (event.keyCode == "13")
     {
     fn_muestraTecladoCVV();
     }
     }
     );
     }//fin pago  tarjeta con banda
     else if (swt == 3) {
     $("#modalSWTCancelacion").dialog("close");
     send = {"anula_formaPagoEfectivo": 1};
     send.anu_codFact = $("#txtNumFactura").val();
     send.anu_idPago = fmp_id;
     $.getJSON("config_facturacion.php", send, function (datos) {
     fn_obtieneTotalApagar();
     fn_resumenFormaPago();
     $("#pagado").val("");
     });
     }// fin pago tarjeta con 'otro tipo'
     else
     {
     $("#modalSWTCancelacion").dialog("close");
     fn_armaTramaPinpadunired("anula", "03");
     }*/
}

function fn_obtieneTotalApagar() {
<<<<<<< HEAD
    var send = { obtieneTotalApagar: 1 };
=======
    send = {"obtieneTotalApagar": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.ob_codFact = $("#txtNumFactura").val();
    send.ob_idPago = $("#btnFormaPagoId").val();
    $.getJSON("config_facturacion.php", send, function (datos) {
        if (datos.str > 0) {
            $("#pagoTotal").val(parseFloat(datos.total).toFixed(2));
        }
    });
}

function fn_esperaRespuestaCancelacionUnired() {
<<<<<<< HEAD
    var send = { esperaRespuestaRequerimientoAutorizacion: 1 };
=======
    send = {"esperaRespuestaRequerimientoAutorizacion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfac = $("#txtNumFactura").val();
    $.ajax({
        async: true,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.existe === 1) {
                fn_funcionMuestraRespuestaCancelacionUnired(datos.rsaut_respuesta, datos.cres_codigo, datos.fpf_id, datos.rsaut_id, datos.errorTrama);
            }
        }
    });
}

function fn_funcionMuestraRespuestaCancelacionUnired(respuesta, codigoRespuesta, formadePago, idRespuesta, tramaError) {
    var send;
    clearInterval(TEMPORIZADORUNIRED);
    $("#countdown").countdown360().stop();
    lc_control = 1;
    cargando(1);
    //alert(codigoRespuesta);
    if (tramaError == 1) {
        if (codigoRespuesta == "00") {
<<<<<<< HEAD
            send = { cancelaTarjetaForma: 1 };
=======
            send = {"cancelaTarjetaForma": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
            send.can_respuesta = idRespuesta;
            send.cancela_codFact = $("#txtNumFactura").val();
            send.cancela_idPago = $("#btnFormaPagoId").val();
            $.getJSON("config_facturacion.php", send, function (datos) {
                alertify.alert(respuesta);
                fn_obtieneTotalApagar();
                fn_resumenFormaPago();
                //fn_cancelarPago();
                $("#pagado").val("");
            });
        } else {
<<<<<<< HEAD
            send = { grabacanalmovimientoVoucher: 1 };
=======
            send = {"grabacanalmovimientoVoucher": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
            send.respuesta = idRespuesta;
            $.getJSON("config_facturacion.php", send, function (datos) { });
            alertify.alert(respuesta);
            return false;
        }
    } else {
        alertify.alert(tramaError);
        return false;
    }
}

function fn_regresarCliente() {
    $("#dominio1").css({
        display: "none",
        position: "absolute"
    });
    $("#dominio2").css({
        display: "none",
        position: "absolute"
    });
    $("#txtClienteCI").val("");
    $("#numPad").empty();
    fn_numerico(txtClienteCI);
    fn_ocultar_alfanumerico();
    $(".jb-shortscroll-wrapper").show();
    $("#listaFactura").shortscroll();
    $("#datosFactura").dialog("close");
    $("#datosFactura").dialog("destroy");
    $("#rdo_ruc").removeClass("btnRucCiInactivo");
    $("#rdo_ruc").addClass("btnRucCiActivo");
    $("#rdo_pasaporte").removeClass("btnRucCiActivo");
    $("#rdo_pasaporte").addClass("btnRucCiInactivo");
    $("#datosFactura").hide();
    $("#formasPago").show();
    $("#pagoTotal").val("0.00");
    $("#pagado").val("0.00");
    fn_resumenFormaPago();
    fn_limpiarInfo();
    $("#btnConsumidorFinal").show();
    $("#btnClienteGuardar").hide();
    $("#btnClienteGuardarActualiza").hide();
}


function fn_validaTeclado(id) {
    $("#dominio1").hide();
    $("#dominio2").hide();

    if ($("#hid_bandera_teclado").val() == 1) {
        fn_numerico(id);
    } else if ($("#hid_bandera_teclado").val() == 2) {
        fn_alfaNumericoo(id);
    } else {
        alertify.error("Ninguna configuracion para el teclado");
        return false;
    }
}

function fn_validaTecladoCedula() {
    $("#hid_bandera_teclado").val(1);
    $("#rdo_ruc").removeClass("btnRucCiInactivo");
    $("#rdo_ruc").addClass("btnRucCiActivo");
    $("#rdo_pasaporte").removeClass("btnRucCiActivo");
    $("#rdo_pasaporte").addClass("btnRucCiInactivo");
    fn_limpiarInfo();
    fn_bloquearIngreso();
    $("#txtClienteCI").focus();
    fn_numerico(txtClienteCI);
    fn_ocultar_alfanumerico();
}

// VISUALIZAR FACTURA
function fn_cargarFactura(cfac_id) {
    var html = "";
<<<<<<< HEAD
    send = { visorCabeceraFactura: 1 };
=======
    send = {"visorCabeceraFactura": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfac_id = cfac_id;
    $.getJSON("config_facturacion.php", send, function (datos) {
        if (datos.str > 0) {
            var tipo_facturacion = datos[0]["tf_id"];
            html =
                "<div class='facturacion'><br/><table width='220px' align='center'><tr><th align='center' colspan='4'>" +
                datos[0]["emp_razon_social"] +
                "</th></tr><tr><td align='center' colspan='4'>MATRIZ: " +
                datos[0]["emp_direccion"] +
                "</td></tr><tr><td style='padding-bottom:10px;' align='center' colspan='4'>RUC: " +
                datos[0]["emp_ruc"] +
                "</td></tr><tr>";
            if (tipo_facturacion == 2) {
                html = html + "<td align='center' colspan='4'>DETALLE DE FACTURA</td>";
            } else {
                html = html + "<td align='center' colspan='4'>DETALLE DE FACTURA ELECTRONICA</td>";
            }
<<<<<<< HEAD
            html =
                html +
                "</tr><tr><td style='padding-bottom:10px;' align='center' colspan='4'>DOCUMENTO SIN VALOR TRIBUTARIO</td></tr><tr><td align='left' colspan='4'># DOCUMENTO: " +
                datos[0]["documento"] +
                "</td></tr><tr><td align='left' colspan='4'>SUCURSAL: " +
                datos[0]["rst_direccion"] +
                "</td></tr><tr><td align='left' colspan='4'>SERV: " +
                datos[0]["usr_usuario"] +
                "</td></tr><tr><td align='left' colspan='4'>FECHA EMISION: " +
                datos[0]["cfac_fechacreacion"] +
                "</td></tr><tr><td align='left' colspan='4'>CLIENTE: " +
                datos[0]["cli_nombres"] +
                " " +
                datos[0]["cli_apellidos"] +
                "</td></tr><tr><td align='left' colspan='4'>RUC/CI: " +
                datos[0]["cli_documento"] +
                "</td></tr><tr><td align='left' colspan='4'>FONO: " +
                datos[0]["cli_telefono"] +
                "</td></tr><tr><td align='left' colspan='4'>DIREC.: " +
                datos[0]["cli_direccion"] +
                "</td></tr><tr><td colspan='4'>==============================================</td></tr><tr><td align='center'><b>CANT.</b></td><td align='center'><b>DESCRIPCION</b></td><td align='center'><b>P. UNIT</b></td><td align='center'><b>VALOR</b></td></tr>";
            send = { visorDetalleFactura: 1 };
=======
            html = html + "</tr><tr><td style='padding-bottom:10px;' align='center' colspan='4'>DOCUMENTO SIN VALOR TRIBUTARIO</td></tr><tr><td align='left' colspan='4'># DOCUMENTO: " + datos[0]['documento'] + "</td></tr><tr><td align='left' colspan='4'>SUCURSAL: " + datos[0]['rst_direccion'] + "</td></tr><tr><td align='left' colspan='4'>SERV: " + datos[0]['usr_usuario'] + "</td></tr><tr><td align='left' colspan='4'>FECHA EMISION: " + datos[0]['cfac_fechacreacion'] + "</td></tr><tr><td align='left' colspan='4'>CLIENTE: " + datos[0]['cli_nombres'] + " " + datos[0]['cli_apellidos'] + "</td></tr><tr><td align='left' colspan='4'>RUC/CI: " + datos[0]['cli_documento'] + "</td></tr><tr><td align='left' colspan='4'>FONO: " + datos[0]['cli_telefono'] + "</td></tr><tr><td align='left' colspan='4'>DIREC.: " + datos[0]['cli_direccion'] + "</td></tr><tr><td colspan='4'>==============================================</td></tr><tr><td align='center'><b>CANT.</b></td><td align='center'><b>DESCRIPCION</b></td><td align='center'><b>P. UNIT</b></td><td align='center'><b>VALOR</b></td></tr>";
            send = {"visorDetalleFactura": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
            send.cfac_id = cfac_id;
            $.getJSON("config_facturacion.php", send, function (datos) {
                if (datos.str > 0) {
                    for (i = 0; i < datos.str; i++) {
                        html =
                            html +
                            "<tr><td align='center'>" +
                            datos[i]["dtfac_cantidad"] +
                            "</td><td>" +
                            datos[i]["plu_descripcion"] +
                            "</td><td align='center'>" +
                            datos[i]["dtfac_precio_unitario"] +
                            "</td><td align='center'>" +
                            datos[i]["dtfac_total"] +
                            "</td></tr>";
                    }
<<<<<<< HEAD
                    send = { totalDetalleFactura: 1 };
=======
                    send = {"totalDetalleFactura": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                    send.cfac_id = cfac_id;
                    $.getJSON("config_facturacion.php", send, function (datos) {
                        if (datos.str > 0) {
<<<<<<< HEAD
                            html =
                                html +
                                "<tr><td align='center' colspan='4'>==============================================</td></tr><tr><td align='right' colspan='2'>SUBTOTAL.....$</td><td align='right' colspan='2'>" +
                                datos[0]["cfac_subtotal"] +
                                "</td></tr><tr><td align='right' colspan='4'>=============</td></tr><tr><td align='right' colspan='2'>BASE 12%.....$</td><td align='right' colspan='2'>" +
                                datos[0]["cfac_base_iva"] +
                                "</td></tr><tr><td align='right' colspan='2'>BASE 0%.....$</td><td align='right' colspan='2'>" +
                                datos[0]["cfac_base_cero"] +
                                "</td></tr><tr><td align='right' colspan='2'>I.V.A.12%.....$</td><td align='right' colspan='2'>" +
                                datos[0]["cfac_iva"] +
                                "</td></tr><tr><td align='right' colspan='4'>=============</td></tr><tr><td align='right' colspan='2'><b>TOTAL.....$:</b></td><td align='right' colspan='2'><b>" +
                                datos[0]["cfac_total"] +
                                "</b></td></tr>";
                            send = { formasPagoDetalleFactura: 1 };
=======
                            html = html + "<tr><td align='center' colspan='4'>==============================================</td></tr><tr><td align='right' colspan='2'>SUBTOTAL.....$</td><td align='right' colspan='2'>" + datos[0]['cfac_subtotal'] + "</td></tr><tr><td align='right' colspan='4'>=============</td></tr><tr><td align='right' colspan='2'>BASE 12%.....$</td><td align='right' colspan='2'>" + datos[0]['cfac_base_iva'] + "</td></tr><tr><td align='right' colspan='2'>BASE 0%.....$</td><td align='right' colspan='2'>" + datos[0]['cfac_base_cero'] + "</td></tr><tr><td align='right' colspan='2'>I.V.A.12%.....$</td><td align='right' colspan='2'>" + datos[0]['cfac_iva'] + "</td></tr><tr><td align='right' colspan='4'>=============</td></tr><tr><td align='right' colspan='2'><b>TOTAL.....$:</b></td><td align='right' colspan='2'><b>" + datos[0]['cfac_total'] + "</b></td></tr>";
                            send = {"formasPagoDetalleFactura": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                            send.cfac_id = cfac_id;
                            $.getJSON("config_facturacion.php", send, function (datos) {
                                if (datos.str > 0) {
                                    for (i = 0; i < datos.str; i++) {
                                        html =
                                            html +
                                            "<tr><td align='right' colspan='2'>" +
                                            datos[i]["fmp_descripcion"] +
                                            "</td><td align='right' colspan='2'>$" +
                                            datos[i]["cfac_total"] +
                                            "</td></tr>";
                                    }
                                    html = html + "</table></div>";
                                    $("#cabecerafactura").html(html);
                                }
                            });
                        }
                    });
                }
            });
        }
        $("#detalleFactura").shortscroll();
    });
}

function fn_visualizarFactura() {
    $("#listaFactura").empty();
    fn_actualizarFactura();
    //$('#detalleFactura').shortscroll();
    var Cod_Movimiento = $("#txtNumFactura").val(); //$('#listadoPedido').find("li.focus").attr("id"); // delet.
    $("#cabecerafactura").html("");
    $("#visorFacturas").css("display", "block");
    $("#detalleFactura").css("display", "block");
    if (Cod_Movimiento.substring(4, 5) == "F") {
        fn_cargarFactura(Cod_Movimiento);

    }
}

function fn_cerrarVisorFacturas() {
    $("#visorFacturas").css("display", "none");
    $("#detalleFactura").css("display", "none");
    fn_crearFacturaXml();
    fn_validaItemPagado();
}

function fn_limpiarCalculadora() {
    $(".desabilitado").removeAttr("Disabled");
    $("#pagado").val("");
    coma = 0;
}

function fn_desplegarMenu() {
    $("#rdn_pdd_brr_ccns").css("display", "block");
    $("#cnt_mn_dsplgbl_pcns_drch").css("display", "block");
}

function fn_validaAdmin() {
    if ($("#usr_claveAdmin").val() == "") {
        $("#usr_claveAdmin").focus();
        alertify.alert("Ingrese una clave.");
        return false;
    }
<<<<<<< HEAD
    send = { validarUsuarioAdministrador: 1 };
=======
    send = {"validarUsuarioAdministrador": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.usr_Admin = $("#usr_claveAdmin").val();
    send.facturaAuditoria = $("#txtNumFactura").val();
    $.getJSON("config_facturacion.php", send, function (datos) {
        $("#usr_claveAdmin").val("");
        if (datos.admini == 1) {
            if (lc_banderaOkAdmin == "salirSistema") {
                $("#credencialesAdmin").dialog("close");
                window.location.replace("../index.php"); //BOTON OK para salir del sistema
            } else if (lc_banderaOkAdmin == "otro") {
                $("#credencialesAdmin").dialog("close");
<<<<<<< HEAD
                send = { activaOpcionCobroTarjeta: 1 };
=======
                send = {"activaOpcionCobroTarjeta": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                send.opcionSwt = lc_tipoEnvio;
                send.opcion = "A";
                $.getJSON("config_facturacion.php", send, function (datos) {
                    $("#modalsubSWT").dialog("close");
                    $("#modalSWT").dialog("close");
                    $(".jb-shortscroll-wrapper").show();
                    fn_modalBinDatafast();
                });
            } else if (lc_banderaOkAdmin == "aplicaPago") {
                lc_banderaAplicapago = 1;
                $("#credencialesAdmin").dialog("close");
                $(".jb-shortscroll-wrapper").show();
                //$(".desabilitado").removeAttr("Disabled");
                //$("#visualizarFactura").hide();	
                $("#hid_bandera_cvv").val(1);
                fn_aplicaPagoSegunTipo();
            } //fin bandera aplica pago
            else if (lc_banderaOkAdmin == "banda") {
<<<<<<< HEAD
                send = { activaOpcionCobroTarjeta: 1 };
=======
                send = {"activaOpcionCobroTarjeta": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                send.opcionSwt = lc_tipoEnvio;
                send.opcion = "A";
                $.getJSON("config_facturacion.php", send, function (datos) {
                    $("#credencialesAdmin").dialog("close");
                    fn_validaConfiguracionBinTarjetaLectura();
                });
            } else if (lc_banderaOkAdmin == "pinpad") {
                $("#credencialesAdmin").dialog("close");
<<<<<<< HEAD
                send = { activaOpcionCobroTarjeta: 1 };
=======
                send = {"activaOpcionCobroTarjeta": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                send.opcionSwt = lc_tipoEnvio;
                send.opcion = "A";
                $.getJSON("config_facturacion.php", send, function (datos) {
                    valordelaTransaccionPinPad = parseFloat($("#pagoTotal").val());
<<<<<<< HEAD
                    send = { insertarRequerimientoAutorizacion: 1 };
=======
                    send = {"insertarRequerimientoAutorizacion": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
                    send.cfac = $("#txtNumFactura").val();
                    send.formaPagoID = $("#btnFormaPagoId").val();
                    send.valorTransaccion = parseFloat($("#pagoTotal").val());
                    if ($("#cantidad").val() == "") {
                        send.prop_valor = 0;
                    } else {
                        send.prop_valor = parseFloat($("#cantidad").val());
                    }
                    if (banderaa == 1) {
                        send.valorTransaccionPinPad = $("#pagado").val();
                    } else {
                        if (valordelaTransaccionPinPad != 0) {
                            send.valorTransaccionPinPad = $("#pagado").val();
                        } else {
                            send.valorTransaccionPinPad = $("#pagoGranTotal").val();
                        }
                    }
                    send.tipoEnvioPinPad = lc_tipoEnvio;
                    send.tipoTransaccionPinpad = "01";
                    $.getJSON("config_facturacion.php", send,
<<<<<<< HEAD
                        function(datos) {
                        lc_control = 0;
                            cargando(0);
                            fn_timeout();
                            fn_esperaRespuesta();
                        }
=======
                            function (datos) {
                                lc_control = 0
                                cargando(0);
                                fn_timeout();
                                fn_esperaRespuesta();
                            }
>>>>>>> origin/MXP_Version_1.9.10.6
                    );
                });
            }
        } else {
            alertify.alert("Clave incorrecta.");
            $("#usr_claveAdmin").val("");
            return false;
        }
    });

}

function fn_modalBinDatafast() {
    $("#modal_binDatafast").dialog({
        modal: true,
        resizable: false,
        closeOnEscape: false,
        position: "center",
        draggable: false,
        width: 500,
        heigth: 500,
        opacity: 0,
        show: "none",
        hide: "none",
        duration: 500,
        buttons: {
<<<<<<< HEAD
            Aceptar: function() {
                fn_validarBinTarjetaDatafast();
            },
            Cancelar: function() {
=======
            "Aceptar": function () {
                fn_validarBinTarjetaDatafast();
            },
            "Cancelar": function () {
>>>>>>> origin/MXP_Version_1.9.10.6
                $(this).dialog("close");
                $(".jb-shortscroll-wrapper").show();
                $("#pagado").val("");
                $("#txt_bin").val("");
            }
        }
    });
}

function fn_validarBinTarjetaDatafast() {
<<<<<<< HEAD
    if ($("#txt_bin").val().length == 6) {
        send = { validaFormaBinDatafast: 1 };
=======
    if (($("#txt_bin").val().length) == 6) {
        send = {"validaFormaBinDatafast": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.binTarjetaDatafast = $("#txt_bin").val();
        $.getJSON("config_facturacion.php", send, function (datos) {
            $("#modal_binDatafast").dialog("close");
            $(".jb-shortscroll-wrapper").show();
            $("#txt_bin").val("");
            if (datos.confirma == 1) {
                fn_insertaFormaPagoTarjetaDatafast(datos.idFormaPago);
            } else {
                $("#pagado").val("");
                alertify.error(datos.mensaje);
                return false;
            }

        });
    } else {
        alertify.error("Bin Incorrecto. Ingrese Nuevamente.");
        $("#txt_bin").val("");
        return false;
    }
}

function fn_insertaFormaPagoTarjetaDatafast(idFormaPago) {
    var aPagar = parseFloat($("#pagoTotal").val());
    if ($("#pagado").val() == "" || $("#pagado").val() == 0) {
        pagado = $("#pagoTotal").val();
        total = $("#pagoTotal").val();
        $("#pagado").val(total);
    }
    var pagado = parseFloat($("#pagado").val());
    var valor = aPagar - pagado;
    $("#hid_cambio").val(valor);
    var btnNombre = $("#btnAplicarPago").attr("title");
    $("#pagoTotal").val(valor.toFixed(2));

<<<<<<< HEAD
    send = { ingresaFormaPagoTarjeta: 1 };
=======
    send = {"ingresaFormaPagoTarjeta": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.codFactTarjeta = $("#txtNumFactura").val();
    send.fmpIdTarjeta = idFormaPago; //$("#btnFormaPagoId").val();
    send.fmpNumSegtar = 0;
    if ($("#pagoTotal").val() >= $("#pagado").val() || $("#pagoTotal").val() == $("#pagado").val()) {
        send.frmPagoTotalTarjeta = $("#pagado").val();
        send.fctTotalTarjeta = $("#pagado").val();
    } else {
        send.frmPagoTotalTarjeta = $("#pagado").val();
        send.fctTotalTarjeta = $("#pagado").val();
    }
    send.SwtTipo = 3; //lc_tipoEnvio;
    if ($("#cantidad").val() == "") {
        send.propina_valor = 0;
    } else {
        send.propina_valor = parseFloat($("#cantidad").val());
    }
    $.getJSON("config_facturacion.php", send, function (datos) {
        lc_control = 0;
        var btnNombre = $("#btnAplicarPago").attr("title");
        $("#pagado").val("");
        if (valor <= 0 && btnNombre != "EFECTIVO") {
            fn_buscaPagoCredito(); // fn_envioFactura();
        }
        var html = "";
        if (datos.str > 0) {
            $("#btnCancelarPago").attr("disabled", false);
            for (i = 0; i < datos.str; i++) {
                html += "<tr>";
                html +=
                    "<td width='130px' align='right'>" +
                    datos[i]["fmp_descripcion"] +
                    "</td><td width='40px' align='center'>$</td>";
                html +=
                    "<td width='100px' align='center'>" +
                    parseFloat(datos[i]["fpf_total_pagar"]).toFixed(2) +
                    "</td>";
                html += "</tr>";
            }
            $("#formasPago2").html(html);
        } else {
            $("#btnCancelarPago").attr("disabled", true);
            alertify.alert("Error al registrar la factura");
        }
    });
}

function fn_cerrarValidaAdmin() {
    $(".jb-shortscroll-wrapper").show();
    $("#credencialesAdmin").dialog("close");
    $("#usr_claveAdmin").val("");
    $("#pagado").val("");
    $("#modalSWT").dialog("close");
    $("#modalsubSWT").dialog("close");
}

function fn_sumarBillete() {
    $(".desabilitado").removeAttr("Disabled");
    sumar = $("#can_sumar").val();
    sumar = sumar + sumar;
}

function fn_cargaDivBilletes() {
    if ($("#hidVitality").val() == 1) {
        $("#izquierdo").hide();
    } else {
    simboloMon = $("#simMoneda").val();
<<<<<<< HEAD
        var send = { cargaBilletes: 1 };
    $.getJSON("config_facturacion.php", send, function(datos) {
=======
    send = {"cargaBilletes": 1};
    $.getJSON("config_facturacion.php", send, function (datos) {
>>>>>>> origin/MXP_Version_1.9.10.6
        if (datos.str > 0) {
            $("#lista_billetes").empty();
                for (var i = 0; i < datos.str; i++) {
                    html =
                        "<button class='btnDinero desabilitado' id='btn" +
                        i +
                        "' title='Billete 1' onclick='fn_billete(" +
                        datos[i]["btd_Valor"] +
                        ',"' +
                        datos[i]["descFp"] +
                        '","' +
                        datos[i]["idFp"] +
                        '","' +
                        datos[i]["tfpId"] +
                        '","' +
                        datos[i]["descTfp"] +
                        '",' +
                        datos[i]["autoriza"] +
                        ")'><b>" +
                        simboloMon +
                        " " +
                        "" +
                        datos[i]["btd_Valor"] +
                        "</b></button>";
                $("#lista_billetes").append(html);
            }
        }
    });
        $("#izquierdo").show();
    }
}

function fn_cargaTeclasEmail() {
<<<<<<< HEAD
    var send = { cargaTeclasEmail: 1 };
    $.getJSON("config_facturacion.php", send, function(datos) {
=======
    send = {"cargaTeclasEmail": 1};
    $.getJSON("config_facturacion.php", send, function (datos) {
>>>>>>> origin/MXP_Version_1.9.10.6
        if (datos.str > 0) {
            $("#dominio1").empty();
            $("#dominio2").empty();
            for (var i = 0; i < datos.str; i++) {
                html =
                    "<button class='btnVirtualDominio' style='font-size: 13px;' onclick='fn_agregarCaracterCorreo(txtCorreo,\"" +
                    datos[i]["descripcionEmail"] +
                    "\")'>" +
                    datos[i]["descripcionEmail"] +
                    "</button><br/>";
                if (i < 5) {
                    $("#dominio1").append(html);
                } else {
                    $("#dominio2").append(html);
                }
            }
        }
    });
}

function fn_abreModalCliente() {
    cerrarModalAgegadores();

    $(".jb-shortscroll-wrapper").hide();
    $("#usr_claveAdmin").val("");
    $("#credencialesAdmin").show();
    $("#credencialesAdmin").dialog({
        modal: true,
        draggable: false,
        width: 500,
        heigth: 500,
        resizable: false,
        opacity: 0,
        show: "none",
        hide: "none",
        duration: 500
    });
}


function fn_inicio() {

    var pantalla = "tomaPedido";
<<<<<<< HEAD
    var send = { obtenerMesa: 1 };
=======
    send = {"obtenerMesa": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.rst_id = $("#idRest").val();
    $.getJSON("config_facturacion.php", send, function (datos) {


        pantalla = "fidelizacion_inicio";

        if (datos.str > 0) {
            var mesa = datos["mesa_asignada"];
            window.location.replace("../ordenpedido/" + pantalla + ".php?numMesa=" + mesa);
        } else {
            window.location.replace("../ordenpedido/" + pantalla + ".php");
        }
    });
}

//FUNCION OBTENER NUMERO DE MESA
function fn_obtenerMesa() {

    var pantalla = "tomaPedido";
<<<<<<< HEAD
    var send = { obtenerMesa: 1 };
    send.rst_id = $("#idRest").val();
    send.odp_id = $("#txtOrdenPedidoId").val();
    $.getJSON("config_facturacion.php", send, function(datos) {
        pantalla =
            datos["fidelizacion_Activa"] === 1 ? "fidelizacion_fin" : "tomaPedido";
=======
    send = {"obtenerMesa": 1};
    send.rst_id = $("#idRest").val();
    send.odp_id = $("#txtOrdenPedidoId").val();
    $.getJSON("config_facturacion.php", send, function (datos) {

        pantalla = (datos["fidelizacion_Activa"] === 1) ? "fidelizacion_fin" : "tomaPedido";
>>>>>>> origin/MXP_Version_1.9.10.6
        var parametros = "";
        if (datos["fidelizacion_Activa"] === 1) {
            parametros = "numFactura=" + $("#txtNumFactura").val() + "&rst_id=" + $("#txtRestaurante").val() + "&cdn_id=" + $("#txtCadenaId").val() + "&op_id=" + $("#txtOrdenPedidoId").val() + "&tipo_s=" + $("#txtTipoServicio").val();
        }
        if (datos.str > 0) {
            var mesa = datos["mesa_asignada"];
            if (datos["esDivisionCuenta"] === 1) {
                var odp_id = $("#txtOrdenPedidoId").val();
                var mesa_id = $("#txtNumMesa").val();
                var imp = $("#hide_cdn_tipoimpuesto").val();
                var est_ip = $("#txt_est_ip").val();
                var rst_id = $("#txtRestaurante").val();
                var url =
                    "../ordenpedido/separarCuentas.php?odp_id=" +
                    odp_id +
                    "&mesa_id=" +
                    mesa_id +
                    "&cdn_tipoimpuesto=" +
                    imp +
                    " &est_ip=" +
                    est_ip +
                    "&cat_id=" +
                    datos["rst_cat"] +
                    "&rst_id=" +
                    rst_id;
                window.location.replace(url);
            } else {
                //alert(datos['mesa_asignada']);
                window.location.replace("../ordenpedido/" + pantalla + ".php?numMesa=" + mesa + "&" + parametros);
            }
        } else {
            window.location.replace("../ordenpedido/" + pantalla + ".php" + parametros);
        }
    });
}

/*Funcion para ingresar caracteres del Bin para pagos con tarjeta de datafast*/
function fn_agregarBinTarjeta(valor) {
    if ($("#txt_bin").val().length < 6) {
        lc_caracter = document.getElementById("txt_bin").value;
        $("#txt_bin").val("");
        lc_caracter = lc_caracter + valor;
        document.getElementById("txt_bin").value = lc_caracter;
    }
}

/*Funcion para borrar caracteres del Bin para pagos con tarjeta de datafast*/
function fn_eliminarBin() {
    $("#txt_bin").val("");
}

/*Funcion para eliminar digito a digito el bin de la tarjeta*/
function fn_eliminarDigitoBin() {
    var lc_digito = $("#txt_bin").val();
    lc_digito = lc_digito.substring(0, lc_digito.length - 1);
    $("#txt_bin").val(lc_digito);
}


///////////////////////////////////////////////FUNCION PARA IMAGEN DE CARGANDO////////////////////////////////////////////////////////////
function fn_cargando(std) {
    if (std > 0) {
        $("#mdl_rdn_pdd_crgnd").show();
    } else {
        $("#mdl_rdn_pdd_crgnd").hide();
    }
}


//////////////LISTA LOS DESCUENTOS PARA INGRESAR////////////////////////////////////////////
function fn_listaDescuentos() {
    $("#descuentosContenedor").show();
    fn_cargando(1);
    $("#descuentosContenedor").dialog({
        modal: true,
        position: "center",
        closeOnEscape: false,
        width: 500,
        height: 465,
        draggable: false,
        resizable: false,
        open: function () {
            $(".ui-dialog-titlebar").show();
        }
    });
    $(".ui-dialog-titlebar").empty();
<<<<<<< HEAD
    $(".ui-dialog-titlebar").css({
        background: "#0E98B6",
        color: "#FFFFFF",
        "text-align": "center"
    });
    $(".ui-dialog-titlebar").append("Seleccione descuento que desea aplicar");
    var send = { consultaDescuentos: 1 };
=======
    $(".ui-dialog-titlebar").css({'background': '#0E98B6', 'color': '#FFFFFF', 'text-align': 'center'});
    $(".ui-dialog-titlebar").append('Seleccione descuento que desea aplicar');


    send = {"consultaDescuentos": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfac_id = $("#txtNumFactura").val();
    $.ajax({
        async: false,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str > 0) {
                $(".descuentosLabel ul").empty();
                for (var i = 0; i < datos.str; i++) {
                    if (datos[i]["tipoDescuento"] == "% Porcentaje") {
                        html =
                            "<li id='" +
                            datos[i]["iddescuentos"] +
                            "' style='background:#E8B80C; font-weight:bold;' onclick='fn_modificarLista(\"" +
                            datos[i]["iddescuentos"] +
                            "\")' >" +
                            datos[i]["apld_descripcion"] +
                            "</li>";
                        $("#listadescuento").append(html);
                    } else {
                        html =
                            "<li id='" +
                            datos[i]["iddescuentos"] +
                            "' style='background:#4FB6D8; font-weight:bold;' onclick='fn_modificarLista(\"" +
                            datos[i]["iddescuentos"] +
                            "\")' >" +
                            datos[i]["apld_descripcion"] +
                            "</li>";
                        $("#listadescuento").append(html);
                    }
                }
            } else {
                $("#listadescuento").html("");
                alertify.alert("No existen descuentos registrados");
            }
        }
    });
    fn_cargando(0);
}


///////////////////////////////////////////CIERRA LOS MODALES LISTA_DESCUENTOS, CREDENCIALES_ADMINISTRADOR//////////////////////////////
function fn_cerrarDialogoDescuentosContenedor() {
    $("#usr_clave1").val("");
    $("#descuentosContenedor").dialog("close");
    $("#descuentosDiscrecionalesContenedor").dialog("close");
    $("#credencialesContenedor").dialog("close");
}

///////////////////////////////////////MODIFICA EL ESTADO DE LA LISTA AL SELECCIONAR EL DESCUENTO////////////////////////////////
function fn_modificarLista(codigo) {
<<<<<<< HEAD
    $("#listadescuento li.focus").css({ "font-size": "16px" });
    $("#listadescuento")
        .find(".focus")
        .removeClass("focus");
    $("#" + codigo).css({ "font-size": "22px" });
    $("#" + codigo).addClass("focus");
=======
    $('#listadescuento li.focus').css({"font-size": "16px"});
    $('#listadescuento').find(".focus").removeClass("focus");
    $('#' + codigo).css({"font-size": "22px"});
    $('#' + codigo).addClass('focus');
>>>>>>> origin/MXP_Version_1.9.10.6
}


///////////////////////////////////////////////AGREGA DESCUENTO DE MANERA MANUAL////////////////////////////////////////////////
function fn_agregarDescuento() {
    if (!$("li.focus").length) {
        alertify.error("Seleccione un descuento.");
    } else {
        $("#descuentosContenedor").dialog("close");
        //var valoresDescuentos = "";
<<<<<<< HEAD
        var send = { agregarDescuento: 1 };
=======
        send = {"agregarDescuento": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.cfac_id = $("#txtNumFactura").val();
        var desc_id = $("#listadescuento")
            .find("li.focus")
            .attr("id");
        send.desc_id = desc_id;
        $.ajax({
            async: false,
            url: "config_facturacion.php",
            data: send,
            dataType: "json",
            success: function (datos) {
                if (datos.str > 0) {
                    if (datos[0]["desc_estado"] > 0) {
                        fn_cargando(1);

                        //ACTUALIZO LOS VALORES CON EL DESCUENTO
                        $("#listaFactura").empty();
                        for (var i = 0; i < datos.str; i++) {
                            if (datos[i]["desc_descuento"] > 0) {
                                var porcentajeDesc = datos[i]["porcentaje"];

                                if (porcentajeDesc != 0) {
                                    html = "<li id='item1' style='background:#7FCF83;'><div class='listaproductosCant'>";
                                } else {
                                    html = "<li id='item1' style='background:#4FB6D8;'><div class='listaproductosCant'>";
                                }

                                if (datos[i]["totalizado"] != 0) {
                                    html += "" + parseFloat(datos[i]["desc_cantidad"]) + "";
                                } else {
                                    html += "  &nbsp;&nbsp;";
                                }

                                html += "</div>";
                                html +=
                                    "<div class='listaproductosDesc'>" +
                                    datos[i]["desc_descripcion"] +
                                    "</div>";
                                html += "<div class='listaproductosVal'>";

                                if (datos[i]["totalizado"] != 0) {
                                    html +=
                                        "" +
                                        moneda +
                                        " " +
                                        parseFloat(datos[i]["totalizado"]).toFixed(2) +
                                        "";
                                } else {
                                    html += "";
                                }

                                html += "</div></li><br/>";

                                if (porcentajeDesc != 0) {
                                    html += "<li id='item1' style='background:#7FCF83; font-size:13px; height:18px;'><div class='listaproductosCant'>";
                                } else {
                                    html += "<li id='item1' style='background:#4FB6D8;; font-size:13px; height:18px;'><div class='listaproductosCant'>";
                                }

                                html += "&ensp;&ensp;";
                                html += "</div>";

                                if (porcentajeDesc != 0) {
                                    html += "<div class='listaproductosDesc' style='text-align: right;'>Descuento: " + porcentajeDesc + "%</div>";
                                } else {
                                    html += "<div class='listaproductosDesc' style='text-align: right;'>Descuento:</div>";
                                }

                                html += "<div class='listaproductosVal'>";
                                html +=
                                    "" +
                                    moneda +
                                    " " +
                                    parseFloat(datos[i]["desc_descuento"]).toFixed(2) +
                                    "";
                                html += "</div></li><br/>";
                            } else {
                                html = "<li id='item1' style='background:white;'><div class='listaproductosCant'>";
                                if (datos[i]["totalizado"] != 0) {
                                    html += "" + parseFloat(datos[i]["desc_cantidad"]) + "";
                                } else {
                                    html += "  &nbsp;&nbsp;";
                                }
                                html += "</div>";
                                html +=
                                    "<div class='listaproductosDesc'>" +
                                    datos[i]["desc_descripcion"] +
                                    "</div>";
                                html += "<div class='listaproductosVal'>";
                                if (datos[i]["totalizado"] != 0) {
                                    html +=
                                        "" +
                                        moneda +
                                        " " +
                                        parseFloat(datos[i]["totalizado"]).toFixed(2) +
                                        "";
                                } else {
                                    html += "";
                                }
                                html += "</div></li><br/>";
                            }
                            $("#listaFactura").append(html);
                        }
                        lc_cantidadPagada = parseFloat(datos[0]["desc_valor"]).toFixed(2);
                        fn_listaTotales();
                        fn_cargando(0);
                    } else {
                        alertify.alert(datos[0]["desc_mensaje"]);
                    }
                }
            }
        });
    }
}


///////////////////////////////////////////////ELIMINA LOS DESCUENTOS AGREGADOS ////////////////////////////////////////////////
function fn_eliminarDescuento() {
    var idOrdenPedido = $("#txtOrdenPedidoId").val();
    var idFactura = $("#txtNumFactura").val();
    var idMesa = $("#txtNumMesa").val();
    var idDopCuenta = $("#txtNumCuenta").val();
<<<<<<< HEAD
    var send = { eliminarDescuento: 1 };
=======
    send = {"eliminarDescuento": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfac_id = idFactura;
    send.idCabeceraOrdenPedido = idOrdenPedido;
    $.ajax({
        async: false,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str > 0) {
                if (datos[0]["elim_estado"] > 0) {
                    //var odp_id = document.getElementById("hide_odp_id").value;
                    //var mesa_id = document.getElementById("hide_mesa_id").value;
                    $("#formCobrar").html(
                        '<form action="../facturacion/factura.php" name="cobro" method="post" style="display:none;"><input type="text" name="odp_id" value="' +
                        idOrdenPedido +
                        '" /><input type="text" name="dop_cuenta" value="' +
                        idDopCuenta +
                        '" /><input type="text" name="mesa_id" value="' +
                        idMesa +
                        '" /></form>'
                    );
                    document.forms["cobro"].submit();
                    //lc_cantidadPagada = (parseFloat(datos[0]['elim_valor']).toFixed(2));
                    //fn_listaTotales();
                    //detallesDescuentosDiscrecionales();
                } else {
                    alertify.alert(datos[0]["elim_mensaje"]);
                }
            }

        }
    });
}

///////////////////////////////VALIDA LAS CREDENCIALES DE ADMINISTRADOR PARA APLICAR DESCUENTO MANUAL/////////////////////////////////
function fn_validar_usuario(num) {
    var opcion = num;
    var usr_clave = $("#usr_clave1").val();
    if (usr_clave != "") {
<<<<<<< HEAD
        var send = { validarUsuarioDescuentos: 1 };
=======
        send = {"validarUsuarioDescuentos": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
        send.usr_clave = usr_clave;
        $.ajax({
            async: false,
            url: "config_facturacion.php",
            data: send,
            dataType: "json",
            success: function (datos) {
                if (datos.str > 0) {
                    $("#anulacionesContenedor").dialog("close");
                    $("#usr_clave1").val("");
                    $("#credencialesContenedor").dialog("close");
                    //opciones para el cuadro de credenciales
                    if (opcion == 1) {
                        fn_listaDescuentos();
                    }
                    if (opcion == 2) {
                        fn_eliminarDescuento();
                    }
                    if (opcion == 3) {
                        //guardarDescuentosDiscrecionales();
                        fn_listaDescuentosDiscrecionales();
                    }

                } else {
                    alertify.alert("No tienes permiso de administrador", function (e) {
                        if (e) {
                            alertify.set({buttonFocus: "none"});
                            $("#usr_clave1").focus();
                        }
                    });
                    $("#usr_clave1").val("");
                }
            }
        });
    } else {
        alertify.alert("Por favor ingrese una clave de administrador.", function (e) {
            if (e) {
                alertify.set({buttonFocus: "none"});
                $("#usr_clave1").focus();
            }
        });
        $("#usr_clave1").val("");
    }
}

///////////////////////////// Modal credenciales de administrador /////////////////////////////////////
function fn_dialogCredenciales1(num) {
    var opcion = num;
    $("#credencialesContenedor").show();
    $("#credencialesContenedor").dialog({
        modal: true,
        position: "center",
        closeOnEscape: false,
        width: 500,
        height: 440,
        draggable: false,
        resizable: false,
        open: function () {
            $(".ui-dialog-titlebar").hide();
            fn_numericoCredenciales("#usr_clave1", opcion);
        }
    });
}

///////////////////////////////////////HABILITA LOS BOTONES DESCUENTOS-ELIMINAR DESCUENTOS////////////////////////////////////////
function fn_cargarAccesosSistema() {
<<<<<<< HEAD
    var tipoS = $("#txtTipoServicio").val();
    send = { cargarAccesosPerfil: 1 };
    send.pnt_id = "facturacion.php";
=======
    var tipoS = $('#txtTipoServicio').val();
    send = {"cargarAccesosPerfil": 1};
    send.pnt_id = 'facturacion.php';
>>>>>>> origin/MXP_Version_1.9.10.6
    $.ajax({
        async: false,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str > 0) {
                for (i = 0; i < datos.str; i++) {
                    switch (datos[i]["acc_descripcion"]) {
                        case "Descuentos":
                            $("#btn_descuentos").attr("disabled", false);
                            $("#btn_descuentos").removeClass("boton_Opcion_Bloqueado");
                            $("#btn_descuentos").addClass("boton_Opcion");
                            break;
                        case "Eliminar Descuentos":
                            $("#btn_eliminar_descuentos").attr("disabled", false);
                            $("#btn_eliminar_descuentos").removeClass(
                                "boton_Opcion_Bloqueado"
                            );
                            $("#btn_eliminar_descuentos").addClass("boton_Opcion");
                            break;
                        case "Descuento Discrecional":
                            $("#btnDescuentoDiscrecional").attr("disabled", false);
                            $("#btnDescuentoDiscrecional").removeClass(
                                "boton_Opcion_Bloqueado"
                            );
                            $("#btnDescuentoDiscrecional").addClass("boton_Opcion");
                            break;
                        case "Imprimir Pre-Cuenta":
                            if (
                                $("#btn_imprimir").attr("servicio") === tipoS ||
                                $("#btn_imprimir").attr("servicio") === undefined
                            ) {
                                $("#btn_imprimir").attr("disabled", false);
                                $("#btn_imprimir").removeClass("boton_Accion_Bloqueado");
                                $("#btn_imprimir").addClass("boton_Accion");
                            }
                            break;
                        case "Salir":
                            $("#regresar").attr("disabled", false);
                            $("#regresar").removeClass("boton_Opcion_Bloqueado");
                            $("#regresar").addClass("boton_Opcion");
                            break;
                    }
                }
            }
        }
    });
}

/////////////////////////MODAL PARA DESCUENTOS DISCRECIONALES///////////////
function fn_modalDescuentoDiscrecionales() {
    $("#descuentosDiscrecionalesContenedor").show();
    $("#descuentosDiscrecionalesContenedor").dialog({
        modal: true,
        position: "center",
        closeOnEscape: false,
        width: 650,
        height: 465,
        draggable: false,
        resizable: false,
        open: function () {
            $(".ui-dialog-titlebar").show();
        }
    });
    $(".ui-dialog-titlebar").empty();
<<<<<<< HEAD
    $(".ui-dialog-titlebar").css({
        background: "#0E98B6",
        color: "#FFFFFF",
        "text-align": "center"
    });
    $(".ui-dialog-titlebar").append("Aplique los descuentos");
=======
    $(".ui-dialog-titlebar").css({'background': '#0E98B6', 'color': '#FFFFFF', 'text-align': 'center'});
    $(".ui-dialog-titlebar").append('Aplique los descuentos');
>>>>>>> origin/MXP_Version_1.9.10.6
}

/////////////////////////////LISTA TODOS LOS PRODUCTOS QUE SE PUEDE APLICAR DSCT DISCRECIONAL//////////////////
function fn_listaDescuentosDiscrecionales() {
    fn_modalDescuentoDiscrecionales();
    var idFactura = $("#txtNumFactura").val();
<<<<<<< HEAD
    send = { descuentosDiscrecionales: 1 };
=======
    send = {"descuentosDiscrecionales": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.accion = 1;
    send.cfac_id = idFactura;
    $.ajax({
        async: false,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str > 0) {
                html = "";
                $("#listaDiscrecionales").empty();
                for (i = 0; i < datos.str; i++) {
                    //html = "<tr id='listaDescuentosDiscrecionales'><td id='descripcionProductos' width='440px'>" + datos[i]['descripcion'] + "</td><td id='valorDescuentoDiscrecional' align='center'><select><option>10%</option><option>15%</option></select></td></tr>"
                    html = "<div class='productoDiscrecional'>";
                    html +=
                        "<input type='hidden' id='" +
                        datos[i]["plu_id"] +
                        "' class='idDiscrecional'/>";
                    html +=
                        "<div class='descripcionProducto' style='width: 55%; float: left; height:50px; padding-top: 18px;'>" +
                        datos[i]["descripcion"] +
                        "</div>";
                    html += "<div class='valorDescuentoDiscrecional' style='width: 40%!important; float: left;'><span>DSCT %: </span>";
                    html += listaPorcentajesDiscrecionales();
                    html += "</div>";
                    html += "</div>";
                    $("#listaDiscrecionales").append(html);
                }
            } else {
                $("#listadescuento").html("");
                alertify.alert("No existen descuentos registrados");
                $("#descuentosDiscrecionalesContenedor").dialog("close");
            }
        }
    });
}

//GUARDANDO DESCUENTOS DISCRECIONALES
function guardarDescuentosDiscrecionales() {
    $("#descuentosDiscrecionalesContenedor").dialog("close");
    var cadenaProductosDiscrecionales = crearStringproductosDiscrecionalesSeleccionados;
    var idFactura = $("#txtNumFactura").val();
<<<<<<< HEAD
    send = { guardarDescuentosDiscrecionales: 1 };
=======
    send = {"guardarDescuentosDiscrecionales": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfac_id = idFactura;
    send.cadenaProductosDiscrecionales = cadenaProductosDiscrecionales;
    $.ajax({
        async: false,
        type: "POST",
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str > 0) {
                if (datos[0]["discrecional_estado"] > 0) {
                    lc_cantidadPagada = parseFloat(
                        datos[0]["discrecional_valor"]
                    ).toFixed(2);
                    fn_listaTotales();
                    detallesDescuentosDiscrecionales();
                } else {
                    alertify.alert(datos[0]["discrecional_mensaje"]);
                }

            }

        }
    });
}

//AGREGANDO CARACTERES PARA PODER ENCIAR CADENA A LA BDD
function crearStringproductosDiscrecionalesSeleccionados() {
    var arrayProductos = productosDiscrecionalesSeleccionados();
    var arrayStrings = [];
    arrayProductos.forEach(function (element) {
        arrayStrings.push(element.idDiscrecioinal + "_" + element.descrip_pro + "_" + element.valorDiscrecreacinal);
    });
    return arrayStrings.join("_") + "_";
}

//OBTENIENDO LOS VALORES DE DESCUENTO POR PRODUCTO         
function productosDiscrecionalesSeleccionados() {
    var productosDiscrecionales = [];
    //var restaurantesFechas = [];
    $(".productoDiscrecional").each(function (index) {
        $this = $(this);
        var idDiscrecional = $this.find(".idDiscrecional").attr("id");
        var descripcionProducto = $this.find(".descripcionProducto").text();
        var valorDescuentoDiscrecional = $this.find("#valorDiscrecional").val();
        var listaDescuentos = {
            idDiscrecioinal: idDiscrecional,
            descrip_pro: descripcionProducto,
            valorDiscrecreacinal: valorDescuentoDiscrecional
        };
        productosDiscrecionales.push(listaDescuentos);
    });
    return productosDiscrecionales;
}

//LISTA PORCENTAJES DE DESCUENTO DISCRECIONAL
function listaPorcentajesDiscrecionales() {
    var optionHtml = "";
    var idFactura = $("#txtNumFactura").val();
<<<<<<< HEAD
    var send = { listaPorcentajesDiscrecionales: 1 };
=======
    send = {"listaPorcentajesDiscrecionales": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.accion = 2;
    send.cfac_id = idFactura;
    $.ajax({
        async: false,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str > 0) {
                optionHtml = "<select id='valorDiscrecional' class='cntSelectMovimiento select' style='width: auto!important;'>";
                optionHtml += "<option value='0' selected >0</option>";
                for (var j = 0; j < datos.str; j++) {
                    optionHtml +=
                        "<option value='" +
                        datos[j]["valorDiscrecional"] +
                        "'>" +
                        datos[j]["valorDiscrecional"] * 100 +
                        "</option>";
                }
                optionHtml += "</select>";
            } else {
                optionHtml = "<select id='valorDiscrecional' class='cntSelectMovimiento select' style='width: auto!important;'>";
                optionHtml += "<option value='0'>0</option>";
                optionHtml += "</select>";
            }
        }
    });
    return optionHtml;
}

//LISTA LOS PRODUCTOS CON LOS DETALLES DEL DESCUENTO DISCRECIONAL
function detallesDescuentosDiscrecionales() {
    var idFactura = $("#txtNumFactura").val();
<<<<<<< HEAD
    var send = { detallesDescuentosDiscrecionales: 1 };
=======
    send = {"detallesDescuentosDiscrecionales": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfac_id = idFactura;
    $.ajax({
        async: false,
        url: "config_facturacion.php",
        data: send,
        dataType: "json",
        success: function (datos) {
            if (datos.str > 0) {

                $("#listaFactura").empty();
                for (var i = 0; i < datos.str; i++) {
                    if (datos[i]["porcentajeDiscrecional"] > 0) {
                        html =
                            "<li id='item1' style='background:#E8D81C;'><div class='listaproductosCant'>";

                        if (datos[i]["totalizado"] != 0) {
                            html += "" + datos[i]["dtfac_cantidad"] + "";
                        } else {
                            html += "  &nbsp;&nbsp;";
                        }

                        html += "</div>";
                        html +=
                            "<div class='listaproductosDesc'>" +
                            datos[i]["plu_descripcion"] +
                            "</div>";
                        totalItem =
                            datos[i]["dtfac_precio_unitario"] * datos[i]["dtfac_cantidad"];
                        html += "<div class='listaproductosVal'>";

                        if (datos[i]["totalizado"] != 0) {
                            html +=
                                "" +
                                moneda +
                                " " +
                                parseFloat(datos[i]["totalizado"]).toFixed(2) +
                                "";
                        } else {
                            html += "";
                        }

                        html += "</div></li><br/>";
                        html += "<li id='item1' style='background:#E8D81C; font-size:13px; height:18px;'><div class='listaproductosCant'>";
                        html += "&ensp;&ensp;";
                        html += "</div>";
                        html +=
                            "<div class='listaproductosDesc' style='text-align: right;'>Descuento: " +
                            datos[i]["porcentajeDiscrecional"] +
                            "%</div>";
                        html += "<div class='listaproductosVal'>";
                        html +=
                            "" +
                            moneda +
                            " " +
                            parseFloat(datos[i]["descuento"]).toFixed(2) +
                            "";
                        html += "</div></li><br/>";
                    }

                    if (
                        datos[i]["desc_valorFijo"] > 0 ||
                        datos[i]["desc_porcentaje"] > 0
                    ) {
                        html = "<li id='item1' style='background:#7FCF83;'><div class='listaproductosCant'>";

                        if (datos[i]["totalizado"] != 0) {
                            html += "" + datos[i]["dtfac_cantidad"] + "";
                        } else {
                            html += "  &nbsp;&nbsp;";
                        }

                        html += "</div>";
                        html +=
                            "<div class='listaproductosDesc'>" +
                            datos[i]["plu_descripcion"] +
                            "</div>";
                        totalItem =
                            datos[i]["dtfac_precio_unitario"] * datos[i]["dtfac_cantidad"];
                        html += "<div class='listaproductosVal'>";

                        if (datos[i]["totalizado"] != 0) {
                            html +=
                                "" +
                                moneda +
                                " " +
                                parseFloat(datos[i]["totalizado"]).toFixed(2) +
                                "";
                        } else {
                            html += "";
                        }

                        html += "</div></li><br/>";
                        html += "<li id='item1' style='background:#7FCF83; font-size:13px; height:18px;'><div class='listaproductosCant'>";
                        html += "&ensp;&ensp;";
                        html += "</div>";

                        if (datos[i]["desc_porcentaje"] != 0) {
                            html +=
                                "<div class='listaproductosDesc' style='text-align: right;'>Descuento: " +
                                datos[i]["desc_porcentaje"] +
                                "%</div>";
                        } else {
                            html += "<div class='listaproductosDesc' style='text-align: right;'>Descuento: </div>";
                        }

                        html += "<div class='listaproductosVal'>";
                        html +=
                            "" +
                            moneda +
                            " " +
                            parseFloat(datos[i]["descuento"]).toFixed(2) +
                            "";
                        html += "</div></li><br/>";
                    }

                    if (datos[i]["descuento"] == 0) {
                        html =
                            "<li id='item1' style='background:white;'><div class='listaproductosCant'>";
                        if (datos[i]["totalizado"] != 0) {
                            html += "" + datos[i]["dtfac_cantidad"] + "";
                        } else {
                            html += "  &nbsp;&nbsp;";
                        }
                        html += "</div>";
                        html +=
                            "<div class='listaproductosDesc'>" +
                            datos[i]["plu_descripcion"] +
                            "</div>";
                        totalItem =
                            datos[i]["dtfac_precio_unitario"] * datos[i]["dtfac_cantidad"];
                        html += "<div class='listaproductosVal'>";
                        if (datos[i]["totalizado"] != 0) {
                            html +=
                                "" +
                                moneda +
                                " " +
                                parseFloat(datos[i]["totalizado"]).toFixed(2) +
                                "";
                        } else {
                            html += "";
                        }
                        html += "</div></li><br/>";
                    }

                    //                    cdn_tipoImpuesto = datos[i]['cdn_tipoimpuesto'];
                    //                    lc_cantidadPagada = (parseFloat(datos[i]['dtfac_total']));
                    //                    $("#btnBaseFactura").val(lc_cantidadPagada);
                    $("#listaFactura").append(html);
                }

            }
        }
    });
}

document.onkeydown = checkKeycode;

function checkKeycode(e) {
    var keycode;
    if (window.event) {
        keycode = window.event.keyCode;
    } else if (e) {
        keycode = e.which;
    }
    // Mozilla firefox
    if ($.browser.mozilla) {
        if (keycode === 116 || (e.ctrlKey && keycode === 82)) {
            if (e.preventDefault) {
                e.preventDefault();
                e.stopPropagation();
            }
        }

    // IE
    } else if ($.browser.msie) {
        if (keycode === 116 || (window.event.ctrlKey && keycode === 82)) {
            window.event.returnValue = false;
            window.event.keyCode = 0;
            window.status = "Refresh is disabled";
        }
    }
}

window.oncontextmenu = function () {
    return false;
};

//imprime pre cuenta
//imprime precuenta en el boton imprimi
function fn_imprimirPreCuenta(dop_cuenta) {
    var send;
    var odp_id = $("#txtOrdenPedidoId").val();
    var est_ipd = $("#txt_est_ip").val();
    var usr_id = $("#usr_perfil").val();
    var rst_id = $("#txtRestaurante").val();
    var dop_cuenta = dop_cuenta;

<<<<<<< HEAD
    send = { impresionPrecuenta: 1 };
=======
    send = {"impresionPrecuenta": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.odp_id = odp_id;
    send.est_ipd = est_ipd;
    send.usr_id = usr_id;
    send.rst_id = rst_id;
    send.dop_cuenta = dop_cuenta;
    send.opcionImpresion = 0;

    $.getJSON("../ordenpedido/config_ordenPedido.php", send, function (datos) {
        if (datos.str > 0) {
            if (datos[0]["Confirmar"] < 1) {
                alertify.alert("No existen detalle del pedido");
            }
        }

        alertify.success("Imprimiendo precuenta #" + dop_cuenta);

        fn_imprimirOrden();
    });

}


function hayPuntosEnPantalla() {
    var respuesta = "no";
    if ($("#listaFactura_canje_puntos").html() === null) {
        respuesta = "no";
    } else {
        respuesta = "si";
    }
    return respuesta;
}

//Consumo de recarga por cliente
var consumirRecargaEfectivo = function() {
    console.log('Entra en consumirRecargaEfectivo');
    procesoFidelizacion = "Recargas";
    var html = "";
    var totalFactura = parseFloat($("#pagoGranTotal").val());
    var faltaPorPagar = parseFloat($("#pagoTotal").val());
    var valor = parseFloat($("#pagado").val());
    //Si el valor a pagar es mayor al faltante por pagar
    if (faltaPorPagar == 0) {
        fn_envioFactura();
        return false;
    } else if (valor > faltaPorPagar) {
        valor = faltaPorPagar;
        $("#pagado").val(valor);
    }
    var send = {};
    send.metodo = "consumoRecargarEfectivoCliente";
    send.idFactura = $("#txtNumFactura").val();
    send.valor = valor;
    send.totalFactura = totalFactura;
    $.ajax({
        async: false,
        type: "POST",
        url: "../recargas/consultasRecargas.php",
        data: send,
        dataType: "json",
        success: function(datos) {
            if (datos.estado == 1) {
                $("#btnCancelarPago").attr("disabled", false);
                for (var i = 0; i < datos.str; i++) {
                    html +=
                        "<tr><td width='130px' align='right'>" +
                        datos[i]["descripcion"] +
                        "</td><td width='40px' align='center'>$</td><td width='100px' align='center'>" +
                        parseFloat(datos[i]["total"]).toFixed(2) +
                        "</td></tr>";
                }
                faltaPorPagar = parseFloat(faltaPorPagar - valor).toFixed(2);
                $("#pagado").val("");
                $("#pagoTotal").val(faltaPorPagar);
                $("#hid_cambio").val(0);
                $("#formasPago2").html(html);
                fn_cargando(0);
                if (!parseFloat(faltaPorPagar) > 0) {
                    fn_envioFactura();
                }
            } else {
                fn_cargando(0);
                if (datos.estado === 201) {
                    //Abrir modal para lectura de código
                    $("#inputCodigoSeguridad").val("");
                    $("#cntSeguridadCliente").show();
                    $("#inputCodigoSeguridad").focus();
                } else if (datos.estado === 203) {
                    //Abrir modal para lectura de código y mostrar mensaje
                    alertify.confirm(datos.mensaje, function(e) {
                        if (e) {
                            $("#inputCodigoSeguridad").val("");
                            $("#cntSeguridadCliente").show();
                            $("#inputCodigoSeguridad").focus();
                        }
                    });
                } else {
                    alertify.alert(datos.mensaje);
                }
            }
        },
        error: function() {
            $("#btnCancelarPago").attr("disabled", true);
            fn_cargando(0);
            alertify.alert("Servicio no disponible...");
        }
    });
};

//Cancelar pago con recarga
var cancelarPagoRecargaEfectivo = function() {
    fn_cargando(1);
    //Codigo de la Factura
    var idFactura = $("#txtNumFactura").val();
    var send = {};
    send.metodo = "reversoConsumoRecargarCliente";
    send.idFactura = $("#txtNumFactura").val();
    $.ajax({
        async: false,
        type: "POST",
        url: "../recargas/consultasRecargas.php",
        data: send,
        dataType: "json",
        success: function(datos) {
            procesoFidelizacion = "";
            //Obtiene el total a pagar de la factura
            fn_obtieneTotalApagar();
            total = $("#pagoTotal").val();
            $("#pagado").val("");
            //Resumen de formas de pago aplicadas a la factura
            fn_resumenFormaPago();
            //Otros
            $("#td_cambio").hide();
            $("#td_falta").show();
            alertify.alert("Reverso de consumo exitoso.");
            fn_cargando(0);
        },
        error: function() {
            fn_cargando(0);
        }
    });
};

/* DLL: Plug Them - Encuesta */

/* Aplica Plug Them */
function aplicaPlugThem() {
    var send;
<<<<<<< HEAD
    var aplicaPlugThem = { aplicaPlugThem: 1 };
=======
    var aplicaPlugThem = {"aplicaPlugThem": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    var resultadoObject = new Array();

    send = aplicaPlugThem;
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_plugThem.php",
        data: send,
        success: function (datos) {
            if (datos.str > 0) {
                resultadoObject["aplicaCadena"] = datos[0]["aplicaCadena"];
                resultadoObject["aplicaRestaurante"] = datos[0]["aplicaRestaurante"];
            }
        }
    });

    return resultadoObject;
}

/* Login Plug Them */
function validaLoginPlugThem() {
    var resultadoObject = new aplicaPlugThem();

    if (Object.values(resultadoObject).length > 0) {
        var aplicaCadena = resultadoObject["aplicaCadena"];
        var aplicaRestaurante = resultadoObject["aplicaRestaurante"];
        //alert('aplicaCadena: ' + aplicaCadena + ', aplicaRestaurante: ' + aplicaRestaurante);
        if (aplicaCadena === 1 && aplicaRestaurante === 1) {
            tokenLogin();
        } else {
            fn_actualizarFactura();

            // fidelizacion: si es si el plan de datos  no imprimir aun (el campo fdznDocumento contendra una cedula cuando se trate de fdzn activa)
            if (
                $("#fdznDocumento").val() === "0" ||
                $("#fdznDocumento").val() === "" ||
                $("#fdznDocumento").val() === undefined
            ) {
                fn_validaItemPagado();
            } else {
                fn_obtenerMesa();
            }
        }
    } else {
        fn_actualizarFactura();

        // fidelizacion: si es si el plan de datos  no imprimir aun (el campo fdznDocumento contendra una cedula cuando se trate de fdzn activa)
        if (
            $("#fdznDocumento").val() === "0" ||
            $("#fdznDocumento").val() === "" ||
            $("#fdznDocumento").val() === undefined
        ) {
            fn_validaItemPagado();
        } else {
            fn_obtenerMesa();
        }
    }
}

function tokenLogin() {
    var send;
<<<<<<< HEAD
    var tokenLogin = { tokenLogin: 1 };
=======
    var tokenLogin = {"tokenLogin": 1};
>>>>>>> origin/MXP_Version_1.9.10.6

    send = tokenLogin;
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_plugThem.php",
        data: send,
        success: function (datos) {
            if (datos[0]["token_type"] !== "0" && datos[0]["access_token"] !== "0") {
                valorConfiguracionPlugThem(datos[0]["token_type"], datos[0]["access_token"]);
            } else {
                fn_actualizarFactura();

                // fidelizacion: si es si el plan de datos  no imprimir aun (el campo fdznDocumento contendra una cedula cuando se trate de fdzn activa)
                if (
                    $("#fdznDocumento").val() === "0" ||
                    $("#fdznDocumento").val() === "" ||
                    $("#fdznDocumento").val() === undefined
                ) {
                    fn_validaItemPagado();
                } else {
                    fn_obtenerMesa();
                }
            }
        }
    });
}

/* Fin Login Plug Them */

/* Aplicar encuesta según la configuración */
function valorConfiguracionPlugThem(token_type, access_token) {
    var send;
<<<<<<< HEAD
    var valorConfiguracionPlugThem = { valorConfiguracionPlugThem: 1 };
=======
    var valorConfiguracionPlugThem = {"valorConfiguracionPlugThem": 1};
>>>>>>> origin/MXP_Version_1.9.10.6

    send = valorConfiguracionPlugThem;
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_plugThem.php",
        data: send,
        success: function (datos) {
            var valorFactura = $("#pagoGranTotal").val();
            var valorPlugThem = datos[0]["valor"];
            var aplica = datos[0]["aplica"];
            var contadorFacturas = datos[0]["contador"];

            // Valor total de factura
            if (aplica === 1) {
                if (parseFloat(valorFactura) > parseFloat(valorPlugThem)) {
                    plugThemPost(token_type, access_token, "");
                } else {
                    //plugThemGet();
                    plugThemPost(token_type, access_token, "1");
                }
            }
            // Número de facturas
            else if (aplica === 2) {
                if (parseInt(contadorFacturas) !== 0 && parseInt(valorPlugThem) !== 0) {
                    if (parseInt(contadorFacturas) === parseInt(valorPlugThem)) {
                        plugThemPost(token_type, access_token, "");
                    } else {
                        //plugThemGet(); 
                        plugThemPost(token_type, access_token, "1");
                    }
                } else {
                    fn_actualizarFactura();

                    // fidelizacion: si es si el plan de datos  no imprimir aun (el campo fdznDocumento contendra una cedula cuando se trate de fdzn activa)
                    if (
                        $("#fdznDocumento").val() === "0" ||
                        $("#fdznDocumento").val() === "" ||
                        $("#fdznDocumento").val() === undefined
                    ) {
                        fn_validaItemPagado();
                    } else {
                        fn_obtenerMesa();
                    }
                }
            } else {
                fn_actualizarFactura();

                // fidelizacion: si es si el plan de datos  no imprimir aun (el campo fdznDocumento contendra una cedula cuando se trate de fdzn activa)
                if (
                    $("#fdznDocumento").val() === "0" ||
                    $("#fdznDocumento").val() === "" ||
                    $("#fdznDocumento").val() === undefined
                ) {
                    fn_validaItemPagado();
                } else {
                    fn_obtenerMesa();
                }
            }
        }
    });
}

/* Se obtiene los datos del cajero/a y administrador/a para aplicar la encuesta */
function datosPlugThemPost() {
    var send;
<<<<<<< HEAD
    var datosPlugThemPost = { datosPlugThemPost: 1 };
=======
    var datosPlugThemPost = {"datosPlugThemPost": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    var transaccion = $("#txtNumFactura").val();
    var objectResultado = new Array();

    send = datosPlugThemPost;
    send.transaccion = transaccion;
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "config_plugThem.php",
        data: send,
        success: function (datos) {
            if (datos.str > 0) {
                objectResultado["BrandId"] = datos[0]["BrandId"];
                objectResultado["idCajero"] = datos[0]["idCajero"];
                objectResultado["EmpId"] = datos[0]["EmpId"];
                objectResultado["EmpName"] = datos[0]["EmpName"];
                objectResultado["SiteId"] = datos[0]["SiteId"];
                objectResultado["SiteName"] = datos[0]["SiteName"];
                objectResultado["ShiftManagerId"] = datos[0]["ShiftManagerId"];
                objectResultado["ShiftManagerName"] = datos[0]["ShiftManagerName"];
            }
        }
    });

    return objectResultado;
}

/* 
 * Plug Them POS : 
 * Al finalizar la transacción, se envia un SMS al celular del cliente
 * con el link de la página de encuesta. 
 */
function plugThemPost(token_type, acces_token, habilitarQR) {
    var send;
    var resultadoObject = new datosPlugThemPost();

    if (Object.values(resultadoObject).length > 0) {

        var BrandId = resultadoObject["BrandId"];
        var idCajero = resultadoObject["idCajero"];
        var EmpId = resultadoObject["EmpId"];
        var EmpName = resultadoObject["EmpName"];
        var SiteId = resultadoObject["SiteId"];
        var SiteName = resultadoObject["SiteName"];
        var ShiftManagerId = resultadoObject["ShiftManagerId"];
        var ShiftManagerName = resultadoObject["ShiftManagerName"];
        var Categories = "";
        var CustomerDoc = $("#txtClienteCI").val();
        var CustomerName = $("#txtClienteNombre").val();
        var CustomerEmail = $("#txtCorreo").val();
        var CustomerMobile = $("#txtClienteFono").val();
        var EffortValue = "1";
        var EffortReason = "";
        var EffortComment = "";
        var InvRange = "";
        var qr_enable = habilitarQR;
        var transaccion = $("#txtNumFactura").val();

        var token_type = token_type;
        var acces_token = acces_token;

        send = {};
        send.metodo = "plugThemPost";
        send.BrandId = BrandId;
        send.idCajero = idCajero;
        send.EmpId = EmpId;
        send.EmpName = EmpName;
        send.SiteId = SiteId;
        send.SiteName = SiteName;
        send.ShiftManagerId = ShiftManagerId;
        send.ShiftManagerName = ShiftManagerName;
        send.Categories = Categories;
        send.CustomerDoc = CustomerDoc;
        send.CustomerName = CustomerName;
        send.CustomerEmail = CustomerEmail;
        send.CustomerMobile = CustomerMobile;
        send.EffortValue = EffortValue;
        send.EffortReason = EffortReason;
        send.EffortComment = EffortComment;
        send.InvRange = InvRange;
        send.qr_enable = qr_enable;
        send.transaccion = transaccion;
        send.token_type = token_type;
        send.acces_token = acces_token;
        $.ajax({
            async: false,
            type: "POST",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            url: "../facturacion/clienteWS_plugThemCliente.php",
            data: send,
            success: function (datos) {
                fn_actualizarFactura();

                // fidelizacion: si es si el plan de datos  no imprimir aun (el campo fdznDocumento contendra una cedula cuando se trate de fdzn activa)
                if (
                    $("#fdznDocumento").val() === "0" ||
                    $("#fdznDocumento").val() === "" ||
                    $("#fdznDocumento").val() === undefined
                ) {
                    fn_validaItemPagado();
                } else {
                    fn_obtenerMesa();
                }
            }
        });
    } else {
        fn_actualizarFactura();

        // fidelizacion: si es si el plan de datos  no imprimir aun (el campo fdznDocumento contendra una cedula cuando se trate de fdzn activa)
        if (
            $("#fdznDocumento").val() === "0" ||
            $("#fdznDocumento").val() === "" ||
            $("#fdznDocumento").val() === undefined
        ) {
            fn_validaItemPagado();
        } else {
            fn_obtenerMesa();
        }
    }
}

/* 
 * Plug Them GET : QR : 
 * Al finalizar la transacción, se genera un código QR y que es visible en la factura
 * el mimmo que al ser leido se dirigirá a la pagina de encuesta. 
 */
function plugThemGet() {
    var send;
    var resultadoObject = new datosPlugThemPost();

    if (Object.values(resultadoObject).length > 0) {

        var BrandId = resultadoObject["BrandId"];
        var idCajero = resultadoObject["idCajero"];
        var EmpId = resultadoObject["EmpId"];
        var EmpName = resultadoObject["EmpName"];
        var SiteId = resultadoObject["SiteId"];
        var SiteName = resultadoObject["SiteName"];
        var ShiftManagerId = resultadoObject["ShiftManagerId"];
        var ShiftManagerName = resultadoObject["ShiftManagerName"];
        var Categories = "";
        var CustomerDoc = $("#txtClienteCI").val();
        var CustomerName = $("#txtClienteNombre").val();
        var CustomerEmail = $("#txtCorreo").val();
        var CustomerMobile = $("#txtClienteFono").val();
        var EffortValue = "1";
        var EffortReason = "";
        var EffortComment = "";
        var InvRange = "";
        var transaccion = $("#txtNumFactura").val();

        send = {};
        send.metodo = "plugThemGet";
        send.BrandId = BrandId;
        send.EmpId = EmpId;
        send.EmpName = EmpName;
        send.SiteId = SiteId;
        send.SiteName = SiteName;
        send.ShiftManagerId = ShiftManagerId;
        send.ShiftManagerName = ShiftManagerName;
        send.Categories = Categories;
        send.CustomerDoc = CustomerDoc;
        send.CustomerName = CustomerName;
        send.CustomerEmail = CustomerEmail;
        send.CustomerMobile = CustomerMobile;
        send.EffortValue = EffortValue;
        send.EffortReason = EffortReason;
        send.EffortComment = EffortComment;
        send.InvRange = InvRange;
        send.transaccion = transaccion;
        $.ajax({
            async: false,
            type: "POST",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            url: "../facturacion/clienteWS_plugThemCliente.php",
            data: send,
            success: function (datos) {
                fn_actualizarFactura();

                // fidelizacion: si es si el plan de datos  no imprimir aun (el campo fdznDocumento contendra una cedula cuando se trate de fdzn activa)
                if (
                    $("#fdznDocumento").val() === "0" ||
                    $("#fdznDocumento").val() === "" ||
                    $("#fdznDocumento").val() === undefined
                ) {
                    fn_validaItemPagado();
                } else {
                    fn_obtenerMesa();
                }
            }
        });
    } else {
        fn_actualizarFactura();

        // fidelizacion: si es si el plan de datos  no imprimir aun (el campo fdznDocumento contendra una cedula cuando se trate de fdzn activa)
        if (
            $("#fdznDocumento").val() === "0" ||
            $("#fdznDocumento").val() === "" ||
            $("#fdznDocumento").val() === undefined
        ) {
            fn_validaItemPagado();
        } else {
            fn_obtenerMesa();
        }
    }
}

function fn_cerrarModalCodigoFacturacion(id) {
    $("#txtcodigoFacturacion").val("");
    $("#numPad").hide();
    $("#tecladoCodigoFacturacion").dialog("close");
    $("#keyboard").hide();
    $("#pagado").val("");

}

function fn_guardarCodigoFactura(e) {
    valorCampoCodigo = $("#txtcodigoFacturacion").val();
    if (valorCampoCodigo == "") {
        alertify.error("Por favor Ingresar el Codigo ");
    } else {
        $("#txtcodigoFacturacion").val("");
        //banderaUber = 1;
        BANDERA_AGREGADOR = 1;
        $("#numPad").show();
        $("#tecladoCodigoFacturacion").dialog("close");
        $("#keyboard").hide();
        fn_cargaTeclasEmail();
        fn_numerico(txtClienteCI);
        //  fn_clienteExternoSinCupon();
        // fn_clienteConsumirFinal();
        $("#datosFactura").dialog({
            title: "INFORMACION FISCAL S.R.I.",
            modal: true,
            position: "center",
            closeOnEscape: false,
            width: 1000,
            height: 810,
            show: "blind",
            resizable: "false"
        });
    }
}

function fn_clienteConsumirFinal() {
<<<<<<< HEAD
    var docConsumidor = "9999999999999";
    var send = { ConsumidorFinalDatos: 1 };
=======
    var docConsumidor = '9999999999999';
    var send = {"ConsumidorFinalDatos": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.docConsumidor = docConsumidor;
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "../facturacion/config_clientes.php",
        data: send,
        success: function (datos) {
            var datosR = datos.lc_regs;
            if (datosR.str > 0) {
                fn_selecionaClienteAx(datosR.descripcion, datosR.IDCliente, datosR.documento, datosR.telefono, datosR.direccion, datosR.email, datosR.tipoCliente);
            }
        },
        error: function (jqXHR, textStatus, errorThrown) {
            alert(jqXHR + textStatus + errorThrown);

        }
    });
}

function validarVentaKiosko() {
    cargarDatosClienteKiosko();
    setTimeout(function () {
        cerrar();
    }, 100);
    setTimeout(function () {
        continuar();
    }, 100);
}

function cargarDatosClienteKiosko() {
    fn_limpiarCamposCliente();
<<<<<<< HEAD
    var send = { cargaDatosClienteKiosko: 1 };
=======
    var send = {"cargaDatosClienteKiosko": 1};
>>>>>>> origin/MXP_Version_1.9.10.6
    send.cfac_id = $("#txtNumFactura").val();
    $.ajax({
        async: false,
        type: "POST",
        dataType: "json",
        contentType: "application/x-www-form-urlencoded",
        url: "../facturacion/config_clientes.php",
        data: send,
        success: function (datos) {
            if (datos !== null && datos.documento !== null && (datos.documento.length === 10 || datos.documento.length === 13)) {
                // Desactivar momentáneamente evento onChange para evitar que se dispare función fn_clienteBuscar() y se sobreescriba la información
                onChangeTxtClienteCI(false);
<<<<<<< HEAD
                setTimeout(function() {
                    fn_cargaDatosCliente(
                        1,
                        "",
                        datos.documento,
                        datos.nombres,
                        datos.direccion,
                        datos.telefono,
                        datos.email,
                        "",
                        ""
                    );
=======
                setTimeout(function () {
                    fn_cargaDatosCliente(1, '', datos.documento, datos.nombres, datos.direccion, datos.telefono, datos.email, '', '');
>>>>>>> origin/MXP_Version_1.9.10.6
                    onChangeTxtClienteCI(true);
                }, 20);
            }
        }
    });
}

function onChangeTxtClienteCI(activar) {
    if (activar) {
        $("#txtClienteCI").change(fn_clienteBuscar);
    } else {
        $("#txtClienteCI").unbind("change");
    }
}

    function fn_PagoCreditoConfigurados(descripcion, id, documentoAx, telefonoAx, direccionAx, correoAx, tipoIdentificacionAx) {
        $("#mdl_rdn_pdd_crgnd").show();
        lc_opcionCreditoEmpresa = "EXTERNO";
        $("#pagado").val($("#pagoTotal").val());
        fn_selecionaClienteAx(descripcion, id, documentoAx, telefonoAx, direccionAx, correoAx, tipoIdentificacionAx);
    }